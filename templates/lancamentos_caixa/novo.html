{% extends 'base.html' %}
{% block title %}{% if edit_mode %}Editar{% else %}Novo{% endif %} Lan√ßamento de Caixa - NH Transportes{% endblock %}
{% block content %}
<div class="container-fluid">
    <nav aria-label="breadcrumb" class="mt-2 mb-3">
        <ol class="breadcrumb" style="font-size: 0.85rem;">
            <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('lancamentos_caixa.lista') }}">Lan√ßamentos de Caixa</a></li>
            <li class="breadcrumb-item active" aria-current="page">{% if edit_mode %}Editar{% else %}Novo{% endif %} Lan√ßamento</li>
        </ol>
    </nav>
    
    <h2 class="mb-3" style="color:#1D63A5; font-size: 1.3rem;"><i class="bi bi-cash-stack"></i> {% if edit_mode %}Editar{% else %}Novo{% endif %} Fechamento de Caixa</h2>
    
    <form id="formCaixa" method="POST">
        <!-- Main info -->
        <div class="card shadow-sm mb-3">
            <div class="card-header" style="background:#ff9800;color:white; font-size: 0.95rem; padding: 0.6rem 1rem;">
                <h5 class="mb-0" style="font-size: 1rem;">Informa√ß√µes Gerais</h5>
            </div>
            <div class="card-body" style="padding: 1rem;">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label" style="font-size: 0.85rem;">Cliente *</label>
                        <select name="cliente_id" id="cliente_id" class="form-select form-select-sm" required onchange="loadVendasDia()">
                            <option value="">Selecione o cliente...</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}" {% if edit_mode and lancamento and lancamento.cliente_id == cliente.id %}selected{% endif %}>{{ cliente.razao_social }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label" style="font-size: 0.85rem;">Data *</label>
                        <input type="date" name="data" id="data" class="form-control form-control-sm" required 
                               value="{% if edit_mode and lancamento %}{{ lancamento.data }}{% elif data %}{{ data }}{% endif %}" onchange="loadVendasDia()">
                    </div>
                    <div class="col-md-5 mb-3">
                        <label class="form-label" style="font-size: 0.85rem;">Observa√ß√£o</label>
                        <input type="text" name="observacao" class="form-control form-control-sm" 
                               value="{% if edit_mode and lancamento and lancamento.observacao %}{{ lancamento.observacao }}{% endif %}"
                               placeholder="Observa√ß√µes sobre o fechamento do caixa">
                    </div>
                </div>
            </div>
        </div>

        <!-- Split layout -->
        <div class="row">
            <!-- LEFT SIDE: Receitas e Entradas -->
            <div class="col-lg-6 mb-3">
                <div class="card shadow-sm h-100">
                    <div class="card-header" style="background:#28a745;color:white; font-size: 0.95rem; padding: 0.6rem 1rem;">
                        <h5 class="mb-0" style="font-size: 1rem;"><i class="bi bi-arrow-down-circle"></i> Receitas e Entradas</h5>
                    </div>
                    <div class="card-body" style="padding: 1rem;">
                        <div id="receitas-container">
                            <!-- Fixed receipt types will be added here dynamically on page load -->
                        </div>
                        
                        <!-- Bot√£o Sobras de Caixa -->
                        <div class="mt-3 mb-2">
                            <button type="button" class="btn btn-success btn-sm w-100" onclick="abrirModalFuncionarios('sobras')">
                                <i class="bi bi-plus-circle"></i> Sobras de Caixa
                            </button>
                            <div id="sobras-resumo" class="mt-2" style="display:none;">
                                <small class="text-muted">
                                    <strong>Total Sobras:</strong> <span id="total-sobras">R$ 0,00</span>
                                </small>
                            </div>
                        </div>
                        
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>Total Receitas:</strong>
                            <strong id="total-receitas" class="text-success">R$ 0,00</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT SIDE: Comprova√ß√µes -->
            <div class="col-lg-6 mb-3">
                <div class="card shadow-sm h-100">
                    <div class="card-header" style="background:#007bff;color:white; font-size: 0.95rem; padding: 0.6rem 1rem;">
                        <h5 class="mb-0" style="font-size: 1rem;"><i class="bi bi-check-circle"></i> Comprova√ß√£o para Fechamento</h5>
                    </div>
                    <div class="card-body" style="padding: 1rem; max-height: 70vh; overflow-y: auto;">
                        <div id="comprovacoes-container">
                            <!-- Fixed payment types will be added here dynamically on page load -->
                        </div>
                        
                        <!-- Bot√µes Perdas e Vales -->
                        <div class="mt-3 mb-2">
                            <button type="button" class="btn btn-warning btn-sm w-100 mb-2" onclick="abrirModalFuncionarios('perdas')">
                                <i class="bi bi-dash-circle"></i> Perdas de Caixas
                            </button>
                            <div id="perdas-resumo" class="mb-2" style="display:none;">
                                <small class="text-muted">
                                    <strong>Total Perdas:</strong> <span id="total-perdas">R$ 0,00</span>
                                </small>
                            </div>
                            
                            <button type="button" class="btn btn-danger btn-sm w-100" onclick="abrirModalFuncionarios('vales')">
                                <i class="bi bi-receipt"></i> Vales de Quebras de Caixas
                            </button>
                            <div id="vales-resumo" class="mt-2" style="display:none;">
                                <small class="text-muted">
                                    <strong>Total Vales:</strong> <span id="total-vales">R$ 0,00</span>
                                </small>
                            </div>
                        </div>
                        
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>Total Comprova√ß√£o:</strong>
                            <strong id="total-comprovacao" class="text-primary">R$ 0,00</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Diferen√ßa -->
        <div class="card shadow-sm mb-3">
            <div class="card-body" style="padding: 1rem;">
                <div class="row">
                    <div class="col-md-4">
                        <div class="d-flex justify-content-between">
                            <strong>Total Receitas:</strong>
                            <strong id="total-receitas-resumo" class="text-success">R$ 0,00</strong>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex justify-content-between">
                            <strong>Total Comprova√ß√£o:</strong>
                            <strong id="total-comprovacao-resumo" class="text-primary">R$ 0,00</strong>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex justify-content-between">
                            <strong>Diferen√ßa:</strong>
                            <strong id="diferenca" class="text-dark">R$ 0,00</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden inputs for JSON data -->
        <input type="hidden" name="receitas" id="receitas-json">
        <input type="hidden" name="comprovacoes" id="comprovacoes-json">
        <input type="hidden" name="sobras_funcionarios" id="sobras-json">
        <input type="hidden" name="perdas_funcionarios" id="perdas-json">
        <input type="hidden" name="vales_funcionarios" id="vales-json">

        <!-- Actions -->
        <div class="d-flex justify-content-between mb-3">
            <a href="{{ url_for('lancamentos_caixa.lista') }}" class="btn btn-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
            <button type="submit" class="btn btn-success btn-sm">
                <i class="bi bi-check-circle"></i> Salvar Lan√ßamento
            </button>
        </div>
    </form>
</div>

<!-- Modal para Sobras/Perdas/Vales por Funcion√°rio -->
<div class="modal fade" id="modalFuncionarios" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title">Lan√ßamento por Funcion√°rio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="funcionarios-lista" class="mb-3">
                    <p class="text-muted">Selecione um cliente e data primeiro...</p>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm" id="tabela-funcionarios" style="display:none;">
                        <thead>
                            <tr>
                                <th>Funcion√°rio</th>
                                <th style="width: 150px;">Valor (R$)</th>
                                <th style="width: 200px;">Observa√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="funcionarios-tbody">
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <strong>Total: <span id="modal-total">R$ 0,00</span></strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarDadosFuncionarios()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<style>
    .receita-item {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.4rem 0.6rem;
        margin-bottom: 0.4rem;
        background-color: #f8f9fa;
    }
    
    .comprovacao-item {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        background-color: #f8f9fa;
    }
    
    .form-label {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .form-control-sm, .form-select-sm {
        font-size: 0.85rem;
        padding: 0.4rem 0.6rem;
    }
    
    @media (max-width: 768px) {
        h2 {
            font-size: 1.1rem !important;
        }
    }
</style>

<script>
let receitaIndex = 0;
let comprovacaoIndex = 0;

// Dados de sobras/perdas/vales por funcion√°rio
let dadosSobras = [];
let dadosPerdas = [];
let dadosVales = [];
let tipoModalAtual = ''; // 'sobras', 'perdas', ou 'vales'
let funcionariosCache = [];

// Carregar funcion√°rios do cliente

// Use pre-serialized JSON strings to avoid Jinja2 serialization issues
const tiposReceita = {{ tipos_receita_json|safe }};
const formasPagamento = {{ formas_pagamento_json|safe }};
const cartoes = {{ cartoes_json|safe }};

// Definir ordem preferida para tipos conhecidos (tipos AUTO primeiro, depois tipos MANUAL espec√≠ficos)
const preferredOrder = ['VENDAS POSTO', 'ARLA', 'LUBRIFICANTES', 'TROCO PIX (AUTO)', 'RECEBIMENTOS', 'ACR√âSCIMOS GERAIS', 'ACR√âSCIMOS CADASTROS', 'TROCO PIX (MANUAL)', 'EMPRESTIMOS', 'OUTROS'];

// Ordenar tipos de receita: tipos preferidos em ordem, depois outros alfabeticamente
const sortedTiposReceita = [...tiposReceita].sort((a, b) => {
    const aIndex = preferredOrder.indexOf(a.nome);
    const bIndex = preferredOrder.indexOf(b.nome);
    
    // Ambos est√£o na lista preferida
    if (aIndex !== -1 && bIndex !== -1) {
        return aIndex - bIndex;
    }
    // Apenas a est√° na lista preferida
    if (aIndex !== -1) {
        return -1;
    }
    // Apenas b est√° na lista preferida
    if (bIndex !== -1) {
        return 1;
    }
    // Nenhum est√° na lista preferida - ordenar alfabeticamente
    return a.nome.localeCompare(b.nome);
});

// Criar um mapa de tipos de receita por nome para busca r√°pida
const tiposMap = {};
for (const tipo of tiposReceita) {
    tiposMap[tipo.nome] = tipo;
}

// Criar um mapa de formas_pagamento por tipo para busca r√°pida
const formasPagamentoMap = {};
for (const forma of formasPagamento) {
    formasPagamentoMap[forma.tipo] = forma;
}

// Fun√ß√£o auxiliar para obter forma_pagamento_id a partir de string tipo
function getFormaPagamentoIdByTipo(tipo) {
    const forma = formasPagamentoMap[tipo];
    return forma ? forma.id : null;
}

function formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
}

function parseCurrency(value) {
    if (!value) return 0;
    // Remove R$ symbol and trim
    let cleanValue = value.toString().replace(/R\$/g, '').trim();
    
    // Check if Brazilian format (has comma as decimal separator)
    if (cleanValue.includes(',')) {
        // Remove thousand separators (dots)
        cleanValue = cleanValue.replace(/\./g, '');
        // Replace comma with dot for decimal
        cleanValue = cleanValue.replace(',', '.');
    }
    
    return parseFloat(cleanValue) || 0;
}

function formatNumberInput(input) {
    // Get only numbers from input
    let value = input.value.replace(/\D/g, '');
    
    if (value === '') {
        input.value = '';
        return;
    }
    
    // Convert to number and divide by 100 to get decimal places
    let numValue = parseInt(value, 10) / 100;
    
    // Format as Brazilian currency (without R$ symbol)
    input.value = numValue.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function initializeReceitas() {
    const container = document.getElementById('receitas-container');
    container.innerHTML = ''; // Limpar qualquer conte√∫do existente
    
    // Adicionar todos os tipos de receita do banco de dados (ordenados com ordem preferida)
    for (const tipoInfo of sortedTiposReceita) {
        const nomeTipo = tipoInfo.nome;
        const isAuto = tipoInfo.tipo === 'AUTO';
        const item = document.createElement('div');
        item.className = 'receita-item';
        item.id = `receita-${receitaIndex}`;
        item.dataset.tipoNome = nomeTipo;
        
        if (isAuto) {
            // Tipo AUTO - ser√° preenchido por loadVendasDia
            // Adicionar bot√£o de navega√ß√£o para tipos espec√≠ficos
            let navButton = '';
            if (nomeTipo === 'VENDAS POSTO') {
                navButton = '<a href="/posto/vendas" class="btn btn-sm btn-outline-primary" style="padding: 0.15rem 0.4rem; font-size: 0.75rem;" title="Ir para Vendas Posto"><i class="bi bi-box-arrow-up-right"></i></a>';
            } else if (nomeTipo === 'ARLA') {
                navButton = '<a href="/arla/" class="btn btn-sm btn-outline-primary" style="padding: 0.15rem 0.4rem; font-size: 0.75rem;" title="Ir para ARLA"><i class="bi bi-box-arrow-up-right"></i></a>';
            } else if (nomeTipo === 'LUBRIFICANTES') {
                navButton = '<a href="/lubrificantes/" class="btn btn-sm btn-outline-primary" style="padding: 0.15rem 0.4rem; font-size: 0.75rem;" title="Ir para Lubrificantes"><i class="bi bi-box-arrow-up-right"></i></a>';
            } else if (nomeTipo === 'TROCO PIX (AUTO)' || nomeTipo === 'TROCO PIX') {
                navButton = '<a href="/troco_pix/" class="btn btn-sm btn-outline-primary" style="padding: 0.15rem 0.4rem; font-size: 0.75rem;" title="Ir para Troco PIX"><i class="bi bi-box-arrow-up-right"></i></a>';
            }
            
            item.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <label class="form-label mb-0" style="font-size: 0.75rem; font-weight: 600;">${nomeTipo}</label>
                        <input type="hidden" class="receita-tipo" data-index="${receitaIndex}" value="${nomeTipo}">
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control form-control-sm receita-valor" data-index="${receitaIndex}" 
                               data-receita-tipo="${nomeTipo}" value="R$ 0,00" readonly style="background-color: #e9ecef;">
                    </div>
                    <div class="col-md-2 text-center">
                        ${navButton}
                    </div>
                    <div class="col-md-2 text-end">
                        <span class="badge bg-info">Auto</span>
                    </div>
                </div>
            `;
        } else {
            // Tipo MANUAL - usu√°rio pode preencher
            item.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <label class="form-label mb-0" style="font-size: 0.75rem; font-weight: 600;">${nomeTipo}</label>
                        <input type="hidden" class="receita-tipo" data-index="${receitaIndex}" value="${nomeTipo}">
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm receita-valor" data-index="${receitaIndex}" 
                               data-receita-tipo="${nomeTipo}" placeholder="0,00" oninput="formatNumberInput(this)" onchange="calcularTotais()">
                    </div>
                    <div class="col-md-5">
                        <input type="text" class="form-control form-control-sm receita-descricao" data-index="${receitaIndex}" 
                               data-receita-tipo="${nomeTipo}" placeholder="Descri√ß√£o (opcional)">
                    </div>
                </div>
            `;
        }
        
        container.appendChild(item);
        receitaIndex++;
    }
}

function loadVendasDia() {
    const clienteId = document.getElementById('cliente_id').value;
    const data = document.getElementById('data').value;
    
    if (!clienteId || !data) {
        return;
    }
    
    // Remover entradas AUTO de cheques existentes antes de carregar novas
    document.querySelectorAll('.comprovacao-item-auto').forEach(item => {
        item.remove();
    });
    
    // Mostrar indicador de carregamento
    const container = document.getElementById('receitas-container');
    const loadingMsg = document.createElement('div');
    loadingMsg.id = 'loading-vendas';
    loadingMsg.className = 'alert alert-info';
    loadingMsg.innerHTML = '<i class="bi bi-hourglass-split"></i> Carregando vendas do dia...';
    container.insertBefore(loadingMsg, container.firstChild);
    
    // Buscar dados de vendas
    fetch(`{{ url_for('lancamentos_caixa.get_vendas_dia') }}?cliente_id=${clienteId}&data=${data}`)
        .then(response => response.json())
        .then(data => {
            // Remover indicador de carregamento
            const loading = document.getElementById('loading-vendas');
            if (loading) loading.remove();
            
            console.log('Dados recebidos do get_vendas_dia:', data);
            console.log('Valor espec√≠fico de troco_pix:', data.troco_pix);
            console.log('Cheques AUTO:', data.cheques_auto);
            
            // Atualizar campos AUTO com valores (sempre define, mesmo se 0)
            document.querySelectorAll('.receita-item').forEach(item => {
                const tipoNome = item.dataset.tipoNome;
                const valorInput = item.querySelector('.receita-valor');
                
                console.log(`Verificando receita: tipoNome="${tipoNome}", readonly=${valorInput.readOnly}`);
                
                // Atualizar apenas campos do tipo AUTO (aqueles que s√£o readonly)
                if (!valorInput.readOnly) return;
                
                if (tipoNome === 'VENDAS POSTO') {
                    valorInput.value = formatCurrency(data.vendas_posto || 0);
                } else if (tipoNome === 'ARLA') {
                    valorInput.value = formatCurrency(data.arla || 0);
                } else if (tipoNome === 'LUBRIFICANTES') {
                    valorInput.value = formatCurrency(data.lubrificantes || 0);
                } else if (tipoNome === 'TROCO PIX (AUTO)' || tipoNome === 'TROCO PIX') {
                    console.log(`Atualizando TROCO PIX: tipoNome="${tipoNome}", valor=${data.troco_pix || 0}`);
                    const valorFormatado = formatCurrency(data.troco_pix || 0);
                    console.log(`Valor formatado: ${valorFormatado}`);
                    valorInput.value = valorFormatado;
                    console.log(`Valor atribu√≠do ao input: ${valorInput.value}`);
                }
            });
            
            // Adicionar CHEQUES AUTO √†s comprova√ß√µes
            if (data.cheques_auto && data.cheques_auto.length > 0) {
                data.cheques_auto.forEach(cheque => {
                    const tipo = cheque.tipo === 'A_VISTA' ? 'DEPOSITO_CHEQUE_VISTA' : 'DEPOSITO_CHEQUE_PRAZO';
                    addDepositoEntryAuto(tipo, cheque.valor, cheque.descricao);
                });
            }
            
            calcularTotais();
        })
        .catch(error => {
            const loading = document.getElementById('loading-vendas');
            if (loading) loading.remove();
            console.error('Erro ao carregar vendas:', error);
        });
}

// ===== FUN√á√ïES PARA SOBRAS/PERDAS/VALES =====

// Carregar funcion√°rios do cliente
async function carregarFuncionarios(clienteId) {
    if (!clienteId) return [];
    
    try {
        const response = await fetch(`{{ url_for('lancamentos_caixa.get_funcionarios_por_cliente', cliente_id=0) }}`.replace('/0', `/${clienteId}`));
        const funcionarios = await response.json();
        funcionariosCache = funcionarios;
        return funcionarios;
    } catch (error) {
        console.error('Erro ao carregar funcion√°rios:', error);
        return [];
    }
}

// Abrir modal para lan√ßamento por funcion√°rio
async function abrirModalFuncionarios(tipo) {
    const clienteId = document.getElementById('cliente_id').value;
    
    if (!clienteId) {
        alert('Selecione um cliente primeiro!');
        return;
    }
    
    tipoModalAtual = tipo;
    
    // Definir t√≠tulo do modal
    let titulo = '';
    if (tipo === 'sobras') {
        titulo = 'Sobras de Caixa por Funcion√°rio';
    } else if (tipo === 'perdas') {
        titulo = 'Perdas de Caixas por Funcion√°rio';
    } else if (tipo === 'vales') {
        titulo = 'Vales de Quebras de Caixas por Funcion√°rio';
    }
    document.getElementById('modal-title').textContent = titulo;
    
    // Carregar funcion√°rios
    const funcionarios = await carregarFuncionarios(clienteId);
    
    if (funcionarios.length === 0) {
        document.getElementById('funcionarios-lista').innerHTML = 
            '<div class="alert alert-warning">Nenhum funcion√°rio encontrado para este cliente.</div>';
        document.getElementById('tabela-funcionarios').style.display = 'none';
    } else {
        document.getElementById('funcionarios-lista').innerHTML = '';
        document.getElementById('tabela-funcionarios').style.display = 'table';
        
        // Preencher tabela
        const tbody = document.getElementById('funcionarios-tbody');
        tbody.innerHTML = '';
        
        // Obter dados existentes
        let dadosExistentes = [];
        if (tipo === 'sobras') dadosExistentes = dadosSobras;
        else if (tipo === 'perdas') dadosExistentes = dadosPerdas;
        else if (tipo === 'vales') dadosExistentes = dadosVales;
        
        funcionarios.forEach(func => {
            const dadoExistente = dadosExistentes.find(d => d.funcionario_id === func.id);
            const valor = dadoExistente ? dadoExistente.valor : '';
            const obs = dadoExistente ? dadoExistente.observacao : '';
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <strong>${func.nome}</strong>
                    ${func.cargo ? `<br><small class="text-muted">${func.cargo}</small>` : ''}
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm valor-func" 
                           data-func-id="${func.id}" 
                           value="${valor}" 
                           placeholder="0,00"
                           oninput="formatNumberInput(this); calcularTotalModal()">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm obs-func" 
                           data-func-id="${func.id}" 
                           value="${obs}" 
                           placeholder="Opcional">
                </td>
            `;
            tbody.appendChild(tr);
        });
    }
    
    calcularTotalModal();
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalFuncionarios'));
    modal.show();
}

// Calcular total no modal
function calcularTotalModal() {
    let total = 0;
    document.querySelectorAll('.valor-func').forEach(input => {
        const valor = parseCurrency(input.value);
        total += valor;
    });
    document.getElementById('modal-total').textContent = formatCurrency(total);
}

// Salvar dados do modal
function salvarDadosFuncionarios() {
    const dados = [];
    
    document.querySelectorAll('.valor-func').forEach(input => {
        const funcId = input.getAttribute('data-func-id');
        const valor = parseCurrency(input.value);
        
        if (valor > 0) {
            const obsInput = document.querySelector(`.obs-func[data-func-id="${funcId}"]`);
            dados.push({
                funcionario_id: funcId,
                valor: valor,
                observacao: obsInput ? obsInput.value : ''
            });
        }
    });
    
    // Salvar nos arrays apropriados
    if (tipoModalAtual === 'sobras') {
        dadosSobras = dados;
        atualizarResumoSobras();
    } else if (tipoModalAtual === 'perdas') {
        dadosPerdas = dados;
        atualizarResumoPerdas();
    } else if (tipoModalAtual === 'vales') {
        dadosVales = dados;
        atualizarResumoVales();
    }
    
    // Recalcular totais
    calcularTotais();
    
    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById('modalFuncionarios')).hide();
}

// Atualizar resumos
function atualizarResumoSobras() {
    const total = dadosSobras.reduce((sum, d) => sum + parseFloat(d.valor), 0);
    document.getElementById('total-sobras').textContent = formatCurrency(total);
    document.getElementById('sobras-resumo').style.display = total > 0 ? 'block' : 'none';
}

function atualizarResumoPerdas() {
    const total = dadosPerdas.reduce((sum, d) => sum + parseFloat(d.valor), 0);
    document.getElementById('total-perdas').textContent = formatCurrency(total);
    document.getElementById('perdas-resumo').style.display = total > 0 ? 'block' : 'none';
}

function atualizarResumoVales() {
    const total = dadosVales.reduce((sum, d) => sum + parseFloat(d.valor), 0);
    document.getElementById('total-vales').textContent = formatCurrency(total);
    document.getElementById('vales-resumo').style.display = total > 0 ? 'block' : 'none';
}

// Initialize fixed comprova√ß√£o structure
function initializeComprovacoes() {
    const container = document.getElementById('comprovacoes-container');
    container.innerHTML = '';
    
    // 1. PRAZO - single field
    addComprovacaoSingle(container, 'PRAZO', 'Prazo');
    
    // 2. DEP√ìSITOS EM ESP√âCIE - multiple entries
    addComprovacaoMultiple(container, 'DEPOSITO_ESPECIE', 'Dep√≥sitos em Esp√©cie');
    
    // 3. DEP√ìSITOS EM CHEQUES √Ä VISTA - multiple entries
    addComprovacaoMultiple(container, 'DEPOSITO_CHEQUE_VISTA', 'Dep√≥sitos em Cheques √Ä Vista');
    
    // 4. DEP√ìSITOS EM CHEQUES A PRAZO - multiple entries
    addComprovacaoMultiple(container, 'DEPOSITO_CHEQUE_PRAZO', 'Dep√≥sitos em Cheques A Prazo');
    
    // 5. RECEBIMENTOS PIX - single field
    addComprovacaoSingle(container, 'PIX', 'Recebimentos PIX');
    
    // 6. CART√ÉO DE D√âBITO - lines for each brand + total
    addComprovacaoCartoes(container, 'DEBITO', 'Cart√£o de D√©bito');
    
    // 7. CART√ÉO DE CR√âDITO - lines for each brand + total
    addComprovacaoCartoes(container, 'CREDITO', 'Cart√£o de Cr√©dito');
    
    // 8-12: Other payment types (will use RETIRADA_PAGAMENTO as fallback)
    // These will be saved with descriptions to differentiate them
    addComprovacaoSingleComDescricao(container, 'RETIRADA_PAGAMENTO', 'Descontos Cadastros', 'Desconto Cadastros');
    addComprovacaoSingleComDescricao(container, 'RETIRADA_PAGAMENTO', 'Descontos Gerais', 'Desconto Gerais');
    addComprovacaoSingleComDescricao(container, 'RETIRADA_PAGAMENTO', 'Empr√©stimos Entre Funcion√°rios', 'Empr√©stimo Funcion√°rios');
    addComprovacaoSingleComDescricao(container, 'RETIRADA_PAGAMENTO', 'Retiradas para Aluguel', 'Retirada Aluguel');
    addComprovacaoSingleComDescricao(container, 'RETIRADA_PAGAMENTO', 'Retiradas para Pagamento');
}

// Add single field comprova√ß√£o (like PRAZO, PIX, etc.)
function addComprovacaoSingle(container, tipo, label) {
    const item = document.createElement('div');
    item.className = 'comprovacao-item';
    item.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-6">
                <label class="form-label mb-0" style="font-size: 0.85rem; font-weight: 600;">${label}</label>
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control form-control-sm comprovacao-valor" 
                       data-tipo="${tipo}" data-comprovacao-forma="${tipo}" placeholder="0,00" 
                       oninput="formatNumberInput(this)" onchange="calcularTotais()">
            </div>
        </div>
    `;
    container.appendChild(item);
}

// Add single field with description (like RETIRADA_PAGAMENTO)
function addComprovacaoSingleComDescricao(container, tipo, label, defaultDescricao = '') {
    const item = document.createElement('div');
    item.className = 'comprovacao-item';
    item.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-3">
                <label class="form-label mb-0" style="font-size: 0.85rem; font-weight: 600;">${label}</label>
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control form-control-sm comprovacao-valor" 
                       data-tipo="${tipo}" data-comprovacao-forma="${tipo}" placeholder="0,00" 
                       oninput="formatNumberInput(this)" onchange="calcularTotais()">
            </div>
            <div class="col-md-5">
                <input type="text" class="form-control form-control-sm comprovacao-descricao" 
                       data-tipo="${tipo}" placeholder="Descri√ß√£o" value="${defaultDescricao}">
            </div>
        </div>
    `;
    container.appendChild(item);
}

// Add multiple entries section (like DEPOSITO_ESPECIE, DEPOSITO_CHEQUE_VISTA, etc.)
function addComprovacaoMultiple(container, tipo, label) {
    const sectionId = `section-${tipo}`;
    const item = document.createElement('div');
    item.className = 'comprovacao-section';
    item.id = sectionId;
    
    // Determinar se √© uma se√ß√£o de cheques
    const isCheque = tipo.includes('CHEQUE');
    const depositoTipo = tipo === 'DEPOSITO_CHEQUE_VISTA' ? 'VISTA' : (tipo === 'DEPOSITO_CHEQUE_PRAZO' ? 'PRAZO' : null);
    
    // Bot√£o de registrar dep√≥sito apenas para cheques
    const btnRegistrarDeposito = isCheque ? `
        <button type="button" class="btn btn-sm btn-danger ms-2" onclick="abrirModalDeposito('${depositoTipo}', '${label}')" title="Registrar dep√≥sito realizado">
            üìç Registrar Dep√≥sito
        </button>
    ` : '';
    
    item.innerHTML = `
        <div style="background: #e9ecef; padding: 0.5rem; border-radius: 0.25rem; margin-bottom: 0.5rem;">
            <div class="d-flex justify-content-between align-items-center">
                <strong style="font-size: 0.85rem;">${label}</strong>
                <div>
                    <button type="button" class="btn btn-sm btn-success" onclick="addDepositoEntry('${tipo}', '${label}')">
                        <i class="bi bi-plus-circle"></i> Adicionar
                    </button>
                    ${btnRegistrarDeposito}
                </div>
            </div>
        </div>
        <div id="depositos-${tipo}" class="mb-2">
            <!-- Deposito entries will be added here -->
        </div>
        ${isCheque ? `
        <div id="lista-depositos-${depositoTipo}" class="mb-2" style="background: #fff3cd; padding: 0.5rem; border-radius: 0.25rem; display: none;">
            <strong style="font-size: 0.85rem;">üìã Dep√≥sitos Registrados:</strong>
            <div id="depositos-registrados-${depositoTipo}">
                <!-- Lista de dep√≥sitos registrados aparece aqui -->
            </div>
        </div>
        ` : ''}
        <div class="row align-items-center" style="padding: 0.5rem 0; border-top: 2px solid #28a745; margin-top: 0.3rem; background: #f8f9fa;">
            <div class="col-md-4" style="padding-left: 1rem;">
                <strong style="font-size: 0.85rem;">Total ${label}:</strong>
            </div>
            <div class="col-md-8">
                <strong id="total-deposito-${tipo}" class="text-success" style="font-size: 0.9rem;">R$ 0,00</strong>
            </div>
        </div>
    `;
    container.appendChild(item);
}

// Add cart√µes section (D√©bito or Cr√©dito)
function addComprovacaoCartoes(container, tipoCartao, label) {
    const sectionId = `section-cartao-${tipoCartao}`;
    const item = document.createElement('div');
    item.className = 'comprovacao-section';
    item.id = sectionId;
    
    // Filter cart√µes by type (DEBITO or CREDITO)
    const cartoesDoTipo = cartoes.filter(c => c.tipo && c.tipo.toUpperCase() === tipoCartao);
    
    let bandeirasList = '';
    cartoesDoTipo.forEach(cartao => {
        bandeirasList += `
            <div class="row align-items-center mb-1" style="padding: 0.3rem 0;">
                <div class="col-md-6" style="padding-left: 1.5rem;">
                    <label class="form-label mb-0" style="font-size: 0.8rem;">${cartao.nome}</label>
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control form-control-sm comprovacao-cartao-valor" 
                           data-tipo="CARTAO_${tipoCartao}" data-comprovacao-forma="CARTAO_${tipoCartao}" data-bandeira="${cartao.id}" data-bandeira-id="${cartao.id}"
                           placeholder="0,00" oninput="formatNumberInput(this)" 
                           onchange="calcularTotaisCartao('${tipoCartao}')">
                </div>
            </div>
        `;
    });
    
    item.innerHTML = `
        <div style="background: #e9ecef; padding: 0.5rem; border-radius: 0.25rem; margin-bottom: 0.3rem;">
            <strong style="font-size: 0.85rem;">${label}</strong>
        </div>
        ${bandeirasList}
        <div class="row align-items-center" style="padding: 0.5rem 0; border-top: 2px solid #007bff; margin-top: 0.3rem;">
            <div class="col-md-6" style="padding-left: 1.5rem;">
                <strong style="font-size: 0.85rem;">Total ${label}:</strong>
            </div>
            <div class="col-md-6">
                <strong id="total-cartao-${tipoCartao}" class="text-primary" style="font-size: 0.9rem;">R$ 0,00</strong>
            </div>
        </div>
    `;
    container.appendChild(item);
}

// Add a new deposito entry
function addDepositoEntry(tipo, label) {
    const depositosContainer = document.getElementById(`depositos-${tipo}`);
    const entryIndex = comprovacaoIndex++;
    
    const entry = document.createElement('div');
    entry.className = 'comprovacao-item';
    entry.id = `deposito-${tipo}-${entryIndex}`;
    entry.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-4">
                <input type="text" class="form-control form-control-sm comprovacao-valor" 
                       data-tipo="${tipo}" data-comprovacao-forma="${tipo}" placeholder="0,00" 
                       oninput="formatNumberInput(this); calcularTotaisDeposito('${tipo}')" 
                       onchange="calcularTotais()">
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control form-control-sm comprovacao-descricao" 
                       data-tipo="${tipo}" placeholder="Descri√ß√£o">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeDepositoEntry('${tipo}', ${entryIndex})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
    depositosContainer.appendChild(entry);
}

// Add a new deposito entry AUTO (from TROCO PIX - readonly)
function addDepositoEntryAuto(tipo, valor, descricao) {
    const depositosContainer = document.getElementById(`depositos-${tipo}`);
    const entryIndex = comprovacaoIndex++;
    
    const entry = document.createElement('div');
    entry.className = 'comprovacao-item comprovacao-item-auto';
    entry.id = `deposito-${tipo}-${entryIndex}`;
    entry.innerHTML = `
        <div class="row align-items-center" style="background: #e8f5e9; padding: 0.3rem; border-radius: 0.25rem; margin-bottom: 0.2rem;">
            <div class="col-md-4">
                <input type="text" class="form-control form-control-sm comprovacao-valor" 
                       data-tipo="${tipo}" data-comprovacao-forma="${tipo}" placeholder="0,00" 
                       value="${formatCurrency(valor)}" readonly
                       style="background-color: #f1f8e9; font-weight: bold;"
                       oninput="formatNumberInput(this); calcularTotaisDeposito('${tipo}')" 
                       onchange="calcularTotais()">
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control form-control-sm comprovacao-descricao" 
                       data-tipo="${tipo}" value="${descricao}" readonly
                       style="background-color: #f1f8e9; font-weight: bold;">
            </div>
            <div class="col-md-2 text-center">
                <span class="badge bg-success" style="font-size: 0.7rem;">AUTO</span>
            </div>
        </div>
    `;
    depositosContainer.appendChild(entry);
    
    // Recalculate totals after adding
    calcularTotaisDeposito(tipo);
}

// Remove a deposito entry
function removeDepositoEntry(tipo, index) {
    const entry = document.getElementById(`deposito-${tipo}-${index}`);
    if (entry) {
        entry.remove();
        calcularTotaisDeposito(tipo);
        calcularTotais();
    }
}

// Calculate total for a specific deposit type
function calcularTotaisDeposito(tipo) {
    let total = 0;
    const depositosContainer = document.getElementById(`depositos-${tipo}`);
    if (depositosContainer) {
        depositosContainer.querySelectorAll(`.comprovacao-valor[data-tipo="${tipo}"]`).forEach(input => {
            total += parseCurrency(input.value);
        });
    }
    
    const totalElement = document.getElementById(`total-deposito-${tipo}`);
    if (totalElement) {
        totalElement.textContent = formatCurrency(total);
    }
}

// Calculate total for a specific card type (DEBITO or CREDITO)
function calcularTotaisCartao(tipoCartao) {
    let total = 0;
    document.querySelectorAll(`.comprovacao-cartao-valor[data-tipo="CARTAO_${tipoCartao}"]`).forEach(input => {
        total += parseCurrency(input.value);
    });
    
    document.getElementById(`total-cartao-${tipoCartao}`).textContent = formatCurrency(total);
    calcularTotais();
}

function calcularTotais() {
    // Calculate receitas total
    let totalReceitas = 0;
    document.querySelectorAll('.receita-valor').forEach(input => {
        totalReceitas += parseCurrency(input.value);
    });
    
    // Add sobras to receitas
    const totalSobras = dadosSobras.reduce((sum, d) => sum + parseFloat(d.valor), 0);
    totalReceitas += totalSobras;
    
    // Calculate comprovacoes total (includes single fields, multiple deposits, and card values)
    let totalComprovacao = 0;
    
    // Add single field values
    document.querySelectorAll('.comprovacao-valor').forEach(input => {
        totalComprovacao += parseCurrency(input.value);
    });
    
    // Add card values (already included in comprovacao-cartao-valor which also has comprovacao-valor-like behavior)
    document.querySelectorAll('.comprovacao-cartao-valor').forEach(input => {
        totalComprovacao += parseCurrency(input.value);
    });
    
    // Add perdas and vales to comprovacoes
    const totalPerdas = dadosPerdas.reduce((sum, d) => sum + parseFloat(d.valor), 0);
    const totalVales = dadosVales.reduce((sum, d) => sum + parseFloat(d.valor), 0);
    totalComprovacao += totalPerdas + totalVales;
    
    // Calculate diferenca: Total Comprova√ß√£o - Total Receitas
    const diferenca = totalComprovacao - totalReceitas;
    
    // Update displays
    document.getElementById('total-receitas').textContent = formatCurrency(totalReceitas);
    document.getElementById('total-receitas-resumo').textContent = formatCurrency(totalReceitas);
    document.getElementById('total-comprovacao').textContent = formatCurrency(totalComprovacao);
    document.getElementById('total-comprovacao-resumo').textContent = formatCurrency(totalComprovacao);
    
    const diferencaEl = document.getElementById('diferenca');
    // Show negative sign explicitly for negative values
    if (diferenca < 0) {
        diferencaEl.textContent = '- ' + formatCurrency(Math.abs(diferenca));
        diferencaEl.className = 'text-danger fw-bold'; // Red for deficit (DEVEDOR)
    } else if (diferenca > 0) {
        diferencaEl.textContent = formatCurrency(diferenca);
        diferencaEl.className = 'text-primary fw-bold'; // Blue for surplus (SOBRAR)
    } else {
        diferencaEl.textContent = formatCurrency(diferenca);
        diferencaEl.className = 'text-success fw-bold'; // Green for balanced
    }
}

document.getElementById('formCaixa').addEventListener('submit', function(e) {
    // Collect receitas (only non-zero values)
    const receitas = [];
    document.querySelectorAll('.receita-item').forEach(item => {
        const tipo = item.querySelector('.receita-tipo').value;
        const valorInput = item.querySelector('.receita-valor');
        const valor = valorInput ? valorInput.value : '';
        const descricaoInput = item.querySelector('.receita-descricao');
        const descricao = descricaoInput ? descricaoInput.value : '';
        
        // Only include if tipo exists and value is not 0
        if (tipo && valor && parseCurrency(valor) > 0) {
            receitas.push({ tipo, descricao, valor });
        }
    });
    
    // Collect comprovacoes (new fixed structure)
    const comprovacoes = [];
    
    // Collect single field values (PRAZO, PIX, DESCONTOS, EMPRESTIMOS, RETIRADAS, etc.)
    document.querySelectorAll('.comprovacao-valor').forEach(input => {
        const tipo = input.getAttribute('data-tipo');
        const valor = input.value;
        
        if (tipo && valor && parseCurrency(valor) > 0) {
            // Check if this field has an associated description
            const descricaoInput = input.parentElement.parentElement.querySelector('.comprovacao-descricao');
            const descricao = descricaoInput ? descricaoInput.value : '';
            
            // Map tipo to forma_pagamento_id
            const formaId = getFormaPagamentoIdByTipo(tipo);
            
            comprovacoes.push({
                forma_pagamento_id: formaId,
                valor: valor,
                descricao: descricao,
                bandeira_cartao_id: null
            });
        }
    });
    
    // Collect card values (DEBITO and CREDITO)
    document.querySelectorAll('.comprovacao-cartao-valor').forEach(input => {
        const tipo = input.getAttribute('data-tipo');  // CARTAO_DEBITO or CARTAO_CREDITO
        const bandeiraId = input.getAttribute('data-bandeira');
        const valor = input.value;
        
        if (valor && parseCurrency(valor) > 0) {
            // Map CARTAO_DEBITO or CARTAO_CREDITO to forma_pagamento_id
            // Both map to CARTAO type
            const formaId = getFormaPagamentoIdByTipo('CARTAO');
            
            comprovacoes.push({
                forma_pagamento_id: formaId,
                valor: valor,
                descricao: '',
                bandeira_cartao_id: bandeiraId
            });
        }
    });
    
    // Set JSON values
    document.getElementById('receitas-json').value = JSON.stringify(receitas);
    document.getElementById('comprovacoes-json').value = JSON.stringify(comprovacoes);
    document.getElementById('sobras-json').value = JSON.stringify(dadosSobras);
    document.getElementById('perdas-json').value = JSON.stringify(dadosPerdas);
    document.getElementById('vales-json').value = JSON.stringify(dadosVales);
});

// Initialize receipt types on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeReceitas();
    initializeComprovacoes();
    
    {% if edit_mode %}
    // Load existing receitas data in edit mode
    console.log('=== EDIT MODE: Loading receitas data ===');
    const existingReceitas = {{ receitas_json|safe }};
    console.log('Receitas from backend:', existingReceitas);
    console.log('Number of receitas:', existingReceitas.length);
    
    // Wait a moment for the page to fully initialize
    setTimeout(() => {
        console.log('Starting to populate receitas...');
        for (const receita of existingReceitas) {
            console.log(`Looking for receita tipo: ${receita.tipo}, valor: ${receita.valor}`);
            const valorInput = document.querySelector(`input[data-receita-tipo="${receita.tipo}"]`);
            console.log('Found input:', valorInput);
            
            if (valorInput) {
                // Format value as Brazilian currency
                const formattedValue = parseFloat(receita.valor).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                valorInput.value = formattedValue;
                console.log(`Set ${receita.tipo} to ${formattedValue}`);
                
                // If there's a description field, populate it (look for sibling in same row)
                const descricaoInput = valorInput.closest('.row').querySelector('.receita-descricao');
                if (descricaoInput && receita.descricao) {
                    descricaoInput.value = receita.descricao;
                    console.log(`Set description for ${receita.tipo} to ${receita.descricao}`);
                }
            } else {
                console.warn(`Could not find input for receita tipo: ${receita.tipo}`);
            }
        }
        calcularTotais();
        console.log('Finished loading receitas');
    }, 500);
    
    // Load existing comprovacoes data in edit mode
    // Increase timeout to ensure DOM is ready, especially after save redirect
    setTimeout(() => {
        console.log('=== EDIT MODE: Loading comprovacoes data ===');
        console.log('[CARREGAMENTO] DOM readyState:', document.readyState);
        const existingComprovacoes = {{ comprovacoes_json|safe }};
        console.log('Comprovacoes from backend:', existingComprovacoes);
        console.log('Number of comprovacoes:', existingComprovacoes.length);
        
        // Group comprovacoes by forma_pagamento_tipo (not ID, because we need the tipo to match inputs)
        const comprovacoesByTipo = {};
        for (const comp of existingComprovacoes) {
            const tipo = comp.forma_pagamento_tipo;
            if (!tipo) {
                console.warn('Comprovacao without forma_pagamento_tipo:', comp);
                continue;
            }
            
            console.log(`  Comprovacao: tipo="${tipo}", valor=${comp.valor}, bandeira_id=${comp.bandeira_cartao_id}, desc="${comp.descricao}"`);
            
            if (!comprovacoesByTipo[tipo]) {
                comprovacoesByTipo[tipo] = [];
            }
            comprovacoesByTipo[tipo].push(comp);
        }
        
        console.log('Grouped comprovacoes by tipo:', comprovacoesByTipo);
        
        // Populate each forma de pagamento by tipo
        for (const tipo in comprovacoesByTipo) {
            console.log(`Processing tipo: ${tipo}`);
            const comps = comprovacoesByTipo[tipo];
        
        // Handle different types of formas_pagamento
        if (tipo === 'DEPOSITO_ESPECIE' || tipo === 'DEPOSITO_CHEQUE_VISTA' || tipo === 'DEPOSITO_CHEQUE_PRAZO') {
            // Multiple entries allowed - add each one by clicking the Add button
            console.log(`  Loading ${comps.length} deposits of tipo: ${tipo}`);
            for (let i = 0; i < comps.length; i++) {
                const comp = comps[i];
                console.log(`    Deposit ${i}: valor=${comp.valor}, descricao="${comp.descricao}"`);
                
                // For ALL deposits (including first), click Add button to create the input
                const addButton = document.querySelector(`button[onclick*="addDepositoEntry"][onclick*="${tipo}"]`);
                if (addButton) {
                    addButton.click();
                    // Wait a bit for DOM to update, then fill
                    setTimeout(() => {
                        const allInputs = document.querySelectorAll(`input[data-comprovacao-forma="${tipo}"]`);
                        const lastValorInput = allInputs[allInputs.length - 1];
                        const lastDescInput = lastValorInput?.closest('.comprovacao-item').querySelector('input[placeholder*="Descri√ß√£o"]');
                        console.log(`    After clicking Add, found ${allInputs.length} inputs, filling last one with ${comp.valor}`);
                        if (lastValorInput) {
                            lastValorInput.value = parseFloat(comp.valor).toLocaleString('pt-BR', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                        }
                        if (lastDescInput && comp.descricao) {
                            lastDescInput.value = comp.descricao;
                        }
                        // Recalculate totals after filling
                        if (tipo === 'DEPOSITO_ESPECIE') calcularTotaisDeposito('DEPOSITO_ESPECIE');
                        if (tipo === 'DEPOSITO_CHEQUE_VISTA') calcularTotaisDeposito('DEPOSITO_CHEQUE_VISTA');
                        if (tipo === 'DEPOSITO_CHEQUE_PRAZO') calcularTotaisDeposito('DEPOSITO_CHEQUE_PRAZO');
                        calcularTotais();
                    }, 100 * (i + 1)); // Add 1 to ensure first deposit also waits
                }
            }
        } else if (tipo === 'CARTAO') {
            // Card with bandeira - find the input by bandeira_cartao_id
            // Cards in DB have tipo='CARTAO', but in HTML they have data-tipo='CARTAO_DEBITO' or 'CARTAO_CREDITO'
            for (const comp of comps) {
                // Try both CARTAO_DEBITO and CARTAO_CREDITO since we don't know which one this bandeira is
                const valorInput = document.querySelector(`input[data-bandeira-id="${comp.bandeira_cartao_id}"]`);
                if (valorInput) {
                    valorInput.value = parseFloat(comp.valor).toLocaleString('pt-BR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                }
            }
            // Calculate totals for both debit and credit (the function will handle which one)
            calcularTotaisCartao('DEBITO');
            calcularTotaisCartao('CREDITO');
        } else if (tipo === 'DEPOSITO_ESPECIE' || tipo === 'DEPOSITO_CHEQUE_VISTA' || tipo === 'DEPOSITO_CHEQUE_PRAZO') {
            // Deposits - tipo directly tells us which deposit type it is
            console.log(`Found ${comps.length} deposits of tipo ${tipo}`);
            
            for (const comp of comps) {
                console.log(`Adding deposit entry for ${tipo}, valor: ${comp.valor}`);
                
                // Find the "add" button for this deposit type and click it to create an entry
                const addButton = document.querySelector(`button[onclick*="addDeposito"][onclick*="${tipo}"]`);
                if (addButton) {
                    console.log(`Found add button for ${tipo}, clicking it`);
                    addButton.click();
                    
                    // Wait a bit for the new input to be created
                    setTimeout(() => {
                        // Find the last (most recently added) input for this deposit type
                        const container = addButton.closest('.comprovacao-item');
                        const inputs = container.querySelectorAll('input[type="number"]');
                        const lastInput = inputs[inputs.length - 1];
                        
                        if (lastInput) {
                            lastInput.value = parseFloat(comp.valor).toLocaleString('pt-BR', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                            console.log(`Set deposit ${tipo} to ${lastInput.value}`);
                        } else {
                            console.log(`Could not find input in container for ${tipo}`);
                        }
                    }, 100);
                } else {
                    console.log(`Add button NOT FOUND for ${tipo}`);
                }
            }
            
            // Calculate totals for all deposit types
            setTimeout(() => {
                calcularTotaisDeposito('DEPOSITO_ESPECIE');
                calcularTotaisDeposito('DEPOSITO_CHEQUE_VISTA');
                calcularTotaisDeposito('DEPOSITO_CHEQUE_PRAZO');
            }, 200);
        } else if (tipo === 'RETIRADA_PAGAMENTO') {
            // RETIRADA_PAGAMENTO has multiple fields with same tipo but different descriptions
            // Need to match by description to fill the correct field
            console.log(`  Processing RETIRADA_PAGAMENTO with ${comps.length} entries`);
            
            for (const comp of comps) {
                console.log(`    Looking for field with description: "${comp.descricao}"`);
                
                // Find all inputs with this tipo
                const allInputs = document.querySelectorAll(`input[data-comprovacao-forma="${tipo}"]`);
                console.log(`    Found ${allInputs.length} inputs with tipo RETIRADA_PAGAMENTO`);
                
                // Find the one with matching description
                let found = false;
                for (const valorInput of allInputs) {
                    const descricaoInput = valorInput.closest('.comprovacao-item').querySelector('.comprovacao-descricao');
                    if (descricaoInput) {
                        console.log(`      Checking input with description: "${descricaoInput.value}"`);
                        if (descricaoInput.value.toUpperCase() === comp.descricao.toUpperCase()) {
                            // Found matching field by description (case-insensitive)
                            valorInput.value = parseFloat(comp.valor).toLocaleString('pt-BR', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                            console.log(`      ‚úì Matched! Set value to ${valorInput.value}`);
                            found = true;
                            break;
                        }
                    }
                }
                
                if (!found) {
                    console.warn(`    ‚úó Could not find field for description: "${comp.descricao}"`);
                }
            }
        } else {
            // Single entry formas - just fill the first value
            const comp = comps[0];
            const valorInput = document.querySelector(`input[data-comprovacao-forma="${tipo}"]`);
            if (valorInput) {
                valorInput.value = parseFloat(comp.valor).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                // If there's a description field, populate it
                const descricaoInput = valorInput.closest('.comprovacao-item').querySelector('input[placeholder*="Descri√ß√£o"]');
                if (descricaoInput && comp.descricao) {
                    descricaoInput.value = comp.descricao;
                }
            }
        }
    }
    
    // Calculate totals (includes receitas, comprovacoes, and diferen√ßa)
    calcularTotais();
    
    // Load sobras/perdas/vales data in edit mode
    {% if edit_mode and sobras_json %}
    console.log('=== EDIT MODE: Loading sobras/perdas/vales ===');
    
    // Load sobras
    const sobrasData = {{ sobras_json|safe }};
    console.log('Sobras data:', sobrasData);
    if (sobrasData && sobrasData.length > 0) {
        dadosSobras = sobrasData.map(s => ({
            funcionario_id: s.funcionario_id,
            valor: s.valor,
            observacao: s.observacao || ''
        }));
        atualizarResumoSobras();
        console.log(`Loaded ${dadosSobras.length} sobras`);
    }
    
    // Load perdas
    const perdasData = {{ perdas_json|safe }};
    console.log('Perdas data:', perdasData);
    if (perdasData && perdasData.length > 0) {
        dadosPerdas = perdasData.map(p => ({
            funcionario_id: p.funcionario_id,
            valor: p.valor,
            observacao: p.observacao || ''
        }));
        atualizarResumoPerdas();
        console.log(`Loaded ${dadosPerdas.length} perdas`);
    }
    
    // Load vales
    const valesData = {{ vales_json|safe }};
    console.log('Vales data:', valesData);
    if (valesData && valesData.length > 0) {
        dadosVales = valesData.map(v => ({
            funcionario_id: v.funcionario_id,
            valor: v.valor,
            observacao: v.observacao || ''
        }));
        atualizarResumoVales();
        console.log(`Loaded ${dadosVales.length} vales`);
    }
    
    // Recalculate totals to include sobras/perdas/vales
    calcularTotais();
    {% endif %}
    
    console.log('=== EDIT MODE: Finished loading all data ===');
        
        // Verificar se campos RETIRADA_PAGAMENTO foram preenchidos corretamente
        setTimeout(() => {
            console.log('[VERIFICACAO] Verificando se campos RETIRADA_PAGAMENTO foram preenchidos...');
            const retiradasInputs = document.querySelectorAll('input[data-comprovacao-forma="RETIRADA_PAGAMENTO"]');
            console.log('[VERIFICACAO] Encontrados', retiradasInputs.length, 'campos RETIRADA_PAGAMENTO');
            
            // Verificar se algum campo foi preenchido
            let algumPreenchido = false;
            let camposVazios = [];
            
            for (const input of retiradasInputs) {
                const valor = input.value || '';
                const descInput = input.closest('.comprovacao-item').querySelector('.comprovacao-descricao');
                const desc = descInput ? descInput.value : 'sem descri√ß√£o';
                
                console.log('[VERIFICACAO] Campo:', desc, '= "' + valor + '"');
                
                if (valor && valor !== '0,00' && valor !== '0' && valor !== '') {
                    algumPreenchido = true;
                } else if (desc) {
                    camposVazios.push(desc);
                }
            }
            
            // Se temos comprova√ß√µes RETIRADA_PAGAMENTO no banco mas nenhum campo foi preenchido, fazer retry
            const temRetiradasNoBanco = existingComprovacoes.some(c => c.forma_pagamento_tipo === 'RETIRADA_PAGAMENTO');
            
            if (temRetiradasNoBanco && !algumPreenchido) {
                console.warn('[VERIFICACAO] ‚ö†Ô∏è Campos RETIRADA_PAGAMENTO no banco mas nenhum preenchido! Tentando novamente...');
                console.warn('[VERIFICACAO] Campos vazios:', camposVazios);
                
                // Retry: reprocessar RETIRADA_PAGAMENTO
                const retiradasComps = existingComprovacoes.filter(c => c.forma_pagamento_tipo === 'RETIRADA_PAGAMENTO');
                for (const comp of retiradasComps) {
                    console.log('[RETRY] Reprocessando:', comp.descricao, '=', comp.valor);
                    
                    const allInputs = document.querySelectorAll('input[data-comprovacao-forma="RETIRADA_PAGAMENTO"]');
                    for (const valorInput of allInputs) {
                        const descricaoInput = valorInput.closest('.comprovacao-item').querySelector('.comprovacao-descricao');
                        if (descricaoInput && descricaoInput.value.toUpperCase() === comp.descricao.toUpperCase()) {
                            valorInput.value = parseFloat(comp.valor).toLocaleString('pt-BR', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                            console.log('[RETRY] ‚úì Preenchido:', comp.descricao, '=', valorInput.value);
                            break;
                        }
                    }
                }
                
                // Recalcular totais
                calcularTotais();
                console.log('[RETRY] Retry conclu√≠do');
            } else if (algumPreenchido) {
                console.log('[VERIFICACAO] ‚úì Campos RETIRADA_PAGAMENTO preenchidos corretamente');
            } else {
                console.log('[VERIFICACAO] Sem dados RETIRADA_PAGAMENTO no banco, ok');
            }
        }, 500); // Esperar mais 500ms ap√≥s o carregamento inicial
    }, 1000);  // Give more time for page to fully initialize
    {% endif %}
    
    // Carregar dep√≥sitos em modo de edi√ß√£o
    {% if edit_mode and lancamento %}
    carregarDepositos({{ lancamento.id }});
    {% endif %}
});

// ========== FUN√á√ïES PARA CONTROLE DE DEP√ìSITOS DE CHEQUES ==========

let depositoEmEdicao = null;

// Abrir modal para registrar dep√≥sito
function abrirModalDeposito(tipo, label) {
    depositoEmEdicao = null;
    document.getElementById('depositoTipo').value = tipo;
    document.getElementById('depositoLabel').value = label;
    document.getElementById('modalDepositoTitle').textContent = `Registrar Dep√≥sito - ${label}`;
    
    // Calcular total de cheques (AUTO + Manuais)
    const tipoDeposito = tipo === 'VISTA' ? 'DEPOSITO_CHEQUE_VISTA' : 'DEPOSITO_CHEQUE_PRAZO';
    let totalCheques = 0;
    const depositosContainer = document.getElementById(`depositos-${tipoDeposito}`);
    if (depositosContainer) {
        depositosContainer.querySelectorAll(`.comprovacao-valor[data-tipo="${tipoDeposito}"]`).forEach(input => {
            totalCheques += parseCurrency(input.value);
        });
    }
    
    // Preencher valor lan√ßado automaticamente
    const valorLancadoInput = document.getElementById('depositoValorLancado');
    valorLancadoInput.value = totalCheques.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    valorLancadoInput.setAttribute('readonly', 'readonly');
    valorLancadoInput.style.backgroundColor = '#e9ecef';
    
    document.getElementById('depositoValorDepositado').value = '';
    document.getElementById('depositoDataDeposito').value = '';
    document.getElementById('depositoDepositadoPor').value = '';
    document.getElementById('depositoObservacao').value = '';
    document.getElementById('depositoDiferenca').textContent = 'R$ 0,00';
    document.getElementById('depositoDiferencaBadge').className = 'badge bg-secondary';
    
    const modal = new bootstrap.Modal(document.getElementById('modalDeposito'));
    modal.show();
}

// Calcular diferen√ßa automaticamente
function calcularDiferencaDeposito() {
    const valorLancado = parseFloat(document.getElementById('depositoValorLancado').value.replace(/\./g, '').replace(',', '.')) || 0;
    const valorDepositado = parseFloat(document.getElementById('depositoValorDepositado').value.replace(/\./g, '').replace(',', '.')) || 0;
    const diferenca = valorLancado - valorDepositado;
    
    const diferencaElem = document.getElementById('depositoDiferenca');
    const badgeElem = document.getElementById('depositoDiferencaBadge');
    
    diferencaElem.textContent = diferenca.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    });
    
    if (diferenca > 0.01) {
        badgeElem.className = 'badge bg-warning';
    } else if (diferenca < -0.01) {
        badgeElem.className = 'badge bg-info';
    } else {
        badgeElem.className = 'badge bg-success';
    }
}

// Salvar dep√≥sito
async function salvarDeposito() {
    const tipo = document.getElementById('depositoTipo').value;
    const valorLancado = parseFloat(document.getElementById('depositoValorLancado').value.replace(/\./g, '').replace(',', '.'));
    const valorDepositado = document.getElementById('depositoValorDepositado').value.replace(/\./g, '').replace(',', '.');
    const dataDeposito = document.getElementById('depositoDataDeposito').value;
    const depositadoPor = document.getElementById('depositoDepositadoPor').value;
    const observacao = document.getElementById('depositoObservacao').value;
    
    if (!valorLancado || valorLancado <= 0) {
        alert('Informe o valor lan√ßado!');
        return;
    }
    
    {% if edit_mode and lancamento %}
    const lancamentoId = {{ lancamento.id }};
    {% else %}
    // Em modo de cria√ß√£o, precisamos salvar o lan√ßamento primeiro
    alert('Salve o lan√ßamento primeiro antes de registrar dep√≥sitos.');
    return;
    {% endif %}
    
    const dados = {
        tipo: tipo,
        valor_lancado: valorLancado,
        valor_depositado: valorDepositado ? parseFloat(valorDepositado) : null,
        data_deposito: dataDeposito || null,
        depositado_por: depositadoPor || null,
        observacao: observacao || null
    };
    
    try {
        const url = depositoEmEdicao 
            ? `/lancamentos_caixa/${lancamentoId}/depositos_cheques/${depositoEmEdicao}`
            : `/lancamentos_caixa/${lancamentoId}/depositos_cheques`;
        const method = depositoEmEdicao ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('modalDeposito')).hide();
            carregarDepositos(lancamentoId);
            alert(depositoEmEdicao ? 'Dep√≥sito atualizado com sucesso!' : 'Dep√≥sito registrado com sucesso!');
        } else {
            const error = await response.json();
            alert('Erro ao salvar dep√≥sito: ' + (error.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao salvar dep√≥sito: ' + error.message);
    }
}

// Carregar lista de dep√≥sitos
async function carregarDepositos(lancamentoId) {
    try {
        const response = await fetch(`/lancamentos_caixa/${lancamentoId}/depositos_cheques`);
        if (response.ok) {
            const depositos = await response.json();
            
            // Separar por tipo
            const depositosVista = depositos.filter(d => d.tipo === 'VISTA');
            const depositosPrazo = depositos.filter(d => d.tipo === 'PRAZO');
            
            // Atualizar listas
            atualizarListaDepositos('VISTA', depositosVista);
            atualizarListaDepositos('PRAZO', depositosPrazo);
        }
    } catch (error) {
        console.error('Erro ao carregar dep√≥sitos:', error);
    }
}

// Atualizar lista visual de dep√≥sitos
function atualizarListaDepositos(tipo, depositos) {
    const listaDiv = document.getElementById(`lista-depositos-${tipo}`);
    const registradosDiv = document.getElementById(`depositos-registrados-${tipo}`);
    
    if (!registradosDiv) return;
    
    if (depositos.length === 0) {
        listaDiv.style.display = 'none';
        return;
    }
    
    listaDiv.style.display = 'block';
    registradosDiv.innerHTML = '';
    
    depositos.forEach(deposito => {
        const valorLancado = parseFloat(deposito.valor_lancado);
        const valorDepositado = parseFloat(deposito.valor_depositado) || 0;
        const diferenca = valorLancado - valorDepositado;
        
        let statusBadge, statusTexto;
        if (!deposito.valor_depositado) {
            statusBadge = 'bg-secondary';
            statusTexto = '‚è≥ Aguardando dep√≥sito';
        } else if (Math.abs(diferenca) < 0.01) {
            statusBadge = 'bg-success';
            statusTexto = '‚úÖ Conferido OK';
        } else if (diferenca > 0.01) {
            statusBadge = 'bg-warning text-dark';
            statusTexto = `‚ö†Ô∏è Falta: ${diferenca.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}`;
        } else {
            statusBadge = 'bg-info';
            statusTexto = `‚ÑπÔ∏è Sobra: ${Math.abs(diferenca).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}`;
        }
        
        const item = document.createElement('div');
        item.className = 'border rounded p-2 mb-2';
        item.style.background = '#fff';
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="mb-1">
                        <strong>Lan√ßado:</strong> ${valorLancado.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                        ${deposito.valor_depositado ? `<br><strong>Depositado:</strong> ${valorDepositado.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}` : ''}
                    </div>
                    <div class="mb-1">
                        <span class="badge ${statusBadge}">${statusTexto}</span>
                    </div>
                    ${deposito.data_deposito ? `<div class="small text-muted">Data: ${new Date(deposito.data_deposito + 'T00:00:00').toLocaleDateString('pt-BR')}</div>` : ''}
                    ${deposito.depositado_por ? `<div class="small text-muted">Por: ${deposito.depositado_por}</div>` : ''}
                    ${deposito.observacao ? `<div class="small text-muted">Obs: ${deposito.observacao}</div>` : ''}
                </div>
                <div class="btn-group-vertical btn-group-sm">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="editarDeposito(${deposito.id}, '${tipo}')" title="Editar">
                        ‚úèÔ∏è
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="excluirDeposito(${deposito.id}, '${tipo}')" title="Excluir">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        `;
        registradosDiv.appendChild(item);
    });
}

// Editar dep√≥sito
async function editarDeposito(depositoId, tipo) {
    {% if edit_mode and lancamento %}
    const lancamentoId = {{ lancamento.id }};
    {% else %}
    alert('Salve o lan√ßamento primeiro.');
    return;
    {% endif %}
    
    try {
        const response = await fetch(`/lancamentos_caixa/${lancamentoId}/depositos_cheques`);
        if (response.ok) {
            const depositos = await response.json();
            const deposito = depositos.find(d => d.id === depositoId);
            
            if (deposito) {
                depositoEmEdicao = depositoId;
                document.getElementById('depositoTipo').value = deposito.tipo;
                const label = deposito.tipo === 'VISTA' ? 'Dep√≥sitos em Cheques √Ä Vista' : 'Dep√≥sitos em Cheques A Prazo';
                document.getElementById('depositoLabel').value = label;
                document.getElementById('modalDepositoTitle').textContent = `Editar Dep√≥sito - ${label}`;
                document.getElementById('depositoValorLancado').value = deposito.valor_lancado.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('depositoValorDepositado').value = deposito.valor_depositado ? deposito.valor_depositado.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
                document.getElementById('depositoDataDeposito').value = deposito.data_deposito || '';
                document.getElementById('depositoDepositadoPor').value = deposito.depositado_por || '';
                document.getElementById('depositoObservacao').value = deposito.observacao || '';
                calcularDiferencaDeposito();
                
                const modal = new bootstrap.Modal(document.getElementById('modalDeposito'));
                modal.show();
            }
        }
    } catch (error) {
        console.error('Erro ao carregar dep√≥sito:', error);
        alert('Erro ao carregar dep√≥sito');
    }
}

// Excluir dep√≥sito
async function excluirDeposito(depositoId, tipo) {
    if (!confirm('Tem certeza que deseja excluir este dep√≥sito?')) {
        return;
    }
    
    {% if edit_mode and lancamento %}
    const lancamentoId = {{ lancamento.id }};
    {% else %}
    alert('Salve o lan√ßamento primeiro.');
    return;
    {% endif %}
    
    try {
        const response = await fetch(`/lancamentos_caixa/${lancamentoId}/depositos_cheques/${depositoId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            carregarDepositos(lancamentoId);
            alert('Dep√≥sito exclu√≠do com sucesso!');
        } else {
            alert('Erro ao excluir dep√≥sito');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao excluir dep√≥sito: ' + error.message);
    }
}

</script>

<!-- Modal para Registrar/Editar Dep√≥sito -->
<div class="modal fade" id="modalDeposito" tabindex="-1" aria-labelledby="modalDepositoTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDepositoTitle">Registrar Dep√≥sito de Cheque</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="depositoTipo">
                <input type="hidden" id="depositoLabel">
                
                <div class="mb-3">
                    <label for="depositoValorLancado" class="form-label">Valor Lan√ßado *</label>
                    <input type="text" class="form-control" id="depositoValorLancado" 
                           placeholder="0,00" oninput="calcularDiferencaDeposito()" required>
                    <small class="text-muted">Valor total dos cheques lan√ßados</small>
                </div>
                
                <div class="mb-3">
                    <label for="depositoValorDepositado" class="form-label">Valor Depositado</label>
                    <input type="text" class="form-control" id="depositoValorDepositado" 
                           placeholder="0,00" oninput="calcularDiferencaDeposito()">
                    <small class="text-muted">Valor que foi efetivamente depositado (deixe vazio se ainda n√£o depositou)</small>
                </div>
                
                <div class="mb-3">
                    <div class="alert alert-info py-2">
                        <strong>Diferen√ßa:</strong> 
                        <span id="depositoDiferenca" class="fs-5">R$ 0,00</span>
                        <span id="depositoDiferencaBadge" class="badge bg-secondary ms-2">-</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="depositoDataDeposito" class="form-label">Data do Dep√≥sito</label>
                    <input type="date" class="form-control" id="depositoDataDeposito">
                </div>
                
                <div class="mb-3">
                    <label for="depositoDepositadoPor" class="form-label">Respons√°vel pelo Dep√≥sito</label>
                    <input type="text" class="form-control" id="depositoDepositadoPor" 
                           placeholder="Nome da pessoa que fez o dep√≥sito">
                </div>
                
                <div class="mb-3">
                    <label for="depositoObservacao" class="form-label">Observa√ß√£o</label>
                    <textarea class="form-control" id="depositoObservacao" rows="2" 
                              placeholder="Ex: Cheque para 10/02/2026, Dep√≥sito parcial, etc."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarDeposito()">Salvar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
