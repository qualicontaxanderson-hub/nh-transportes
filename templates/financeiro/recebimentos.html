{% extends "base.html" %}

{% block titulo %}Recebimentos - NH Transportes{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <h2 class="mb-3">üí∞ Recebimentos / Boletos</h2>
    
    {% if recebimentos %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Frete</th>
                    <th>Cliente</th>
                    <th>Valor</th>
                    <th>Vencimento</th>
                    <th>Status</th>
                    <th>Charge ID</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for r in recebimentos %}
                <tr id="cobranca-row-{{ r.charge_id or r.id }}">
                    <td>{{ r.id }}</td>
                    <td>
                      {# Mostrar n√∫mero do frete se dispon√≠vel, fallback para frete_id #}
                      {% if r.frete_numero %}
                        #{{ r.frete_numero }}
                      {% elif r.frete_id %}
                        #{{ r.frete_id }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>{{ r.cliente_fantasia or r.cliente_nome or '-' }}</td>
                    <td>
                      {% if r.valor is not none %}
                        R$ {{ ("%.2f"|format(r.valor|float)).replace('.', ',') }}
                      {% else %}
                        R$ 0,00
                      {% endif %}
                    </td>
                    <td>{{ r.data_vencimento_fmt or (r.data_vencimento.strftime('%d/%m/%Y') if r.data_vencimento else '-') }}</td>
                    <td>
                        {# usar display_status calculado no backend (routes/financeiro.py) #}
                        {% set ds = r.display_status if r.display_status is defined else (r.status or 'pendente') %}
                        {% if ds == 'pago' %}
                            <span class="badge bg-success">Pago</span>
                        {% elif ds == 'quitado' %}
                            <span class="badge bg-info">Quitado</span>
                        {% elif ds == 'vencido' %}
                            <span class="badge bg-danger">Vencido</span>
                        {% elif ds == 'cancelado' %}
                            <span class="badge bg-secondary">Cancelado</span>
                        {% else %}
                            <span class="badge bg-warning">Pendente</span>
                        {% endif %}
                    </td>
                    <td><small>{{ r.charge_id or '-' }}</small></td>
                    <td>
                        <div class="btn-group" role="group" aria-label="A√ß√µes cobranca">
                            {# Mostrar bot√£o de visualiza√ß√£o sempre que houver charge_id (serve local ou provedor) #}
                            {% if r.charge_id %}
                            <a href="{{ url_for('financeiro.visualizar_boleto', charge_id=r.charge_id) }}" target="_blank" class="btn btn-sm btn-primary" title="Ver/Imprimir Boleto">
                                <i class="bi bi-file-earmark-pdf"></i>
                            </a>
                            {% else %}
                            <button class="btn btn-sm btn-secondary" disabled title="Sem link de boleto">
                                <i class="bi bi-file-earmark-pdf"></i>
                            </button>
                            {% endif %}

                            {% if r.charge_id %}
                            <!-- Marcar pago -->
                            <form method="post" action="{{ url_for('financeiro.marcar_pago', charge_id=r.charge_id) }}" style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-success" title="Marcar como Pago" onclick="return confirm('Confirma marcar esta cobran√ßa como PAGO (admin)?');">
                                    <i class="bi bi-check2-circle"></i>
                                </button>
                            </form>

                            <!-- Cancelar -->
                            <form method="post" action="{{ url_for('financeiro.cancelar_boleto', charge_id=r.charge_id) }}" style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Cancelar Boleto" onclick="return confirm('Confirma cancelar este boleto no provedor? Isto permitir√° reemitir.');">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </form>

                            <!-- Prorrogar vencimento (JS) -->
                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary btn-prorrogar"
                                    data-charge-id="{{ r.charge_id }}"
                                    title="Prorrogar vencimento">
                                <i class="bi bi-calendar-plus"></i>
                            </button>

                            <!-- Reemitir: habilitado apenas se display_status == 'cancelado' -->
                            <button type="button"
                                    class="btn btn-sm btn-outline-primary btn-reemitir"
                                    data-charge-id="{{ r.charge_id }}"
                                    data-frete-id="{{ r.frete_id or '' }}"
                                    title="Reemitir boleto"
                                    {% if ds != 'cancelado' %} disabled {% endif %}>
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>

                            <!-- Consultar Status EFI -->
                            <button type="button"
                                    class="btn btn-sm btn-outline-info btn-status-efi"
                                    data-charge-id="{{ r.charge_id }}"
                                    title="Consultar Status no Banco EFI">
                                <i class="bi bi-info-circle"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> Nenhum recebimento encontrado.
    </div>
    {% endif %}
</div>

<!-- Script inline para a√ß√µes de prorrogar e reemitir -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  function qsa(sel, el=document){ return Array.from(el.querySelectorAll(sel)); }

  // Prorrogar vencimento
  qsa('.btn-prorrogar').forEach(btn => {
    btn.addEventListener('click', async function () {
      const chargeId = this.getAttribute('data-charge-id');
      if (!chargeId) { alert('Charge ID ausente'); return; }
      const newDate = prompt("Informe a nova data de vencimento (YYYY-MM-DD):");
      if (!newDate) return;
      if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate)) { alert('Formato inv√°lido. Use YYYY-MM-DD'); return; }
      if (!confirm('Confirma alterar vencimento para ' + newDate + ' ?')) return;

      try {
        const resp = await fetch(`/financeiro/prorrogar-boleto/${chargeId}/`, {
          method: 'POST',
          headers: {'Content-Type':'application/json', 'X-Requested-With':'XMLHttpRequest'},
          body: JSON.stringify({new_date: newDate})
        });
        const j = await resp.json();
        if (resp.ok && j.success) {
          alert('Vencimento atualizado com sucesso.');
          location.reload();
        } else {
          alert('Falha ao prorrogar: ' + (j.error || JSON.stringify(j)));
        }
      } catch (err) {
        alert('Erro na requisi√ß√£o: ' + err);
      }
    });
  });

  // Reemitir boleto
  qsa('.btn-reemitir').forEach(btn => {
    btn.addEventListener('click', async function () {
      const chargeId = this.getAttribute('data-charge-id');
      const freteId = this.getAttribute('data-frete-id') || null;
      if (!chargeId) { alert('Charge ID ausente'); return; }
      if (!confirm('Confirma reemitir o boleto? (S√≥ √© permitido se estiver cancelado)')) return;

      try {
        const resp = await fetch(`/financeiro/reemitir-boleto/${chargeId}/`, {
          method: 'POST',
          headers: {'Content-Type':'application/json', 'X-Requested-With':'XMLHttpRequest'},
          body: JSON.stringify({frete_id: freteId})
        });
        const j = await resp.json();
        if (resp.ok && j.success) {
          alert('Boleto reemitido com sucesso.');
          location.reload();
        } else {
          alert('Falha ao reemitir: ' + (j.error || JSON.stringify(j)));
        }
      } catch (err) {
        alert('Erro na requisi√ß√£o: ' + err);
      }
    });
  });

  // Consultar Status EFI
  qsa('.btn-status-efi').forEach(btn => {
    btn.addEventListener('click', async function () {
      const chargeId = this.getAttribute('data-charge-id');
      if (!chargeId) { alert('Charge ID ausente'); return; }
      
      // Desabilitar bot√£o e mostrar loading
      const originalText = this.innerHTML;
      this.disabled = true;
      this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
      
      try {
        const resp = await fetch(`/financeiro/consultar-status-efi/${chargeId}/`, {
          method: 'GET',
          headers: {'X-Requested-With':'XMLHttpRequest'}
        });
        const j = await resp.json();
        
        if (resp.ok && j.success) {
          // Montar mensagem com as informa√ß√µes da cobran√ßa
          let message = `üìä Status da Cobran√ßa #${j.charge_id}\n\n`;
          message += `Status: ${j.status_label || j.status || 'Desconhecido'}\n`;
          
          // Mostrar valor se existir e for maior que zero
          if (j.total && j.total > 0) {
            message += `Valor: R$ ${(j.total / 100).toFixed(2).replace('.', ',')}\n`;
          } else if (j.total === 0) {
            message += `Valor: R$ 0,00\n`;
          }
          
          if (j.expire_at) {
            message += `Vencimento: ${j.expire_at}\n`;
          }
          if (j.paid_at) {
            message += `Pago em: ${j.paid_at}\n`;
          }
          if (j.payment_method && j.payment_method !== 'boleto') {
            message += `M√©todo: ${j.payment_method}\n`;
          }
          if (j.barcode) {
            message += `\nC√≥digo de Barras:\n${j.barcode}\n`;
          }
          
          // Adicionar aviso se status for desconhecido
          if (j.status === 'desconhecido' || !j.status) {
            message += `\n‚ö†Ô∏è Aten√ß√£o: O status retornado pelo EFI n√£o p√¥de ser identificado.\nVerifique os logs do sistema para mais detalhes.`;
          }
          
          alert(message);
        } else {
          // Mostrar erro mais detalhado
          const errorMsg = j.error || 'Erro desconhecido ao consultar status';
          alert(`‚ùå Falha ao consultar status EFI\n\nCharge ID: ${chargeId}\nErro: ${errorMsg}\n\nVerifique:\n- Se o Charge ID est√° correto\n- Se as credenciais EFI est√£o configuradas\n- Os logs do sistema para mais detalhes`);
        }
      } catch (err) {
        alert(`‚ùå Erro na requisi√ß√£o\n\nCharge ID: ${chargeId}\nErro: ${err}\n\nVerifique sua conex√£o e tente novamente.`);
      } finally {
        // Restaurar bot√£o
        this.disabled = false;
        this.innerHTML = originalText;
      }
    });
  });

});
</script>

{% endblock %}
