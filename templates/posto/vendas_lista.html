{% extends "base.html" %}
{% block titulo %}Vendas do Posto{% endblock %}

{% block styles %}
<style>
:root {
  --grad-start: #4A90E2;
  --grad-end: #F2994A;
  --accent: #1f6fb6;
  --etanol-color: #28a745;
  --gasolina-color: #dc3545;
  --gasolina-aditivada-color: #007bff;
  --s10-color: #007bff;
  --s500-color: #343a40;
}

.page-header-posto {
  background: linear-gradient(135deg, var(--grad-start) 0%, #9fb8d6 38%, var(--grad-end) 100%);
  color: white;
  padding: 1.5rem;
  border-radius: 8px;
  margin-bottom: 1.5rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-posto-primary {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
}

.btn-posto-primary:hover {
  background: #14588f;
  border-color: #14588f;
  color: white;
}

.card-dia {
  border-left: 4px solid var(--accent);
  margin-bottom: 1.5rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.produto-row:hover {
  background-color: #f8f9fa;
}

.total-dia {
  background: linear-gradient(135deg, rgba(74,144,226,0.1), rgba(242,153,74,0.1));
  font-weight: 600;
  border-top: 2px solid var(--accent);
}

.filtros-card {
  border: 1px solid #dee2e6;
  border-radius: 8px;
  background: #fff;
  margin-bottom: 1.5rem;
}

/* Product colors */
.produto-etanol { color: var(--etanol-color) !important; }
.produto-gasolina { color: var(--gasolina-color) !important; }
.produto-gasolina-aditivada { color: var(--gasolina-aditivada-color) !important; }
.produto-s-10 { color: var(--s10-color) !important; }
.produto-s-500 { color: var(--s500-color) !important; }

/* Accounting format for currency alignment */
.valor-contabil {
  text-align: right;
  white-space: nowrap;
}

.resumo-total {
  background: linear-gradient(135deg, rgba(74,144,226,0.15), rgba(242,153,74,0.15));
  font-weight: 700;
  border-top: 3px solid var(--accent);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Cabeçalho -->
  <div class="page-header-posto">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h3 class="mb-1">
          <i class="bi bi-fuel-pump-fill"></i> Vendas do Posto
        </h3>
        <p class="mb-0 opacity-75">Lançamentos de saída de combustível</p>
      </div>
      <div>
        <a href="{{ url_for('posto.vendas_lancar') }}" class="btn btn-light btn-lg">
          <i class="bi bi-plus-circle"></i> Novo Lançamento
        </a>
      </div>
    </div>
  </div>

  <!-- Summary by Product -->
  {% if resumo_por_produto %}
  <div class="card shadow-sm mb-4">
    <div class="card-header" style="background: var(--accent); color: white;">
      <h5 class="mb-0">
        <i class="bi bi-bar-chart-fill"></i> Resumo por Produto
      </h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead style="background: #f8f9fa;">
            <tr>
              <th>Produto</th>
              <th class="text-end">Litros</th>
              <th class="text-end">Valor Total</th>
              <th class="text-end">Preço Médio</th>
            </tr>
          </thead>
          <tbody>
            {% set ns = namespace(total_litros=0, total_valor=0) %}
            {% for item in resumo_por_produto %}
            {% set ns.total_litros = ns.total_litros + item.litros %}
            {% set ns.total_valor = ns.total_valor + item.valor_total %}
            {% set produto_class = 'produto-' + item.produto.lower().replace(' ', '-') %}
            <tr>
              <td>
                <i class="bi bi-droplet-fill {{ produto_class }}"></i>
                <strong class="{{ produto_class }}">{{ item.produto }}</strong>
              </td>
              <td class="text-end">{{ "{:,.3f}".format(item.litros).replace(',', '_').replace('.', ',').replace('_', '.') }}</td>
              <td class="text-end">R$ {{ "{:,.2f}".format(item.valor_total).replace(',', '_').replace('.', ',').replace('_', '.') }}</td>
              <td class="text-end">R$ {{ "{:,.4f}".format(item.preco_medio).replace('.', ',') }}/L</td>
            </tr>
            {% endfor %}
            <!-- Totals Row -->
            <tr class="resumo-total">
              <td><strong>TOTAL GERAL</strong></td>
              <td class="text-end"><strong>{{ "{:,.3f}".format(ns.total_litros).replace(',', '_').replace('.', ',').replace('_', '.') }}</strong></td>
              <td class="text-end"><strong>R$ {{ "{:,.2f}".format(ns.total_valor).replace(',', '_').replace('.', ',').replace('_', '.') }}</strong></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Filtros -->
  <div class="card filtros-card">
    <div class="card-body">
      <form method="GET" class="row g-3">
        <div class="col-md-3">
          <label class="form-label fw-bold">Data Início</label>
          <input type="date" name="data_inicio" class="form-control" 
                 value="{{ filtros.data_inicio }}">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold">Data Fim</label>
          <input type="date" name="data_fim" class="form-control" 
                 value="{{ filtros.data_fim }}">
        </div>
        <div class="col-md-4">
          <label class="form-label fw-bold">Posto</label>
          <select name="cliente_id" class="form-select">
            <option value="">Todos os postos</option>
            {% for cliente in clientes %}
            <option value="{{ cliente.id }}" 
                    {% if filtros.cliente_id == cliente.id|string %}selected{% endif %}>
              {{ cliente.razao_social }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-posto-primary w-100">
            <i class="bi bi-funnel"></i> Filtrar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lista de Vendas por Dia -->
  {% if vendas_organizadas %}
    {% for data_key, dados in vendas_organizadas.items() %}
    <div class="card card-dia">
      <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>
              <i class="bi bi-calendar3"></i> 
              {{ dados.data.strftime('%d/%m/%Y') }} - 
              {% set dia_semana = dados.data.strftime('%A') %}
              {% if dia_semana == 'Monday' %}Segunda-feira
              {% elif dia_semana == 'Tuesday' %}Terça-feira
              {% elif dia_semana == 'Wednesday' %}Quarta-feira
              {% elif dia_semana == 'Thursday' %}Quinta-feira
              {% elif dia_semana == 'Friday' %}Sexta-feira
              {% elif dia_semana == 'Saturday' %}Sábado
              {% elif dia_semana == 'Sunday' %}Domingo
              {% else %}{{ dia_semana }}{% endif %}
            </strong>
          </div>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-primary">
              {{ dados.cliente.razao_social if dados.cliente else 'Cliente não identificado' }}
            </span>
            <a href="{{ url_for('posto.vendas_editar_data', data=dados.data.strftime('%Y-%m-%d'), cliente_id=dados.cliente_id) }}" 
               class="btn btn-sm btn-outline-primary" 
               title="Editar todos os produtos deste dia">
              <i class="bi bi-pencil"></i> Editar
            </a>
          </div>
        </div>
      </div>
      
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Produto</th>
              <th class="text-end">Estoque Inicial</th>
              <th class="text-end">Litros</th>
              <th class="text-end">Valor Total (R$)</th>
              <th class="text-end">Preço Médio (R$/L)</th>
            </tr>
          </thead>
          <tbody>
            {% for item in dados.produtos %}
            {% set produto_nome = item.produto.nome if item.produto else 'Produto desconhecido' %}
            {% set produto_class = 'produto-' + produto_nome.lower().replace(' ', '-') %}
            <tr class="produto-row">
              <td>
                <i class="bi bi-droplet-fill {{ produto_class }}"></i>
                <span class="{{ produto_class }}">{{ produto_nome }}</span>
              </td>
              <td class="text-end">{% if item.estoque_inicial %}{{ "{:,.3f}".format(item.estoque_inicial).replace(',', '_').replace('.', ',').replace('_', '.') }}{% else %}-{% endif %}</td>
              <td class="text-end">{{ "{:,.3f}".format(item.litros).replace(',', '_').replace('.', ',').replace('_', '.') }}</td>
              <td class="text-end">R$ {{ "{:,.2f}".format(item.valor).replace(',', '_').replace('.', ',').replace('_', '.') }}</td>
              <td class="text-end">R$ {{ "{:,.4f}".format(item.preco_medio).replace('.', ',') }}</td>
            </tr>
            {% endfor %}
            
            <!-- Total do Dia -->
            <tr class="total-dia">
              <td><strong>TOTAL DO DIA</strong></td>
              <td></td>
              <td class="text-end"><strong>{{ "{:,.3f}".format(dados.total_litros).replace(',', '_').replace('.', ',').replace('_', '.') }}</strong></td>
              <td class="text-end"><strong>R$ {{ "{:,.2f}".format(dados.total_valor).replace(',', '_').replace('.', ',').replace('_', '.') }}</strong></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i> 
      Nenhuma venda encontrada para o período selecionado. 
      <a href="{{ url_for('posto.vendas_lancar') }}" class="alert-link">Clique aqui para fazer um novo lançamento.</a>
    </div>
  {% endif %}
</div>
{% endblock %}
