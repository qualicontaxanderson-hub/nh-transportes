{% extends "base.html" %}
{% block titulo %}Vendas do Posto{% endblock %}

{% block styles %}
<style>
:root {
  --grad-start: #4A90E2;
  --grad-end: #F2994A;
  --accent: #1f6fb6;
}

.page-header-posto {
  background: linear-gradient(135deg, var(--grad-start) 0%, #9fb8d6 38%, var(--grad-end) 100%);
  color: white;
  padding: 1.5rem;
  border-radius: 8px;
  margin-bottom: 1.5rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-posto-primary {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
}

.btn-posto-primary:hover {
  background: #14588f;
  border-color: #14588f;
  color: white;
}

.card-dia {
  border-left: 4px solid var(--accent);
  margin-bottom: 1.5rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.produto-row:hover {
  background-color: #f8f9fa;
}

.total-dia {
  background: linear-gradient(135deg, rgba(74,144,226,0.1), rgba(242,153,74,0.1));
  font-weight: 600;
  border-top: 2px solid var(--accent);
}

.filtros-card {
  border: 1px solid #dee2e6;
  border-radius: 8px;
  background: #fff;
  margin-bottom: 1.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Cabeçalho -->
  <div class="page-header-posto">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h3 class="mb-1">
          <i class="bi bi-fuel-pump-fill"></i> Vendas do Posto
        </h3>
        <p class="mb-0 opacity-75">Lançamentos de saída de combustível</p>
      </div>
      <div>
        <a href="{{ url_for('posto.vendas_lancar') }}" class="btn btn-light btn-lg">
          <i class="bi bi-plus-circle"></i> Novo Lançamento
        </a>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card filtros-card">
    <div class="card-body">
      <form method="GET" class="row g-3">
        <div class="col-md-3">
          <label class="form-label fw-bold">Data Início</label>
          <input type="date" name="data_inicio" class="form-control" 
                 value="{{ filtros.data_inicio }}">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold">Data Fim</label>
          <input type="date" name="data_fim" class="form-control" 
                 value="{{ filtros.data_fim }}">
        </div>
        <div class="col-md-4">
          <label class="form-label fw-bold">Posto</label>
          <select name="cliente_id" class="form-select">
            <option value="">Todos os postos</option>
            {% for cliente in clientes %}
            <option value="{{ cliente.id }}" 
                    {% if filtros.cliente_id == cliente.id|string %}selected{% endif %}>
              {{ cliente.razao_social }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-posto-primary w-100">
            <i class="bi bi-funnel"></i> Filtrar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lista de Vendas por Dia -->
  {% if vendas_organizadas %}
    {% for data_key, dados in vendas_organizadas.items() %}
    <div class="card card-dia">
      <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>
              <i class="bi bi-calendar3"></i> 
              {{ dados.data.strftime('%d/%m/%Y') }} - 
              {% set dia_semana = dados.data.strftime('%A') %}
              {% if dia_semana == 'Monday' %}Segunda-feira
              {% elif dia_semana == 'Tuesday' %}Terça-feira
              {% elif dia_semana == 'Wednesday' %}Quarta-feira
              {% elif dia_semana == 'Thursday' %}Quinta-feira
              {% elif dia_semana == 'Friday' %}Sexta-feira
              {% elif dia_semana == 'Saturday' %}Sábado
              {% elif dia_semana == 'Sunday' %}Domingo
              {% else %}{{ dia_semana }}{% endif %}
            </strong>
          </div>
          <div>
            <span class="badge bg-primary">
              {{ dados.cliente.razao_social if dados.cliente else 'Cliente não identificado' }}
            </span>
          </div>
        </div>
      </div>
      
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Produto</th>
              <th class="text-end">Litros</th>
              <th class="text-end">Valor Total (R$)</th>
              <th class="text-end">Preço Médio (R$/L)</th>
              <th class="text-center">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for item in dados.produtos %}
            <tr class="produto-row">
              <td>
                <i class="bi bi-droplet-fill" style="color: var(--accent);"></i>
                {{ item.produto.nome if item.produto else 'Produto desconhecido' }}
              </td>
              <td class="text-end">{{ "{:,.2f}".format(item.litros).replace(',', '_').replace('.', ',').replace('_', '.') }}</td>
              <td class="text-end">R$ {{ "{:,.2f}".format(item.valor).replace(',', '_').replace('.', ',').replace('_', '.') }}</td>
              <td class="text-end">R$ {{ "{:,.4f}".format(item.preco_medio).replace('.', ',') }}</td>
              <td class="text-center">
                {% if item.venda_id %}
                <a href="{{ url_for('posto.vendas_editar', venda_id=item.venda_id) }}" 
                   class="btn btn-sm btn-outline-primary" 
                   title="Editar">
                  <i class="bi bi-pencil"></i>
                </a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
            
            <!-- Total do Dia -->
            <tr class="total-dia">
              <td><strong>TOTAL DO DIA</strong></td>
              <td class="text-end"><strong>{{ "{:,.2f}".format(dados.total_litros).replace(',', '_').replace('.', ',').replace('_', '.') }}</strong></td>
              <td class="text-end"><strong>R$ {{ "{:,.2f}".format(dados.total_valor).replace(',', '_').replace('.', ',').replace('_', '.') }}</strong></td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i> 
      Nenhuma venda encontrada para o período selecionado. 
      <a href="{{ url_for('posto.vendas_lancar') }}" class="alert-link">Clique aqui para fazer um novo lançamento.</a>
    </div>
  {% endif %}
</div>
{% endblock %}
