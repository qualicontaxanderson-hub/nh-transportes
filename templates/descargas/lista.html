{% extends "base.html" %}

{% block title %}Controle de Descargas - NH Transportes{% endblock %}

{% block styles %}
<style>
:root {
  --grad-start: #4a90e2;
  --grad-end: #f2994a;
  --accent: #4a90e2;
  --etanol-color: #28a745;
  --gasolina-color: #dc3545;
  --gasolina-aditivada-color: #007bff;
  --s10-color: #007bff;
  --s500-color: #343a40;
}

body {
  background: linear-gradient(135deg, var(--grad-start) 0%, #9fb8d6 38%, var(--grad-end) 100%);
  color: white;
  min-height: 100vh;
}

.btn-primary {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
}

.btn-primary:hover {
  background: #14588f;
  border-color: #14588f;
  color: white;
}

.card {
  background-color: #f8f9fa;
  border: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.card-header {
  background: linear-gradient(135deg, rgba(74,144,226,0.1), rgba(242,153,74,0.1));
  border-bottom: 2px solid var(--accent);
}

.table-container {
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
}

/* Product colors */
.produto-etanol { color: var(--etanol-color) !important; font-weight: bold; }
.produto-gasolina { color: var(--gasolina-color) !important; font-weight: bold; }
.produto-gasolina-aditivada { color: var(--gasolina-aditivada-color) !important; font-weight: bold; }
.produto-s-10 { color: var(--s10-color) !important; font-weight: bold; }
.produto-s-500 { color: var(--s500-color) !important; font-weight: bold; }

/* Status badges */
.badge-pendente {
  background-color: #ffc107;
  color: #000;
}

.badge-parcial {
  background-color: #17a2b8;
  color: #fff;
}

.badge-concluido {
  background-color: #28a745;
  color: #fff;
}

.filter-card {
  background: linear-gradient(135deg, rgba(74,144,226,0.15), rgba(242,153,74,0.15));
  border: 1px solid rgba(74,144,226,0.3);
  margin-bottom: 20px;
}

.table-hover tbody tr:hover {
  background-color: rgba(74,144,226,0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-truck"></i> Controle de Descargas</h1>
    <a href="{{ url_for('fretes.lista') }}" class="btn btn-success">
      <i class="bi bi-plus-circle"></i> Novo Lançamento
    </a>
  </div>

  <!-- Filtros -->
  <div class="card filter-card mb-4">
    <div class="card-body">
      <form method="GET" action="{{ url_for('descargas.lista') }}" class="row g-3">
        <div class="col-md-2">
          <label for="data_inicio" class="form-label text-dark">Data Início</label>
          <input type="date" class="form-control" id="data_inicio" name="data_inicio" 
                 value="{{ data_inicio }}">
        </div>
        <div class="col-md-2">
          <label for="data_fim" class="form-label text-dark">Data Fim</label>
          <input type="date" class="form-control" id="data_fim" name="data_fim" 
                 value="{{ data_fim }}">
        </div>
        <div class="col-md-3">
          <label for="cliente_id" class="form-label text-dark">Cliente</label>
          <select class="form-select" id="cliente_id" name="cliente_id">
            <option value="">Todos</option>
            {% for cliente in clientes %}
              <option value="{{ cliente.id }}" {% if cliente_id|string == cliente.id|string %}selected{% endif %}>
                {{ cliente.razao_social }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label for="status" class="form-label text-dark">Status</label>
          <select class="form-select" id="status" name="status">
            <option value="">Todos</option>
            <option value="pendente" {% if status == 'pendente' %}selected{% endif %}>Pendente</option>
            <option value="parcial" {% if status == 'parcial' %}selected{% endif %}>Parcial</option>
            <option value="concluido" {% if status == 'concluido' %}selected{% endif %}>Concluído</option>
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary me-2">
            <i class="bi bi-search"></i> Filtrar
          </button>
          <a href="{{ url_for('descargas.lista') }}" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Limpar
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabela de Descargas -->
  <div class="card">
    <div class="card-header" style="background: var(--accent); color: white;">
      <h5 class="mb-0">
        <i class="bi bi-list-ul"></i> Lista de Descargas
        <span class="badge bg-light text-dark">{{ descargas|length }} registros</span>
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead style="background: #f8f9fa;">
            <tr>
              <th>Data Descarga</th>
              <th>Cliente</th>
              <th>Fornecedor</th>
              <th>Produto</th>
              <th>Volume</th>
              <th>Status</th>
              <th>Diferença Sistema</th>
              <th>Diferença Régua</th>
              <th class="text-center">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% if descargas %}
              {% for descarga in descargas %}
                <tr>
                  <td class="text-dark">{{ descarga.data_descarga_formatada }}</td>
                  <td class="text-dark">{{ descarga.cliente }}</td>
                  <td class="text-dark">{{ descarga.fornecedor }}</td>
                  <td>
                    {% set produto_class = '' %}
                    {% if descarga.produto %}
                      {% set produto_upper = descarga.produto|upper %}
                      {% if 'ETANOL' in produto_upper %}
                        {% set produto_class = 'produto-etanol' %}
                      {% elif 'GASOLINA ADITIVADA' in produto_upper %}
                        {% set produto_class = 'produto-gasolina-aditivada' %}
                      {% elif 'GASOLINA' in produto_upper %}
                        {% set produto_class = 'produto-gasolina' %}
                      {% elif 'S-10' in produto_upper or 'S10' in produto_upper %}
                        {% set produto_class = 'produto-s-10' %}
                      {% elif 'S-500' in produto_upper or 'S500' in produto_upper %}
                        {% set produto_class = 'produto-s-500' %}
                      {% endif %}
                    {% endif %}
                    <span class="{{ produto_class }}">{{ descarga.produto }}</span>
                  </td>
                  <td class="text-dark">
                    {{ "%.2f"|format(descarga.volume_descarregado) }} / {{ "%.2f"|format(descarga.volume_total) }}
                  </td>
                  <td>
                    {% if descarga.status == 'pendente' %}
                      <span class="badge badge-pendente">Pendente</span>
                    {% elif descarga.status == 'parcial' %}
                      <span class="badge badge-parcial">Parcial</span>
                    {% elif descarga.status == 'concluido' %}
                      <span class="badge badge-concluido">Concluído</span>
                    {% endif %}
                  </td>
                  <td class="text-dark">
                    {% if descarga.diferenca_sistema %}
                      {% if descarga.diferenca_sistema > 0 %}
                        <span class="text-success">+{{ "%.2f"|format(descarga.diferenca_sistema) }}</span>
                      {% else %}
                        <span class="text-danger">{{ "%.2f"|format(descarga.diferenca_sistema) }}</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td class="text-dark">
                    {% if descarga.diferenca_regua %}
                      {% if descarga.diferenca_regua > 0 %}
                        <span class="text-success">+{{ "%.2f"|format(descarga.diferenca_regua) }}</span>
                      {% else %}
                        <span class="text-danger">{{ "%.2f"|format(descarga.diferenca_regua) }}</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    <a href="{{ url_for('descargas.detalhes', descarga_id=descarga.id) }}" 
                       class="btn btn-sm btn-info" title="Ver Detalhes">
                      <i class="bi bi-eye"></i>
                    </a>
                    {% if descarga.status != 'concluido' %}
                      <a href="{{ url_for('descargas.novo', frete_id=descarga.frete_id) }}" 
                         class="btn btn-sm btn-warning" title="Adicionar Etapa">
                        <i class="bi bi-plus-circle"></i>
                      </a>
                    {% endif %}
                    <button class="btn btn-sm btn-success" 
                            onclick="copiarWhatsApp({{ descarga.id }})" 
                            title="Copiar para WhatsApp">
                      <i class="bi bi-whatsapp"></i>
                    </button>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="9" class="text-center text-muted py-4">
                  <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                  <p class="mt-2">Nenhuma descarga encontrada</p>
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function copiarWhatsApp(descargaId) {
  fetch(`/descargas/whatsapp/${descargaId}`)
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.texto) {
        // Copiar para clipboard
        navigator.clipboard.writeText(data.texto).then(() => {
          alert('✅ Texto copiado para a área de transferência!\n\nVocê pode colar no WhatsApp agora.');
        }).catch(err => {
          console.error('Erro ao copiar:', err);
          // Fallback: mostrar em um modal
          alert('Texto para WhatsApp:\n\n' + data.texto);
        });
      } else if (data.error) {
        alert('❌ Erro: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('❌ Erro ao gerar texto para WhatsApp: ' + error.message);
    });
}
</script>
{% endblock %}
