{% extends "base.html" %}

{% block title %}Novo Pedido - NH Transportes{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col">
            <h2><i class="bi bi-cart-plus"></i> Novo Pedido</h2>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('pedidos.index') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <form method="POST" id="formPedido">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-info-circle"></i> Informações do Pedido
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <label class="form-label">Número</label>
                        <input type="text" class="form-control" value="{{ numero_sugerido }}" readonly style="background-color: #e9ecef;">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Data do Pedido *</label>
                        <input type="date" class="form-control" name="data_pedido" value="{{ hoje or '' }}" required>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Observações</label>
                        <input type="text" class="form-control" name="observacoes" placeholder="Observações gerais do pedido">
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-list-ul"></i> Itens do Pedido</span>
                <button type="button" class="btn btn-light btn-sm" onclick="adicionarItem()">
                    <i class="bi bi-plus-circle"></i> Adicionar Item
                </button>
            </div>
            <div class="card-body">
                <div id="itensContainer">
                    <!-- Itens serão adicionados aqui -->
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mb-4">
            <a href="{{ url_for('pedidos.index') }}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle"></i> Salvar Pedido
            </button>
        </div>
    </form>
</div>

<template id="templateItem">
    <div class="item-pedido card mb-3">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <span class="item-numero">Item #1</span>
            <button type="button" class="btn btn-danger btn-sm" onclick="removerItem(this)">
                <i class="bi bi-trash"></i> Remover
            </button>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Cliente *</label>
                    <select class="form-select" name="cliente_id[]" required>
                        <option value="">Selecione o Cliente</option>
                        {% for c in clientes %}
                        <option value="{{ c.id }}">{{ c.nome_fantasia or c.razao_social }}{% if c.cnpj %} - {{ c.cnpj }}{% endif %}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Produto *</label>
                    <select class="form-select" name="produto_id[]" required>
                        <option value="">Selecione o Produto</option>
                        {% for p in produtos %}
                        <option value="{{ p.id }}">{{ p.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Fornecedor *</label>
                    <select class="form-select" name="fornecedor_id[]" required>
                        <option value="">Selecione o Fornecedor</option>
                        {% for f in fornecedores %}
                        <option value="{{ f.id }}">{{ f.nome_fantasia or f.razao_social }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Origem *</label>
                    <select class="form-select" name="origem_id[]" required>
                        <option value="">Selecione a Origem</option>
                        {% for o in origens %}
                        <option value="{{ o.id }}">{{ o.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Tipo Qtd</label>
                    <select class="form-select select-tipo-qtd" name="tipo_quantidade[]" onchange="toggleQuantidade(this)">
                        <option value="lista">Lista</option>
                        <option value="manual">Manual</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Quantidade *</label>
                    <div class="div-quantidade-lista">
                        <select class="form-select select-quantidade" name="quantidade_id[]" onchange="selecionarQuantidade(this)">
                            <option value="">Selecione</option>
                            {% for q in quantidades %}
                            <option value="{{ q.id }}" data-valor="{{ q.valor }}">{{ q.descricao }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="div-quantidade-manual" style="display:none;">
                        <input type="number" class="form-control input-quantidade-manual" placeholder="Digite a quantidade" step="0.01" min="0">
                    </div>
                    <input type="hidden" class="input-quantidade-final" name="quantidade[]" value="">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Preço Unit. (R$)</label>
                    <input type="text" class="form-control input-preco" name="preco_unitario[]" placeholder="0,000">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Total NF (R$)</label>
                    <input type="text" class="form-control input-total-nf" name="total_nf[]" placeholder="0,00" readonly style="background-color: #e9ecef;">
                </div>
            </div>
        </div>
    </div>
</template>

<script>
let itemCount = 0;

function adicionarItem() {
    itemCount++;
    const container = document.getElementById('itensContainer');
    const template = document.getElementById('templateItem');
    const clone = template.content.cloneNode(true);
    
    clone.querySelector('.item-numero').textContent = 'Item #' + itemCount;
    
    container.appendChild(clone);
    atualizarNumerosItens();
}

function removerItem(btn) {
    const itens = document.querySelectorAll('.item-pedido');
    if (itens.length > 1) {
        btn.closest('.item-pedido').remove();
        atualizarNumerosItens();
    } else {
        alert('O pedido deve ter pelo menos um item.');
    }
}

function atualizarNumerosItens() {
    const itens = document.querySelectorAll('.item-pedido');
    itens.forEach((item, index) => {
        item.querySelector('.item-numero').textContent = 'Item #' + (index + 1);
    });
}

function toggleQuantidade(select) {
    const item = select.closest('.item-pedido');
    const divLista = item.querySelector('.div-quantidade-lista');
    const divManual = item.querySelector('.div-quantidade-manual');
    const selectQtd = item.querySelector('.select-quantidade');
    const inputManual = item.querySelector('.input-quantidade-manual');
    const inputFinal = item.querySelector('.input-quantidade-final');
    
    if (select.value === 'manual') {
        divLista.style.display = 'none';
        divManual.style.display = 'block';
        selectQtd.value = '';
        inputFinal.value = inputManual.value || '';
        
        inputManual.oninput = function() {
            inputFinal.value = this.value;
            calcularTotalItem(item);
        };
    } else {
        divLista.style.display = 'block';
        divManual.style.display = 'none';
        inputManual.value = '';
        if (selectQtd.value) {
            const option = selectQtd.options[selectQtd.selectedIndex];
            inputFinal.value = option.dataset.valor || '';
        } else {
            inputFinal.value = '';
        }
    }
    calcularTotalItem(item);
}

function selecionarQuantidade(select) {
    const item = select.closest('.item-pedido');
    const inputFinal = item.querySelector('.input-quantidade-final');
    const option = select.options[select.selectedIndex];
    
    if (option && option.dataset.valor) {
        inputFinal.value = option.dataset.valor;
    } else {
        inputFinal.value = '';
    }
    calcularTotalItem(item);
}

// Converte string formato brasileiro para número
// "10.000" -> 10000
// "3,605" -> 3.605
function converterParaNumero(valor) {
    if (!valor) return 0;
    // Remove pontos de milhar e troca vírgula por ponto decimal
    return parseFloat(valor.toString().replace(/\./g, '').replace(',', '.')) || 0;
}

function calcularTotalItem(item) {
    const inputFinal = item.querySelector('.input-quantidade-final');
    const inputPreco = item.querySelector('.input-preco');
    const inputTotalNf = item.querySelector('.input-total-nf');
    
    // Quantidade vem como número puro do data-valor (ex: 10000)
    const quantidade = parseFloat(inputFinal.value) || 0;
    
    // Preço vem formatado em brasileiro (ex: 3,605)
    const preco = converterParaNumero(inputPreco.value);
    
    const total = quantidade * preco;
    
    if (total > 0) {
        inputTotalNf.value = formatarMoeda2(total);
    } else {
        inputTotalNf.value = '';
    }
}

// Formatar com 3 casas decimais (para preço unitário)
function formatarMoeda3(valor) {
    return valor.toLocaleString('pt-BR', {
        minimumFractionDigits: 3,
        maximumFractionDigits: 3
    });
}

// Formatar com 2 casas decimais (para total)
function formatarMoeda2(valor) {
    return valor.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Formatar input de preço com 3 casas decimais
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('input-preco')) {
        let value = e.target.value.replace(/\D/g, '');
        if (value) {
            value = (parseInt(value) / 1000).toFixed(3);
            e.target.value = formatarMoeda3(parseFloat(value));
        }
        // Recalcular o total
        const item = e.target.closest('.item-pedido');
        if (item) {
            calcularTotalItem(item);
        }
    }
});

// Validação antes de enviar
document.getElementById('formPedido').addEventListener('submit', function(e) {
    const itens = document.querySelectorAll('.item-pedido');
    let valido = true;
    
    itens.forEach(item => {
        const quantidade = item.querySelector('.input-quantidade-final').value;
        if (!quantidade || parseFloat(quantidade) <= 0) {
            valido = false;
        }
    });
    
    if (!valido) {
        e.preventDefault();
        alert('Por favor, preencha a quantidade de todos os itens.');
        return false;
    }
    
    // Converter valores de moeda para formato numérico antes de enviar
    document.querySelectorAll('.input-preco, .input-total-nf').forEach(input => {
        if (input.value) {
            input.value = input.value.replace(/\./g, '').replace(',', '.');
        }
    });
});

// Adicionar primeiro item automaticamente
document.addEventListener('DOMContentLoaded', function() {
    adicionarItem();
});
</script>
{% endblock %}
