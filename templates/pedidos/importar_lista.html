{% extends 'base.html' %}
{% block titulo %}Importar Pedido - Lista{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="card shadow-sm mb-3">
    <div class="card-header" style="background:#17a2b8;color:white;">
      <strong>Pedidos Pendentes para Importação</strong>
    </div>
    <div class="card-body">
      {% if not pedidos %}
        <p>Nenhum pedido pendente para importação.</p>
      {% else %}
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>#</th>
                <th>Número</th>
                <th>Data</th>
                <th>Motorista</th>
                <th>Veículo</th>
                <th>Itens</th>
                <th>Quantidade total</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for p in pedidos %}
              <tr>
                <td>{{ p.id }}</td>
                <td>{{ p.numero }}</td>
                <td>{{ p.data_pedido.strftime('%d/%m/%Y') if p.data_pedido else '' }}</td>
                <td>{{ p.motorista_nome or '-' }}</td>
                <td>{{ p.veiculo_nome or '-' }}</td>
                <td>{{ p.total_itens or 0 }}</td>
                <td>{{ '{:,.0f}'.format(p.total_quantidade).replace(',', '.') if p.total_quantidade else '0' }}</td>
                <td class="text-end">
                  <!-- Link para abrir o detalhe do pedido (importar-pedido) -->
                  <a href="{{ url_for('pedidos.importar_pedido', id=p.id) }}" class="btn btn-sm btn-primary btn-importar" data-id="{{ p.id }}">Abrir</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
/*
  Script que permite, quando este template for carregado via fetch (no modal container),
  interceptar cliques em links "Abrir" e carregar o detalhe do pedido (importar-pedido) no mesmo container.
*/
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.btn-importar').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const href = this.getAttribute('href');
      // Se existe container modalImportacaoContainer, carregar via fetch nele
      const container = document.getElementById('modalImportacaoContainer');
      if (container) {
        fetch(href, {credentials: 'same-origin'}).then(r => {
          if (!r.ok) throw new Error('Erro ao carregar pedido: ' + r.status);
          return r.text();
        }).then(html => {
          container.innerHTML = html;
          // executar scripts inline caso existam (simplificado)
          const scripts = container.querySelectorAll('script');
          scripts.forEach(s => {
            if (!s.src) {
              try { (0, eval)(s.innerText); } catch (err) { console.error('Erro ao executar script inline do importador:', err); }
            } else {
              const script = document.createElement('script');
              script.src = s.src;
              document.head.appendChild(script);
            }
          });
          // tentar abrir modal se houver #modalImportarPedido
          const modalEl = container.querySelector('#modalImportarPedido');
          if (modalEl && window.bootstrap && bootstrap.Modal) {
            new bootstrap.Modal(modalEl, {backdrop: 'static'}).show();
          } else if (modalEl && window.jQuery) {
            jQuery(modalEl).modal('show');
          } else {
            container.scrollIntoView({behavior:'smooth'});
          }
        }).catch(err => {
          console.error(err);
          alert('Erro ao carregar pedido: ' + err.message);
        });
      } else {
        // fallback: navegar normalmente
        window.location.href = href;
      }
    });
  });
});
</script>
{% endblock %}
