{% extends "base.html" %}

{% block title %}Pedido {{ pedido.numero }} - NH Transportes{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col">
            <h2><i class="bi bi-cart"></i> Pedido {{ pedido.numero }}</h2>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('pedidos.editar', id=pedido.id) }}" class="btn btn-warning">
                <i class="bi bi-pencil"></i> Editar
            </a>
            <a href="{{ url_for('pedidos.index') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <!-- Dados do Pedido -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <span><i class="bi bi-info-circle"></i> Dados do Pedido</span>
            <span class="badge bg-{{ 'warning text-dark' if pedido.status == 'Pendente' else 'success' if pedido.status == 'Confirmado' else 'info' if pedido.status == 'Faturado' else 'danger' }}">
                {{ pedido.status }}
            </span>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-2">
                    <strong>N√∫mero:</strong> {{ pedido.numero }}
                </div>
                <div class="col-md-2">
                    <strong>Data:</strong> {{ pedido.data_pedido.strftime('%d/%m/%Y') if pedido.data_pedido else '' }}
                </div>
                <div class="col-md-2">
                    <strong>Motorista:</strong> {{ pedido.motorista_nome or 'N√£o definido' }}
                </div>
                <div class="col-md-3">
                    <strong>Total Quantidade:</strong> {{ "{:,.2f}".format(total_quantidade).replace(',', 'X').replace('.', ',').replace('X', '.') }} m¬≥
                </div>
                <div class="col-md-3">
                    <strong>Total Valor:</strong> R$ {{ "{:,.2f}".format(total_valor).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                </div>
            </div>
            {% if pedido.observacoes %}
            <div class="row mt-2">
                <div class="col-12">
                    <strong>Observa√ß√µes:</strong> {{ pedido.observacoes }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Alterar Status -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <i class="bi bi-arrow-repeat"></i> Alterar Status
        </div>
        <div class="card-body">
            <a href="{{ url_for('pedidos.alterar_status', id=pedido.id, status='Pendente') }}" 
               class="btn btn-outline-warning {{ 'active' if pedido.status == 'Pendente' else '' }}">
                <i class="bi bi-clock"></i> Pendente
            </a>
            <a href="{{ url_for('pedidos.alterar_status', id=pedido.id, status='Confirmado') }}" 
               class="btn btn-success {{ 'active' if pedido.status == 'Confirmado' else '' }}">
                <i class="bi bi-check-circle"></i> Confirmado
            </a>
            <a href="{{ url_for('pedidos.alterar_status', id=pedido.id, status='Faturado') }}" 
               class="btn btn-info {{ 'active' if pedido.status == 'Faturado' else '' }}">
                <i class="bi bi-file-earmark-text"></i> Faturado
            </a>
            <a href="{{ url_for('pedidos.alterar_status', id=pedido.id, status='Cancelado') }}" 
               class="btn btn-outline-danger {{ 'active' if pedido.status == 'Cancelado' else '' }}">
                <i class="bi bi-x-circle"></i> Cancelado
            </a>
        </div>
    </div>

    <!-- Copiar para WhatsApp -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <i class="bi bi-whatsapp"></i> Copiar para WhatsApp
        </div>
        <div class="card-body">
            <button type="button" class="btn btn-outline-success" onclick="copiarTudo()">
                <i class="bi bi-clipboard"></i> Copiar Tudo
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="copiarPorFornecedor()">
                <i class="bi bi-building"></i> Copiar por Fornecedor
            </button>
            
            <div class="mt-3">
                <strong>Copiar clientes individuais:</strong>
                <div class="mt-2">
                    {% for item in itens %}
                    <button type="button" class="btn btn-outline-secondary btn-sm mb-1" 
                            onclick="copiarCliente('{{ item.cliente_fantasia or item.cliente_razao }}', '{{ item.cliente_cnpj }}', '{{ item.produto_nome }}', '{{ item.fornecedor_fantasia or item.fornecedor_razao }}', '{{ item.origem_nome }}', {{ item.quantidade }}, {{ item.preco_unitario }}, {{ item.total_nf }})">
                        {{ item.cliente_fantasia or item.cliente_razao }}
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Itens do Pedido -->
    <div class="card mb-4">
        <div class="card-header bg-warning">
            <i class="bi bi-list-ul"></i> Itens do Pedido
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Cliente</th>
                            <th>CNPJ</th>
                            <th>Produto</th>
                            <th>Fornecedor</th>
                            <th>Origem</th>
                            <th class="text-end">Qtd</th>
                            <th class="text-end">Pre√ßo</th>
                            <th class="text-end">Total NF</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in itens %}
                        <tr>
                            <td>{{ item.cliente_fantasia or item.cliente_razao }}</td>
                            <td>{{ item.cliente_cnpj }}</td>
                            <td>{{ item.produto_nome }}</td>
                            <td>{{ item.fornecedor_fantasia or item.fornecedor_razao }}</td>
                            <td>{{ item.origem_nome }}</td>
                            <td class="text-end">{{ "{:,.2f}".format(item.quantidade).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                            <td class="text-end">R$ {{ "{:,.3f}".format(item.preco_unitario).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                            <td class="text-end">R$ {{ "{:,.2f}".format(item.total_nf).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-secondary">
                        <tr>
                            <th colspan="5" class="text-end">TOTAIS:</th>
                            <th class="text-end">{{ "{:,.2f}".format(total_quantidade).replace(',', 'X').replace('.', ',').replace('X', '.') }}</th>
                            <th></th>
                            <th class="text-end">R$ {{ "{:,.2f}".format(total_valor).replace(',', 'X').replace('.', ',').replace('X', '.') }}</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Itens por Fornecedor -->
    {% for fornecedor, itens_forn in itens_por_fornecedor.items() %}
    <div class="card mb-3">
        <div class="card-header bg-info text-white">
            <i class="bi bi-building"></i> {{ fornecedor }}
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm mb-0">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>CNPJ</th>
                            <th>Produto</th>
                            <th>Origem</th>
                            <th class="text-end">Qtd</th>
                            <th class="text-end">Pre√ßo</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in itens_forn %}
                        <tr>
                            <td>{{ item.cliente_fantasia or item.cliente_razao }}</td>
                            <td>{{ item.cliente_cnpj }}</td>
                            <td>{{ item.produto_nome }}</td>
                            <td>{{ item.origem_nome }}</td>
                            <td class="text-end">{{ "{:,.2f}".format(item.quantidade).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                            <td class="text-end">R$ {{ "{:,.3f}".format(item.preco_unitario).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                            <td class="text-end">R$ {{ "{:,.2f}".format(item.total_nf).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
var pedidoNumero = "{{ pedido.numero }}";
var pedidoData = "{{ pedido.data_pedido.strftime('%d/%m/%Y') if pedido.data_pedido else '' }}";
var pedidoMotorista = "{{ pedido.motorista_nome or 'N√£o definido' }}";

var itens = [
    {% for item in itens %}
    {
        cliente: "{{ item.cliente_fantasia or item.cliente_razao }}",
        cnpj: "{{ item.cliente_cnpj }}",
        produto: "{{ item.produto_nome }}",
        fornecedor: "{{ item.fornecedor_fantasia or item.fornecedor_razao }}",
        origem: "{{ item.origem_nome }}",
        quantidade: {{ item.quantidade }},
        preco: {{ item.preco_unitario }},
        total: {{ item.total_nf }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

var itensPorFornecedor = {
    {% for fornecedor, itens_forn in itens_por_fornecedor.items() %}
    "{{ fornecedor }}": [
        {% for item in itens_forn %}
        {
            cliente: "{{ item.cliente_fantasia or item.cliente_razao }}",
            cnpj: "{{ item.cliente_cnpj }}",
            produto: "{{ item.produto_nome }}",
            origem: "{{ item.origem_nome }}",
            quantidade: {{ item.quantidade }},
            preco: {{ item.preco_unitario }},
            total: {{ item.total_nf }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]{% if not loop.last %},{% endif %}
    {% endfor %}
};

function formatarNumero(valor, casas) {
    casas = casas || 2;
    return valor.toLocaleString('pt-BR', {
        minimumFractionDigits: casas,
        maximumFractionDigits: casas
    });
}

function copiarTexto(texto) {
    navigator.clipboard.writeText(texto).then(function() {
        alert('Copiado para a √°rea de transfer√™ncia!');
    }).catch(function(err) {
        var textarea = document.createElement('textarea');
        textarea.value = texto;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('Copiado para a √°rea de transfer√™ncia!');
    });
}

function copiarTudo() {
    var texto = '*PEDIDO ' + pedidoNumero + '*\n';
    texto += 'Data: ' + pedidoData + '\n';
    texto += 'Motorista: ' + pedidoMotorista + '\n\n';
    
    for (var fornecedor in itensPorFornecedor) {
        var itensF = itensPorFornecedor[fornecedor];
        texto += '*' + fornecedor + '*\n';
        texto += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
        
        var subtotalQtd = 0;
        var subtotalValor = 0;
        
        for (var i = 0; i < itensF.length; i++) {
            var item = itensF[i];
            texto += 'üìç ' + item.cliente + '\n';
            texto += '   CNPJ: ' + item.cnpj + '\n';
            texto += '   Produto: ' + item.produto + '\n';
            texto += '   Origem: ' + item.origem + '\n';
            texto += '   Qtd: ' + formatarNumero(item.quantidade) + ' | R$ ' + formatarNumero(item.preco, 3) + '\n';
            texto += '   Total: R$ ' + formatarNumero(item.total) + '\n\n';
            
            subtotalQtd += item.quantidade;
            subtotalValor += item.total;
        }
        
        texto += '*Subtotal ' + fornecedor + ':*\n';
        texto += 'Qtd: ' + formatarNumero(subtotalQtd) + ' | Valor: R$ ' + formatarNumero(subtotalValor) + '\n\n';
    }
    
        var totalQtd = 0;
    var totalValor = 0;
    for (var j = 0; j < itens.length; j++) {
        totalQtd += itens[j].quantidade;
        totalValor += itens[j].total;
    }
    
    texto += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
    texto += '*TOTAL GERAL:*\n';
    texto += 'Quantidade: ' + formatarNumero(totalQtd) + ' m¬≥\n';
    texto += 'Valor: R$ ' + formatarNumero(totalValor);
    
    copiarTexto(texto);
}

function copiarPorFornecedor() {
    var texto = '*PEDIDO ' + pedidoNumero + '*\n';
    texto += 'Data: ' + pedidoData + '\n';
    texto += 'Motorista: ' + pedidoMotorista + '\n\n';
    texto += '*RESUMO POR FORNECEDOR:*\n\n';
    
    for (var fornecedor in itensPorFornecedor) {
        var itensF = itensPorFornecedor[fornecedor];
        var subtotalQtd = 0;
        var subtotalValor = 0;
        
        for (var i = 0; i < itensF.length; i++) {
            subtotalQtd += itensF[i].quantidade;
            subtotalValor += itensF[i].total;
        }
        
        texto += '*' + fornecedor + '*\n';
        texto += 'Qtd: ' + formatarNumero(subtotalQtd) + ' m¬≥\n';
        texto += 'Valor: R$ ' + formatarNumero(subtotalValor) + '\n\n';
    }
    
    var totalQtd = 0;
    var totalValor = 0;
    for (var j = 0; j < itens.length; j++) {
        totalQtd += itens[j].quantidade;
        totalValor += itens[j].total;
    }
    
    texto += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
    texto += '*TOTAL GERAL:*\n';
    texto += 'Quantidade: ' + formatarNumero(totalQtd) + ' m¬≥\n';
    texto += 'Valor: R$ ' + formatarNumero(totalValor);
    
    copiarTexto(texto);
}

function copiarCliente(cliente, cnpj, produto, fornecedor, origem, quantidade, preco, total) {
    var texto = '*PEDIDO ' + pedidoNumero + '*\n';
    texto += 'Data: ' + pedidoData + '\n';
    texto += 'Motorista: ' + pedidoMotorista + '\n\n';
    texto += 'üìç *' + cliente + '*\n';
    texto += 'CNPJ: ' + cnpj + '\n';
    texto += 'Produto: ' + produto + '\n';
    texto += 'Fornecedor: ' + fornecedor + '\n';
    texto += 'Origem: ' + origem + '\n';
    texto += 'Quantidade: ' + formatarNumero(quantidade) + ' m¬≥\n';
    texto += 'Pre√ßo: R$ ' + formatarNumero(preco, 3) + '\n';
    texto += 'Total NF: R$ ' + formatarNumero(total);
    
    copiarTexto(texto);
}
</script>
{% endblock %}

