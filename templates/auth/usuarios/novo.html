{% extends 'base.html' %}

{% block title %}Criar Novo Usu√°rio - NH Transportes{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-person-plus"></i> Criar Novo Usu√°rio</h2>
            <p class="text-muted">Preencha os dados do novo usu√°rio</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 col-md-10">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Dados do Usu√°rio</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username *</label>
                            <input type="text" class="form-control" id="username" name="username" required
                                   placeholder="Ex: joao.silva">
                            <small class="form-text text-muted">Nome de usu√°rio para login (√∫nico)</small>
                        </div>

                        <div class="mb-3">
                            <label for="nome_completo" class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="nome_completo" name="nome_completo" required
                                   placeholder="Ex: Jo√£o Silva">
                        </div>

                        <div class="mb-3">
                            <label for="nivel" class="form-label">
                                N√≠vel de Acesso *
                                <button type="button" class="btn btn-sm btn-outline-info ms-2" data-bs-toggle="collapse" data-bs-target="#permissoesDetalhadas" aria-expanded="false" aria-controls="permissoesDetalhadas" aria-label="Ver ou ocultar comparativo detalhado de permiss√µes">
                                    <i class="bi bi-info-circle"></i> Ver Comparativo de Permiss√µes
                                </button>
                            </label>
                            <select class="form-select" id="nivel" name="nivel" required onchange="toggleClienteField()">
                                <option value="">Selecione...</option>
                                <option value="ADMIN">ADMIN - Acesso Total ao Sistema</option>
                                <option value="GERENTE">GERENTE - Gest√£o de M√∫ltiplos Postos</option>
                                <option value="SUPERVISOR">SUPERVISOR - Supervis√£o de Posto(s)</option>
                                <option value="PISTA">PISTA - Opera√ß√£o de Posto (Limitado)</option>
                            </select>
                            
                            <!-- Descri√ß√µes resumidas -->
                            <small class="form-text text-muted">
                                <strong>ADMIN:</strong> Todas as permiss√µes<br>
                                <strong>GERENTE:</strong> Gerencia usu√°rios PISTA/SUPERVISOR, acesso a todos os postos, pode excluir transa√ß√µes<br>
                                <strong>SUPERVISOR:</strong> Supervisiona posto(s) espec√≠fico(s), edita sem limite de tempo, n√£o gerencia usu√°rios<br>
                                <strong>PISTA:</strong> Opera√ß√£o b√°sica, apenas seu posto, limite 15 min para edi√ß√£o
                            </small>
                            
                            <!-- Se√ß√£o expans√≠vel com comparativo detalhado -->
                            <div class="collapse mt-3" id="permissoesDetalhadas">
                                <div class="card card-body bg-light">
                                    <h6 class="mb-3"><i class="bi bi-table"></i> Comparativo Detalhado de Permiss√µes</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <thead class="table-secondary">
                                                <tr>
                                                    <th>Permiss√£o</th>
                                                    <th class="text-center"><span aria-label="ADMIN - Administrador">üî¥ ADMIN</span></th>
                                                    <th class="text-center"><span aria-label="GERENTE - Gerente de Opera√ß√µes">üü° GERENTE</span></th>
                                                    <th class="text-center"><span aria-label="SUPERVISOR - Supervisor de Posto">üîµ SUPERVISOR</span></th>
                                                    <th class="text-center"><span aria-label="PISTA - Operador">‚ö™ PISTA</span></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td><strong>Gerenciar Usu√°rios</strong></td>
                                                    <td class="text-center">‚úÖ Todos</td>
                                                    <td class="text-center">‚ö†Ô∏è Apenas PISTA e SUPERVISOR</td>
                                                    <td class="text-center">‚ùå N√£o</td>
                                                    <td class="text-center">‚ùå N√£o</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Visualizar Todos os Postos</strong></td>
                                                    <td class="text-center">‚úÖ Sim</td>
                                                    <td class="text-center">‚úÖ Sim</td>
                                                    <td class="text-center">‚ùå Apenas associados</td>
                                                    <td class="text-center">‚ùå Apenas o seu</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Editar Transa√ß√µes</strong></td>
                                                    <td class="text-center">‚úÖ Sem limite</td>
                                                    <td class="text-center">‚úÖ Sem limite</td>
                                                    <td class="text-center">‚úÖ Sem limite</td>
                                                    <td class="text-center">‚è±Ô∏è At√© 15 minutos</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Excluir Transa√ß√µes</strong></td>
                                                    <td class="text-center">‚úÖ Sim</td>
                                                    <td class="text-center">‚úÖ Sim</td>
                                                    <td class="text-center">‚ùå N√£o</td>
                                                    <td class="text-center">‚ùå N√£o</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Posto Associado</strong></td>
                                                    <td class="text-center">‚ûñ N√£o necess√°rio</td>
                                                    <td class="text-center">üîÑ Opcional</td>
                                                    <td class="text-center">‚úÖ Obrigat√≥rio</td>
                                                    <td class="text-center">‚úÖ Obrigat√≥rio</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle"></i> 
                                            <strong>Dica:</strong> Clique novamente no bot√£o acima para ocultar esta tabela.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3" id="cliente_field" style="display:none;">
                            <label for="cliente_ids" class="form-label">Posto/Cliente Associado *</label>
                            <select class="form-select" id="cliente_ids" name="cliente_ids" multiple size="5">
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.razao_social }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">
                                <strong>PISTA:</strong> Selecione UM posto espec√≠fico (obrigat√≥rio)<br>
                                <strong>SUPERVISOR/GERENTE:</strong> Selecione um ou mais postos (use Ctrl/Cmd + clique para m√∫ltiplos)<br>
                                <strong>Dica:</strong> Para selecionar m√∫ltiplos, segure Ctrl (Windows/Linux) ou Cmd (Mac) e clique
                            </small>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label for="senha" class="form-label">Senha *</label>
                            <input type="password" class="form-control" id="senha" name="senha" required
                                   minlength="4" placeholder="M√≠nimo 4 caracteres">
                        </div>

                        <div class="mb-3">
                            <label for="confirmar_senha" class="form-label">Confirmar Senha *</label>
                            <input type="password" class="form-control" id="confirmar_senha" name="confirmar_senha" required
                                   minlength="4" placeholder="Digite a senha novamente">
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{{ url_for('auth.listar_usuarios') }}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> Criar Usu√°rio
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleClienteField() {
    var nivel = document.getElementById('nivel').value;
    var clienteField = document.getElementById('cliente_field');
    var clienteSelect = document.getElementById('cliente_ids');
    
    // SUPERVISOR, GERENTE e PISTA precisam de posto associado
    if (nivel === 'PISTA' || nivel === 'SUPERVISOR' || nivel === 'GERENTE') {
        clienteField.style.display = 'block';
        // PISTA √© obrigat√≥rio, SUPERVISOR e GERENTE tamb√©m requerem sele√ß√£o
        clienteSelect.required = true;
    } else {
        clienteField.style.display = 'none';
        clienteSelect.required = false;
        // Limpar sele√ß√µes
        for (var i = 0; i < clienteSelect.options.length; i++) {
            clienteSelect.options[i].selected = false;
        }
    }
}

// Validar senhas e sele√ß√£o de clientes antes de enviar
document.querySelector('form').addEventListener('submit', function(e) {
    var senha = document.getElementById('senha').value;
    var confirmar = document.getElementById('confirmar_senha').value;
    
    if (senha !== confirmar) {
        e.preventDefault();
        alert('As senhas n√£o coincidem!');
        return false;
    }
    
    // Validar sele√ß√£o de clientes para PISTA
    var nivel = document.getElementById('nivel').value;
    var clienteSelect = document.getElementById('cliente_ids');
    var selectedOptions = Array.from(clienteSelect.selectedOptions);
    
    if (nivel === 'PISTA' && selectedOptions.length > 1) {
        e.preventDefault();
        alert('Usu√°rios PISTA devem ter apenas UM posto associado. Voc√™ selecionou ' + selectedOptions.length + ' postos.');
        return false;
    }
    
    if ((nivel === 'PISTA' || nivel === 'SUPERVISOR' || nivel === 'GERENTE') && selectedOptions.length === 0) {
        e.preventDefault();
        alert('Selecione pelo menos um posto/cliente para este n√≠vel de usu√°rio.');
        return false;
    }
});
</script>
{% endblock %}
