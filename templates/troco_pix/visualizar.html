{% extends "base.html" %}

{% block title %}Visualizar Troco PIX #{{ transacao.id }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-12">
            <h2><i class="bi bi-eye"></i> Visualizar Solicitação de Troco PIX #{{ transacao.id }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('troco_pix.listar') }}">Troco PIX</a></li>
                    <li class="breadcrumb-item active">Visualizar #{{ transacao.id }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Botões de ação -->
    <div class="row mb-3">
        <div class="col-md-12">
            <button type="button" class="btn btn-success" id="btnCopyWhatsApp">
                <i class="bi bi-whatsapp"></i> Copiar para WhatsApp
            </button>
            <a href="{{ url_for('troco_pix.editar', troco_pix_id=transacao.id) }}" class="btn btn-warning">
                <i class="bi bi-pencil"></i> Editar
            </a>
            <a href="{{ url_for('troco_pix.listar') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <!-- Informações Gerais -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <i class="bi bi-info-circle"></i> Informações Gerais
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <th width="40%">Data:</th>
                            <td>{{ transacao.data.strftime('%d/%m/%Y') if transacao.data else '-' }}</td>
                        </tr>
                        <tr>
                            <th>Posto/Cliente:</th>
                            <td>{{ transacao.posto_nome or '-' }}</td>
                        </tr>
                        <tr>
                            <th>Status:</th>
                            <td>
                                {% if transacao.status == 'PENDENTE' %}
                                    <span class="badge bg-warning">Pendente</span>
                                {% elif transacao.status == 'PROCESSADO' %}
                                    <span class="badge bg-success">Processado</span>
                                {% elif transacao.status == 'CANCELADO' %}
                                    <span class="badge bg-danger">Cancelado</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <th width="40%">Frentista:</th>
                            <td>{{ transacao.frentista_nome or '-' }}</td>
                        </tr>
                        <tr>
                            <th>Importado:</th>
                            <td>
                                {% if transacao.importado_lancamento_caixa %}
                                    <span class="badge bg-success">Sim</span>
                                    {% if transacao.lancamento_caixa_id %}
                                        (Lançamento #{{ transacao.lancamento_caixa_id }})
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-secondary">Não</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Criado em:</th>
                            <td>{{ transacao.criado_em.strftime('%d/%m/%Y %H:%M') if transacao.criado_em else '-' }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- VENDA -->
    <div class="card mb-3">
        <div class="card-header bg-success text-white">
            <i class="bi bi-cart"></i> VENDA
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Descrição</th>
                        <th class="text-end">Valor</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Abastecimento</td>
                        <td class="text-end">{{ (transacao.venda_abastecimento or 0)|formatar_moeda }}</td>
                    </tr>
                    <tr>
                        <td>Arla</td>
                        <td class="text-end">{{ (transacao.venda_arla or 0)|formatar_moeda }}</td>
                    </tr>
                    <tr>
                        <td>Produtos</td>
                        <td class="text-end">{{ (transacao.venda_produtos or 0)|formatar_moeda }}</td>
                    </tr>
                    <tr class="table-success">
                        <th>TOTAL</th>
                        <th class="text-end">{{ (transacao.venda_total or 0)|formatar_moeda }}</th>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- CHEQUE -->
    <div class="card mb-3">
        <div class="card-header bg-warning">
            <i class="bi bi-wallet2"></i> CHEQUE
        </div>
        <div class="card-body">
            <table class="table table-borderless">
                <tr>
                    <th width="30%">Tipo:</th>
                    <td>
                        {% if transacao.cheque_tipo == 'A_VISTA' %}
                            À Vista
                        {% elif transacao.cheque_tipo == 'A_PRAZO' %}
                            A Prazo
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% if transacao.cheque_tipo == 'A_PRAZO' and transacao.cheque_data_vencimento %}
                <tr>
                    <th>Data de Vencimento:</th>
                    <td>{{ transacao.cheque_data_vencimento.strftime('%d/%m/%Y') }}</td>
                </tr>
                {% endif %}
                <tr>
                    <th>Valor do Cheque:</th>
                    <td class="text-end" style="font-size: 1.2em; font-weight: bold;">
                        {{ (transacao.cheque_valor or 0)|formatar_moeda }}
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <!-- TROCO -->
    <div class="card mb-3">
        <div class="card-header bg-info text-white">
            <i class="bi bi-arrow-left-right"></i> TROCO
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Tipo de Troco</th>
                        <th class="text-end">Valor</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Troco em Espécie</td>
                        <td class="text-end">{{ (transacao.troco_especie or 0)|formatar_moeda }}</td>
                    </tr>
                    <tr>
                        <td>Troco PIX</td>
                        <td class="text-end">{{ (transacao.troco_pix or 0)|formatar_moeda }}</td>
                    </tr>
                    <tr>
                        <td>Crédito Vda Programada</td>
                        <td class="text-end">{{ (transacao.troco_credito_vda_programada or 0)|formatar_moeda }}</td>
                    </tr>
                    <tr class="table-info">
                        <th>TOTAL</th>
                        <th class="text-end">{{ (transacao.troco_total or 0)|formatar_moeda }}</th>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- DESTINATÁRIO PIX -->
    <div class="card mb-3">
        <div class="card-header bg-secondary text-white">
            <i class="bi bi-person"></i> Destinatário do PIX
        </div>
        <div class="card-body">
            <table class="table table-borderless">
                <tr>
                    <th width="30%">Nome Completo:</th>
                    <td>{{ transacao.cliente_pix_nome or '-' }}</td>
                </tr>
                <tr>
                    <th>Tipo de Chave PIX:</th>
                    <td>{{ transacao.tipo_chave_pix or '-' }}</td>
                </tr>
                <tr>
                    <th>Chave PIX:</th>
                    <td style="font-family: monospace; font-size: 1.1em;">{{ transacao.chave_pix or '-' }}</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- RESUMO FINANCEIRO -->
    <div class="card mb-3">
        <div class="card-header bg-dark text-white">
            <i class="bi bi-calculator"></i> Resumo Financeiro
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="card text-white bg-success mb-3">
                        <div class="card-body text-center">
                            <h5>Total Venda</h5>
                            <h3>{{ (transacao.venda_total or 0)|formatar_moeda }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-warning mb-3">
                        <div class="card-body text-center">
                            <h5>Valor Cheque</h5>
                            <h3>{{ (transacao.cheque_valor or 0)|formatar_moeda }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-info mb-3">
                        <div class="card-body text-center">
                            <h5>Total Troco</h5>
                            <h3>{{ (transacao.troco_total or 0)|formatar_moeda }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            
            {% set diferenca = (transacao.cheque_valor or 0) - (transacao.venda_total or 0) %}
            <div class="alert {% if diferenca == (transacao.troco_total or 0) %}alert-success{% else %}alert-danger{% endif %}">
                <strong>Verificação:</strong>
                Diferença (Cheque - Venda) = {{ diferenca|formatar_moeda }}
                {% if diferenca == (transacao.troco_total or 0) %}
                    <i class="bi bi-check-circle"></i> Valores conferem!
                {% else %}
                    <i class="bi bi-exclamation-triangle"></i> Valores não conferem!
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnCopyWhatsApp = document.getElementById('btnCopyWhatsApp');
    const FEEDBACK_TIMEOUT = 2000; // milliseconds
    
    if (btnCopyWhatsApp) {
        btnCopyWhatsApp.addEventListener('click', function() {
            // Helper function to format currency values
            function formatCurrency(value) {
                if (!value || value === 0 || value === '0') {
                    return '';
                }
                // Convert to number if string
                let num = typeof value === 'string' ? parseFloat(value) : value;
                // Format with thousand separator (.) and decimal (,)
                return num.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
            
            // Function to show success feedback
            function showSuccessFeedback() {
                const originalText = btnCopyWhatsApp.innerHTML;
                btnCopyWhatsApp.innerHTML = '<i class="bi bi-check-circle"></i> Copiado!';
                btnCopyWhatsApp.classList.remove('btn-success');
                btnCopyWhatsApp.classList.add('btn-info');
                
                setTimeout(function() {
                    btnCopyWhatsApp.innerHTML = originalText;
                    btnCopyWhatsApp.classList.remove('btn-info');
                    btnCopyWhatsApp.classList.add('btn-success');
                }, FEEDBACK_TIMEOUT);
            }
            
            // Get transaction data - using tojson for safe escaping
            const data = {
                data: {{ transacao.data.strftime("%d/%m/%Y")|tojson if transacao.data else '""'|safe }},
                venda_abastecimento: {{ transacao.venda_abastecimento or 0 }},
                venda_arla: {{ transacao.venda_arla or 0 }},
                venda_produtos: {{ transacao.venda_produtos or 0 }},
                venda_total: {{ transacao.venda_total or 0 }},
                cheque_tipo: {{ transacao.cheque_tipo|tojson if transacao.cheque_tipo else '""'|safe }},
                cheque_data_vencimento: {{ transacao.cheque_data_vencimento.strftime("%d/%m/%Y")|tojson if transacao.cheque_data_vencimento else '""'|safe }},
                cheque_valor: {{ transacao.cheque_valor or 0 }},
                troco_especie: {{ transacao.troco_especie or 0 }},
                troco_pix: {{ transacao.troco_pix or 0 }},
                troco_credito: {{ transacao.troco_credito_vda_programada or 0 }},
                troco_total: {{ transacao.troco_total or 0 }},
                cliente_pix_nome: {{ transacao.cliente_pix_nome|tojson if transacao.cliente_pix_nome else '""'|safe }},
                tipo_chave_pix: {{ transacao.tipo_chave_pix|tojson if transacao.tipo_chave_pix else '""'|safe }},
                chave_pix: {{ transacao.chave_pix|tojson if transacao.chave_pix else '""'|safe }},
                frentista_nome: {{ transacao.frentista_nome|tojson if transacao.frentista_nome else '""'|safe }}
            };
            
            // Build WhatsApp message
            let message = 'TROCO PIX\n';
            message += 'DATA: ' + data.data + '\n\n';
            
            message += 'VENDA\n';
            message += 'Abastecimento: ' + (formatCurrency(data.venda_abastecimento) || '') + '\n';
            message += 'Arla: ' + (formatCurrency(data.venda_arla) || '') + '\n';
            message += 'Produtos: ' + (formatCurrency(data.venda_produtos) || '') + '\n';
            message += 'TOTAL = ' + formatCurrency(data.venda_total) + '\n\n';
            
            // CHEQUE section
            if (data.cheque_tipo === 'A_VISTA') {
                message += 'CHEQUE A VISTA\n';
            } else if (data.cheque_tipo === 'A_PRAZO') {
                message += 'CHEQUE A PRAZO';
                if (data.cheque_data_vencimento) {
                    message += ' - Data: ' + data.cheque_data_vencimento;
                }
                message += '\n';
            }
            message += 'Valor do cheque: ' + formatCurrency(data.cheque_valor) + '\n\n';
            
            message += 'TROCO\n';
            message += 'Troco em Espécie: ' + (formatCurrency(data.troco_especie) || '') + '\n';
            message += 'Credito Vda Programada: ' + (formatCurrency(data.troco_credito) || '') + '\n';
            message += 'TOTAL = ' + formatCurrency(data.troco_total) + '\n\n';
            
            message += 'TROCO PIX = ' + formatCurrency(data.troco_pix) + '\n';
            // Only show chave info if there's actual data
            if (data.chave_pix) {
                message += 'Chave Pix: ' + (data.tipo_chave_pix ? data.tipo_chave_pix + ' - ' : '') + data.chave_pix + '\n';
            } else {
                message += 'Chave Pix: \n';
            }
            message += 'Nome do Cliente: ' + (data.cliente_pix_nome || '') + '\n\n';
            
            message += 'Frentista: ' + (data.frentista_nome || '');
            
            // Copy to clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(message).then(function() {
                    showSuccessFeedback();
                }).catch(function(err) {
                    alert('Erro ao copiar: ' + err);
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = message;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showSuccessFeedback();
                } catch (err) {
                    alert('Erro ao copiar: ' + err);
                }
                document.body.removeChild(textArea);
            }
        });
    }
});
</script>
{% endblock %}
