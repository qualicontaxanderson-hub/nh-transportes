{% extends "base.html" %}

{% block title %}Visualizar Troco PIX #{{ transacao.id }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-12">
            <h2><i class="bi bi-eye"></i> Visualizar Solicita√ß√£o de Troco PIX #{{ transacao.id }}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    {% if request.args.get('origem') == 'pista' %}
                    <li class="breadcrumb-item"><a href="{{ url_for('troco_pix.pista') }}">Troco PIX Pista</a></li>
                    {% else %}
                    <li class="breadcrumb-item"><a href="{{ url_for('troco_pix.listar') }}">Troco PIX</a></li>
                    {% endif %}
                    <li class="breadcrumb-item active">Visualizar #{{ transacao.id }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Bot√µes de a√ß√£o -->
    <div class="row mb-3">
        <div class="col-md-12">
            <button type="button" class="btn btn-success" id="btnCopyWhatsApp">
                <i class="bi bi-whatsapp"></i> Copiar para WhatsApp
            </button>
            <a href="{{ url_for('troco_pix.editar', troco_pix_id=transacao.id, origem=request.args.get('origem')) }}" class="btn btn-warning">
                <i class="bi bi-pencil"></i> Editar
            </a>
            {% if request.args.get('origem') == 'pista' %}
            <a href="{{ url_for('troco_pix.pista') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
            {% else %}
            <a href="{{ url_for('troco_pix.listar') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Informa√ß√µes Gerais -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <i class="bi bi-info-circle"></i> Informa√ß√µes Gerais
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <th width="40%">N√∫mero:</th>
                            <td><strong>{{ transacao.numero_sequencial or '-' }}</strong></td>
                        </tr>
                        <tr>
                            <th width="40%">Data:</th>
                            <td>{{ transacao.data.strftime('%d/%m/%Y') if transacao.data else '-' }}</td>
                        </tr>
                        <tr>
                            <th>Posto/Cliente:</th>
                            <td>{{ transacao.posto_nome or '-' }}</td>
                        </tr>
                        <tr>
                            <th>Status:</th>
                            <td>
                                {% if transacao.status == 'PENDENTE' %}
                                    <span class="badge bg-warning">Pendente</span>
                                {% elif transacao.status == 'PROCESSADO' %}
                                    <span class="badge bg-success">Processado</span>
                                {% elif transacao.status == 'CANCELADO' %}
                                    <span class="badge bg-danger">Cancelado</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <th width="40%">Frentista:</th>
                            <td>{{ transacao.frentista_nome or '-' }}</td>
                        </tr>
                        <tr>
                            <th>Importado:</th>
                            <td>
                                {% if transacao.importado_lancamento_caixa %}
                                    <span class="badge bg-success">Sim</span>
                                    {% if transacao.lancamento_caixa_id %}
                                        (Lan√ßamento #{{ transacao.lancamento_caixa_id }})
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-secondary">N√£o</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Criado em:</th>
                            <td>{{ transacao.criado_em.strftime('%d/%m/%Y %H:%M') if transacao.criado_em else '-' }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- VENDA -->
    <div class="card mb-3">
        <div class="card-header bg-success text-white">
            <i class="bi bi-cart"></i> VENDA
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Descri√ß√£o</th>
                        <th class="text-end">Valor</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Abastecimento</td>
                        <td class="text-end">{{ (transacao.venda_abastecimento or 0)|formatar_moeda }}</td>
                    </tr>
                    <tr>
                        <td>Arla</td>
                        <td class="text-end">{{ (transacao.venda_arla or 0)|formatar_moeda }}</td>
                    </tr>
                    <tr>
                        <td>Produtos</td>
                        <td class="text-end">{{ (transacao.venda_produtos or 0)|formatar_moeda }}</td>
                    </tr>
                    <tr class="table-success">
                        <th>TOTAL</th>
                        <th class="text-end">{{ (transacao.venda_total or 0)|formatar_moeda }}</th>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- CHEQUE -->
    <div class="card mb-3">
        <div class="card-header bg-warning">
            <i class="bi bi-wallet2"></i> CHEQUE
        </div>
        <div class="card-body">
            <table class="table table-borderless">
                <tr>
                    <th width="30%">Tipo:</th>
                    <td>
                        {% if transacao.cheque_tipo == 'A_VISTA' %}
                            √Ä Vista
                        {% elif transacao.cheque_tipo == 'A_PRAZO' %}
                            A Prazo
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% if transacao.cheque_tipo == 'A_PRAZO' and transacao.cheque_data_vencimento %}
                <tr>
                    <th>Data de Vencimento:</th>
                    <td>{{ transacao.cheque_data_vencimento.strftime('%d/%m/%Y') }}</td>
                </tr>
                {% endif %}
                <tr>
                    <th>Valor do Cheque:</th>
                    <td class="text-end" style="font-size: 1.2em; font-weight: bold;">
                        {{ (transacao.cheque_valor or 0)|formatar_moeda }}
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <!-- TROCO -->
    <div class="card mb-3">
        <div class="card-header bg-info text-white">
            <i class="bi bi-arrow-left-right"></i> TROCO
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Tipo de Troco</th>
                        <th class="text-end">Valor</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Troco em Esp√©cie</td>
                        <td class="text-end">{{ (transacao.troco_especie or 0)|formatar_moeda }}</td>
                    </tr>
                    <tr>
                        <td>Troco PIX</td>
                        <td class="text-end">{{ (transacao.troco_pix or 0)|formatar_moeda }}</td>
                    </tr>
                    <tr>
                        <td>Cr√©dito Vda Programada</td>
                        <td class="text-end">{{ (transacao.troco_credito_vda_programada or 0)|formatar_moeda }}</td>
                    </tr>
                    <tr class="table-info">
                        <th>TOTAL</th>
                        <th class="text-end">{{ (transacao.troco_total or 0)|formatar_moeda }}</th>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- DESTINAT√ÅRIO PIX -->
    <div class="card mb-3">
        <div class="card-header bg-secondary text-white">
            <i class="bi bi-person"></i> Destinat√°rio do PIX
        </div>
        <div class="card-body">
            <table class="table table-borderless">
                <tr>
                    <th width="30%">Nome Completo:</th>
                    <td>{{ transacao.cliente_pix_nome or '-' }}</td>
                </tr>
                <tr>
                    <th>Tipo de Chave PIX:</th>
                    <td>{{ transacao.tipo_chave_pix or '-' }}</td>
                </tr>
                <tr>
                    <th>Chave PIX:</th>
                    <td style="font-family: monospace; font-size: 1.1em;">{{ transacao.chave_pix or '-' }}</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- RESUMO FINANCEIRO -->
    <div class="card mb-3">
        <div class="card-header bg-dark text-white">
            <i class="bi bi-calculator"></i> Resumo Financeiro
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="card text-white bg-success mb-3">
                        <div class="card-body text-center">
                            <h5>Total Venda</h5>
                            <h3>{{ (transacao.venda_total or 0)|formatar_moeda }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-warning mb-3">
                        <div class="card-body text-center">
                            <h5>Valor Cheque</h5>
                            <h3>{{ (transacao.cheque_valor or 0)|formatar_moeda }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-info mb-3">
                        <div class="card-body text-center">
                            <h5>Total Troco</h5>
                            <h3>{{ (transacao.troco_total or 0)|formatar_moeda }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            
            {% set diferenca = (transacao.cheque_valor or 0) - (transacao.venda_total or 0) %}
            <div class="alert {% if diferenca == (transacao.troco_total or 0) %}alert-success{% else %}alert-danger{% endif %}">
                <strong>Verifica√ß√£o:</strong>
                Diferen√ßa (Cheque - Venda) = {{ diferenca|formatar_moeda }}
                {% if diferenca == (transacao.troco_total or 0) %}
                    <i class="bi bi-check-circle"></i> Valores conferem!
                {% else %}
                    <i class="bi bi-exclamation-triangle"></i> Valores n√£o conferem!
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnCopyWhatsApp = document.getElementById('btnCopyWhatsApp');
    const FEEDBACK_TIMEOUT = 2000; // milliseconds
    
    if (btnCopyWhatsApp) {
        btnCopyWhatsApp.addEventListener('click', function() {
            // Helper function to format currency values
            function formatCurrency(value) {
                if (!value || value === 0 || value === '0') {
                    return '';
                }
                // Convert to number if string
                let num = typeof value === 'string' ? parseFloat(value) : value;
                // Format with thousand separator (.) and decimal (,)
                return num.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
            
            // Function to show success feedback
            function showSuccessFeedback() {
                const originalText = btnCopyWhatsApp.innerHTML;
                btnCopyWhatsApp.innerHTML = '<i class="bi bi-check-circle"></i> Copiado!';
                btnCopyWhatsApp.classList.remove('btn-success');
                btnCopyWhatsApp.classList.add('btn-info');
                
                setTimeout(function() {
                    btnCopyWhatsApp.innerHTML = originalText;
                    btnCopyWhatsApp.classList.remove('btn-info');
                    btnCopyWhatsApp.classList.add('btn-success');
                }, FEEDBACK_TIMEOUT);
            }
            
            // Get transaction data - using tojson for safe escaping
            const data = {
                numero_sequencial: {{ (transacao.numero_sequencial or "")|tojson }},
                data: {{ (transacao.data.strftime("%d/%m/%Y") if transacao.data else "")|tojson }},
                venda_abastecimento: {{ transacao.venda_abastecimento or 0 }},
                venda_arla: {{ transacao.venda_arla or 0 }},
                venda_produtos: {{ transacao.venda_produtos or 0 }},
                venda_total: {{ transacao.venda_total or 0 }},
                cheque_tipo: {{ (transacao.cheque_tipo or "")|tojson }},
                cheque_data_vencimento: {{ (transacao.cheque_data_vencimento.strftime("%d/%m/%Y") if transacao.cheque_data_vencimento else "")|tojson }},
                cheque_valor: {{ transacao.cheque_valor or 0 }},
                troco_especie: {{ transacao.troco_especie or 0 }},
                troco_pix: {{ transacao.troco_pix or 0 }},
                troco_credito: {{ transacao.troco_credito_vda_programada or 0 }},
                troco_total: {{ transacao.troco_total or 0 }},
                cliente_pix_nome: {{ (transacao.cliente_pix_nome or "")|tojson }},
                tipo_chave_pix: {{ (transacao.tipo_chave_pix or "")|tojson }},
                chave_pix: {{ (transacao.chave_pix or "")|tojson }},
                frentista_nome: {{ (transacao.frentista_nome or "")|tojson }}
            };
            
            // Build WhatsApp message with bold formatting and icons
            let message = '';
            
            // Check if this is a "SEM PIX" transaction
            const isSemPix = data.cliente_pix_nome === 'SEM PIX';
            
            // Add sequential number if available
            if (data.numero_sequencial) {
                message += 'üî¢ *' + data.numero_sequencial + '*\n\n';
            }
            
            // Different title for SEM PIX transactions
            if (isSemPix) {
                message += 'üí∞ *VENDA EM CHEQUE* üí∞\n';
            } else {
                message += 'üí∞ *TROCO PIX* üí∞\n';
            }
            message += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
            message += 'üìÖ *Data:* ' + data.data + '\n\n';
            
            message += 'üè™ *VENDA*\n';
            message += '‚îú Abastecimento: ' + (formatCurrency(data.venda_abastecimento) || '‚Äî') + '\n';
            message += '‚îú Arla: ' + (formatCurrency(data.venda_arla) || '‚Äî') + '\n';
            message += '‚îú Produtos: ' + (formatCurrency(data.venda_produtos) || '‚Äî') + '\n';
            message += '‚îî *TOTAL:* ' + formatCurrency(data.venda_total) + '\n\n';
            
            // CHEQUE section - only if there's cheque data
            if (data.cheque_tipo || data.cheque_valor > 0) {
                message += 'üíµ *CHEQUE*\n';
                if (data.cheque_tipo === 'A_VISTA') {
                    message += '‚îú Tipo: √Ä Vista\n';
                } else if (data.cheque_tipo === 'A_PRAZO') {
                    message += '‚îú Tipo: A Prazo';
                    if (data.cheque_data_vencimento) {
                        message += ' (Venc: ' + data.cheque_data_vencimento + ')';
                    }
                    message += '\n';
                }
                message += '‚îî *Valor:* ' + formatCurrency(data.cheque_valor) + '\n\n';
            }
            
            message += 'üí∏ *TROCO*\n';
            message += '‚îú Em Esp√©cie: ' + (formatCurrency(data.troco_especie) || '‚Äî') + '\n';
            message += '‚îú Cr√©dito Vda. Programada: ' + (formatCurrency(data.troco_credito) || '‚Äî') + '\n';
            message += '‚îî *TOTAL:* ' + formatCurrency(data.troco_total) + '\n';
            
            // Only show PIX details if NOT "SEM PIX"
            if (!isSemPix) {
                message += '\nüîë *TROCO PIX:* ' + formatCurrency(data.troco_pix) + '\n';
                message += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
                // Only show chave info if there's actual data
                if (data.chave_pix) {
                    message += 'üì± Chave Pix: ' + (data.tipo_chave_pix ? '*' + data.tipo_chave_pix + '*' + ' - ' : '') + data.chave_pix + '\n';
                } else {
                    message += 'üì± Chave Pix: ‚Äî\n';
                }
                message += 'üë§ Cliente: ' + (data.cliente_pix_nome ? '*' + data.cliente_pix_nome + '*' : '‚Äî') + '\n\n';
            } else {
                // For SEM PIX, just add the separator line
                message += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
            }
            
            message += '‚õΩ Frentista: ' + (data.frentista_nome ? '*' + data.frentista_nome + '*' : '‚Äî');
            
            
            // Copy to clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(message).then(function() {
                    showSuccessFeedback();
                }).catch(function(err) {
                    alert('Erro ao copiar: ' + err);
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = message;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showSuccessFeedback();
                } catch (err) {
                    alert('Erro ao copiar: ' + err);
                }
                document.body.removeChild(textArea);
            }
        });
    }
});
</script>
{% endblock %}
