{% extends "base.html" %}
{% block title %}Novo Frete - NH Transportes{% endblock %}
{% block content %}
<div class="container-fluid">
  <nav aria-label="breadcrumb" class="mt-2 mb-3">
    <ol class="breadcrumb" style="font-size: 0.85rem;">
      <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Início</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('fretes.lista') }}">Fretes</a></li>
      <li class="breadcrumb-item active" aria-current="page">Novo Frete</li>
    </ol>
  </nav>

  <h2 class="mb-3" style="color:#1D63A5; font-size: 1.3rem;"><i class="bi bi-plus-circle"></i> Novo Frete</h2>

  <div class="card shadow-sm mb-3">
    <div class="card-body" style="padding: 1rem;">
      <form method="POST" class="row g-2">
        <!-- DATA / STATUS -->
        <div class="col-md-3">
          <label class="form-label">Data</label>
          <input type="text" name="data_frete" id="data_frete" class="form-control form-control-sm" placeholder="dd/mm/aaaa" value="">
        </div>
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select name="status" id="status" class="form-select form-select-sm">
            <option value="pendente">Pendente</option>
            <option value="concluido">Concluído</option>
            <option value="cancelado">Cancelado</option>
          </select>
        </div>

        <!-- CLIENTE / DESTINO -->
        <div class="col-md-6">
          <label class="form-label">Cliente</label>
          <select name="clientes_id" id="clientes_id" class="form-select form-select-sm" required>
            <option value="">Selecione um cliente</option>
            {% for c in clientes %}
              <option value="{{ c.id }}"
                data-destino="{{ c.destino_id or '' }}"
                data-paga-comissao="{{ c.paga_comissao|default(0) }}"
                data-percentual-cte="{{ c.percentual_cte|default(0) }}"
                data-cte-integral="{{ c.cte_integral|default(0) }}"
                {% if frete and frete.clientes_id and frete.clientes_id == c.id %}selected{% endif %}>
                {{ c.razao_social }}
              </option>
            {% endfor %}
          </select>
          <small id="clientes_count" class="form-text text-muted">Clientes: {{ clientes|length }}</small>
        </div>

        <div class="col-md-6">
          <label class="form-label">Destino</label>
          <select name="destino_id" id="destino_id" class="form-select form-select-sm" required>
            <option value="">Selecione o destino</option>
            {% for d in destinos %}
              <option value="{{ d.id }}"
                {% if selected_destino_id and d.id == selected_destino_id %}selected{% elif frete and frete.destino_id and d.id == frete.destino_id %}selected{% endif %}>
                {{ d.nome }}{% if d.estado %} - {{ d.estado }}{% endif %}
              </option>
            {% endfor %}
          </select>
          <div class="form-text">Destino preenchido a partir do cadastro do cliente quando disponível.</div>
        </div>

        <!-- FORNECEDOR / PRODUTO / ORIGEM -->
        <div class="col-md-4">
          <label class="form-label">Fornecedor</label>
          <select name="fornecedores_id" id="fornecedores_id" class="form-select form-select-sm">
            <option value="">Selecione um fornecedor</option>
            {% for f in fornecedores %}
              <option value="{{ f.id }}" {% if frete and frete.fornecedores_id and frete.fornecedores_id == f.id %}selected{% endif %}>{{ f.razao_social }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Produto</label>
          <select name="produto_id" id="produto_id" class="form-select form-select-sm">
            <option value="">Selecione o produto</option>
            {% for p in produtos %}
              <option value="{{ p.id }}" {% if frete and frete.produto_id and frete.produto_id == p.id %}selected{% endif %}>{{ p.nome }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Origem</label>
          <select name="origem_id" id="origem_id" class="form-select form-select-sm">
            <option value="">Selecione a origem</option>
            {% for o in origens %}
              <option value="{{ o.id }}" {% if frete and frete.origem_id and frete.origem_id == o.id %}selected{% endif %}>{{ o.nome }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- MOTORISTA / VEÍCULO / QUANTIDADE -->
        <div class="col-md-4">
          <label class="form-label">Motorista</label>
          <select name="motoristas_id" id="motoristas_id" class="form-select form-select-sm">
            <option value="">Selecione um motorista</option>
            {% for m in motoristas %}
              <option value="{{ m.id }}" {% if frete and frete.motoristas_id and frete.motoristas_id == m.id %}selected{% endif %}>{{ m.nome }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Veículo</label>
          <select name="veiculos_id" id="veiculos_id" class="form-select form-select-sm">
            <option value="">Selecione o veículo</option>
            {% for v in veiculos %}
              <option value="{{ v.id }}" {% if frete and frete.veiculos_id and frete.veiculos_id == v.id %}selected{% endif %}>{{ v.caminhao }}{% if v.placa %} - {{ v.placa }}{% endif %}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Quantidade (Litros)</label>
          {% if frete and frete.quantidade_manual %}
            <input type="text" id="quantidade_manual" name="quantidade_manual" class="form-control form-control-sm" value="{{ frete.quantidade_manual }}">
          {% else %}
            <select name="quantidade_id" id="quantidade_id" class="form-select form-select-sm">
              <option value="">Quantidade Padrão (Listbox)</option>
              {% for q in quantidades %}
                <option value="{{ q.id }}" data-quantidade="{{ q.valor }}" {% if frete and frete.quantidade_id and frete.quantidade_id == q.id %}selected{% endif %}>{{ q.descricao or q.valor }}</option>
              {% endfor %}
            </select>
          {% endif %}
        </div>

        <!-- PREÇOS -->
        <div class="col-md-6">
          <label class="form-label">Preço Produto Unitário (R$)</label>
          <input type="text" id="preco_produto_unitario" name="preco_produto_unitario" class="form-control form-control-sm"
                 value="{{ 'R$ {:.3f}'.format(frete.preco_produto_unitario).replace('.', ',') if frete and frete.preco_produto_unitario else '' }}">
          <input type="hidden" id="preco_produto_unitario_raw" name="preco_produto_unitario_raw" value="{{ frete.preco_produto_unitario if frete and frete.preco_produto_unitario else '' }}">
        </div>

        <div class="col-md-6">
          <label class="form-label">Preço por Litro (R$)</label>
          <input type="text" id="preco_por_litro" name="preco_por_litro" class="form-control form-control-sm"
                 value="{{ 'R$ {:.2f}'.format(frete.preco_por_litro).replace('.', ',') if frete and frete.preco_por_litro else '' }}">
          <input type="hidden" id="preco_por_litro_raw" name="preco_por_litro_raw" value="{{ frete.preco_por_litro if frete and frete.preco_por_litro else '' }}">
        </div>

        <!-- RESULTADOS -->
        <div class="col-md-4">
          <label class="form-label">Total NF Compra (R$)</label>
          <input type="text" id="total_nf_compra" name="total_nf_compra" class="form-control form-control-sm bg-warning" readonly value="{{ 'R$ {:.2f}'.format(frete.total_nf_compra).replace('.', ',') if frete and frete.total_nf_compra else 'R$ 0,00' }}">
        </div>

        <div class="col-md-4">
          <label class="form-label">Valor Total Frete (R$)</label>
          <input type="text" id="valor_total_frete" name="valor_total_frete" class="form-control form-control-sm bg-warning" readonly value="{{ 'R$ {:.2f}'.format(frete.valor_total_frete).replace('.', ',') if frete and frete.valor_total_frete else 'R$ 0,00' }}">
        </div>

        <div class="col-md-4">
          <label class="form-label">Comissão Motorista (R$)</label>
          <input type="text" id="comissao_motorista" name="comissao_motorista" class="form-control form-control-sm bg-warning" value="{{ 'R$ {:.2f}'.format(frete.comissao_motorista).replace('.', ',') if frete and frete.comissao_motorista else 'R$ 0,00' }}">
        </div>

        <div class="col-md-4 mt-2">
          <label class="form-label">Valor CTe (R$)</label>
          <input type="text" id="valor_cte" name="valor_cte" class="form-control form-control-sm bg-warning" readonly value="{{ 'R$ {:.2f}'.format(frete.valor_cte).replace('.', ',') if frete and frete.valor_cte else 'R$ 0,00' }}">
        </div>

        <div class="col-md-4 mt-2">
          <label class="form-label">Comissão CTe (R$)</label>
          <input type="text" id="comissao_cte" name="comissao_cte" class="form-control form-control-sm bg-warning" readonly value="{{ 'R$ {:.2f}'.format(frete.comissao_cte).replace('.', ',') if frete and frete.comissao_cte else 'R$ 0,00' }}">
        </div>

        <div class="col-md-4 mt-2">
          <label class="form-label">Lucro (R$)</label>
          <input type="text" id="lucro" name="lucro" class="form-control form-control-sm bg-warning" readonly value="{{ 'R$ {:.2f}'.format(frete.lucro).replace('.', ',') if frete and frete.lucro else 'R$ 0,00' }}">
        </div>

        <!-- OBSERVAÇÕES -->
        <div class="col-12">
          <label class="form-label">Observações</label>
          <textarea name="observacoes" id="observacoes" class="form-control form-control-sm" rows="3">{{ frete.observacoes if frete and frete.observacoes else '' }}</textarea>
        </div>

        <div class="col-12 mt-3 d-flex justify-content-end">
          <button type="submit" class="btn btn-success btn-sm">Salvar (não implementado)</button>
          <a href="{{ url_for('fretes.lista') }}" class="btn btn-secondary btn-sm ms-2">Voltar</a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- scripts e inicializações -->
<script>
const ROTAS = {{ rotas_dict|tojson|safe }};
</script>

<script src="{{ url_for('static', filename='js/fretes_fixes.js') }}"></script>
<script src="{{ url_for('static', filename='js/fretes_calculos.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  try { if (typeof initFretesFixes === 'function') initFretesFixes(); } catch(e){ console.error(e); }
  try { if (typeof calcularTudo === 'function') calcularTudo(); } catch(e){ console.error(e); }

  const clienteSel = document.getElementById('clientes_id');
  const destinoSel = document.getElementById('destino_id');

  function toBool(v){ return String(v) === '1' || String(v).toLowerCase() === 'true'; }

  function aplicarRegraCliente(opt) {
    if (!opt) return;
    const destino = opt.getAttribute('data-destino') || '';
    const pagaComissao = toBool(opt.getAttribute('data-paga-comissao'));
    const percentualCte = parseFloat(opt.getAttribute('data-percentual-cte')||0) || 0;
    const cteIntegral = toBool(opt.getAttribute('data-cte-integral'));

    if (destino && destinoSel) {
      destinoSel.value = destino;
      destinoSel.dispatchEvent(new Event('change'));
    }

    window.__CLIENTE_PAGA_FRETE = (pagaComissao);
    window.__CLIENTE_PERCENTUAL_CTE = percentualCte;
    window.__CLIENTE_CTE_INTEGRAL = cteIntegral ? 1 : 0;

    try { if (typeof calcularTudo === 'function') calcularTudo(); } catch(e){ console.error(e); }

    if (!window.__CLIENTE_PAGA_FRETE) {
      const elPrecoLitro = document.getElementById('preco_por_litro');
      const elValorFrete = document.getElementById('valor_total_frete');
      const elComissaoMotorista = document.getElementById('comissao_motorista');
      const elComissaoCte = document.getElementById('comissao_cte');

      if (elPrecoLitro) { elPrecoLitro.value = 'R$ 0,00'; elPrecoLitro.dispatchEvent(new Event('blur')); }
      if (elValorFrete) elValorFrete.value = 'R$ 0,00';
      if (elComissaoMotorista) elComissaoMotorista.value = 'R$ 0,00';
      if (elComissaoCte) elComissaoCte.value = 'R$ 0,00';
      try { if (typeof calcularTudo === 'function') calcularTudo(); } catch(e){ console.error(e); }
    }
  }

  if (clienteSel) {
    clienteSel.addEventListener('change', function(){
      const opt = this.options[this.selectedIndex];
      aplicarRegraCliente(opt);
    });
    const initialOpt = clienteSel.options[clienteSel.selectedIndex];
    if (initialOpt) aplicarRegraCliente(initialOpt);
  }
});
</script>
{% endblock %}
