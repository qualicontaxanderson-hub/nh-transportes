{% extends 'base.html' %}

{% block titulo %}Novo Frete{% endblock %}

{% block content %}
<div class="container-fluid">
  <nav aria-label="breadcrumb" class="mt-2 mb-3">
    <ol class="breadcrumb" style="font-size: 0.85rem;">
      <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Início</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('fretes.lista') }}">Fretes</a></li>
      <li class="breadcrumb-item active" aria-current="page">Novo Frete</li>
    </ol>
  </nav>

  <div class="card shadow-sm">
    <div class="card-header" style="background:#ff9800;color:white; font-size: 0.95rem; padding: 0.6rem 1rem;">
      <h4 class="mb-0" style="font-size: 1.1rem;">Novo Frete</h4>
    </div>
    <div class="card-body" style="padding: 1rem;">
      
      <!-- IMPORTAR DO PEDIDO -->
      <div class="card mb-3 border-info">
        <div class="card-header bg-info text-white" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
          <i class="bi bi-cart"></i> Importar do Pedido
        </div>
        <div class="card-body" style="padding: 0.75rem;">
          <div class="row align-items-end">
            <div class="col-md-8 mb-2">
              <label for="pedidoimportar" class="form-label" style="font-size: 0.85rem;">Selecione um Pedido para importar dados</label>
              <select class="form-select form-select-sm" id="pedidoimportar">
                <option value="">-- Não importar, preencher manualmente --</option>
                {% for pedido in pedidos %}
                <option value="{{ pedido.id }}" data-motorista="{{ pedido.motorista_id or '' }}"
                        {% if pedido_selecionado_id and pedido.id == pedido_selecionado_id %}selected{% endif %}>
                  {{ pedido.numero }} - {{ pedido.data_pedido.strftime('%d/%m/%Y') if pedido.data_pedido else '' }} 
                  {% if pedido.motorista_nome %}- {{ pedido.motorista_nome }}{% endif %} - {{ pedido.status }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-2">
              <button type="button" class="btn btn-info btn-sm w-100" onclick="irParaImportacao()">
                <i class="bi bi-download"></i> Importar Pedido Completo
              </button>
            </div>
          </div>
        </div>
      </div>

      <form method="POST" action="{{ url_for('fretes.novo') }}">
        <input type="hidden" name="pedido_id" id="pedidoidhidden" value="{{ pedido_selecionado_id or '' }}">
        
        <!-- DATA DO FRETE (movido para o topo) -->
        <div class="row mb-3">
          <div class="col-md-12">
            <label for="data_frete" class="form-label" style="font-size: 0.85rem;">Data do Frete</label>
            <input type="date" class="form-control form-control-sm" id="data_frete" name="data_frete" required>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-2">
            <label for="clientes_id" class="form-label" style="font-size: 0.85rem;">Cliente</label>
            <select class="form-select form-select-sm" id="clientes_id" name="clientes_id" required>
              <option value="">Selecione um cliente</option>
              {% for cliente in clientes %}
              <option value="{{ cliente.id }}" 
                      data-paga-comissao="{{ cliente.paga_comissao }}"
                      data-percentual-cte="{{ cliente.percentual_cte }}"
                      data-cte-integral="{{ cliente.cte_integral }}"
                      data-destino-id="{{ cliente.destino_id or '' }}">
                {{ cliente.razao_social }}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-6 mb-2">
            <label for="produto_id" class="form-label" style="font-size: 0.85rem;">Produto</label>
            <select class="form-select form-select-sm" id="produto_id" name="produto_id" required>
              <option value="">Selecione o produto</option>
              {% for produto in produtos %}
              <option value="{{ produto.id }}">{{ produto.nome }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-2">
            <label for="fornecedores_id" class="form-label" style="font-size: 0.85rem;">Fornecedor</label>
            <select class="form-select form-select-sm" id="fornecedores_id" name="fornecedores_id" required>
              <option value="">Selecione um fornecedor</option>
              {% for fornecedor in fornecedores %}
              <option value="{{ fornecedor.id }}">{{ fornecedor.razao_social }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-6 mb-2">
            <label for="motoristas_id" class="form-label" style="font-size: 0.85rem;">Motorista</label>
            <select class="form-select form-select-sm" id="motoristas_id" name="motoristas_id" required>
              <option value="">Selecione um motorista</option>
              {% for motorista in motoristas %}
              <option value="{{ motorista.id }}" data-paga-comissao="{{ motorista.paga_comissao }}">
                {{ motorista.nome }}
              </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- ROTA: ORIGEM E DESTINO (CAMPOS OBRIGATÓRIOS) -->
        <div class="row">
          <div class="col-md-6 mb-2">
            <label for="origem_id" class="form-label" style="font-size: 0.85rem;">Origem</label>
            <select class="form-select form-select-sm" id="origem_id" name="origem_id" required>
              <option value="">Selecione a origem</option>
              {% for origem in origens %}
              <option value="{{ origem.id }}">{{ origem.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-6 mb-2">
            <label for="destino_id" class="form-label" style="font-size: 0.85rem;">Destino</label>
            <select class="form-select form-select-sm" id="destino_id" name="destino_id" required>
              <option value="">Selecione o destino</option>
              {% for destino in destinos %}
              <option value="{{ destino.id }}">{{ destino.nome }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-2">
            <label for="veiculos_id" class="form-label" style="font-size: 0.85rem;">Veículo</label>
            <select class="form-select form-select-sm" id="veiculos_id" name="veiculos_id" required>
              <option value="">Selecione um veículo</option>
              {% for veiculo in veiculos %}
              <option value="{{ veiculo.id }}">{{ veiculo.caminhao }} - {{ veiculo.placa }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Tipo de Quantidade: Padrão ou Personalizada -->
          <div class="col-md-6 mb-2">
            <label for="quantidade_tipo" class="form-label" style="font-size: 0.85rem;">Tipo de Quantidade</label>
            <select class="form-select form-select-sm" id="quantidade_tipo" name="quantidade_tipo" required>
              <option value="padrao">Quantidade Padrão (Listbox)</option>
              <option value="personalizada">Quantidade Personalizada (Manual)</option>
            </select>
          </div>
        </div>

        <div class="row">
          <!-- Quantidade Padrão (Listbox) -->
          <div class="col-md-6 mb-2" id="div_quantidade_padrao">
            <label for="quantidade_id" class="form-label" style="font-size: 0.85rem;">Quantidade (Litros)</label>
            <select class="form-select form-select-sm" id="quantidade_id" name="quantidade_id">
              <option value="">Selecione a quantidade</option>
              {% for quantidade in quantidades %}
              <option value="{{ quantidade.id }}" data-litros="{{ quantidade.descricao }}" data-valor="{{ quantidade.valor }}">
                {{ quantidade.descricao }}
              </option>
              {% endfor %}
            </select>
          </div>

          <!-- Quantidade Personalizada (Input Manual) -->
          <div class="col-md-6 mb-2" id="div_quantidade_personalizada" style="display: none;">
            <label for="quantidade_manual" class="form-label" style="font-size: 0.85rem;">Quantidade Manual (Litros)</label>
            <input type="number" class="form-control form-control-sm" id="quantidade_manual" name="quantidade_manual" 
                   placeholder="Ex: 9.975" min="0" step="1">
            <small class="text-muted" style="font-size: 0.75rem;">Use para quantidades não padronizadas (ex: fornecedor picado)</small>
          </div>
        </div>

        <div class="row">
          <div class="col-md-4 mb-2">
            <label for="preco_produto_unitario" class="form-label" style="font-size: 0.85rem;">Preço Produto Unitário R$</label>
            <input type="text" class="form-control form-control-sm" id="preco_produto_unitario" name="preco_produto_unitario" value="0,00" required>
          </div>

          <div class="col-md-4 mb-2">
            <label for="total_nf_compra" class="form-label" style="font-size: 0.85rem;">Total NF Compra R$</label>
            <input type="text" class="form-control form-control-sm bg-warning" id="total_nf_compra" name="total_nf_compra" value="0,00" readonly>
          </div>

          <div class="col-md-4 mb-2">
            <label for="preco_por_litro" class="form-label" style="font-size: 0.85rem;">Preço por Litro R$</label>
            <input type="text" class="form-control form-control-sm" id="preco_por_litro" name="preco_por_litro" value="0,00" required>
          </div>
        </div>

        <div class="row">
          <div class="col-md-4 mb-2">
            <label for="valor_total_frete" class="form-label" style="font-size: 0.85rem;">Valor Total Frete R$</label>
            <input type="text" class="form-control form-control-sm bg-warning" id="valor_total_frete" name="valor_total_frete" value="0,00" readonly>
          </div>

          <div class="col-md-4 mb-2">
            <label for="comissao_motorista" class="form-label" style="font-size: 0.85rem;">Comissão Motorista R$</label>
            <input type="text" class="form-control form-control-sm bg-warning" id="comissao_motorista" name="comissao_motorista" value="0,00" readonly>
          </div>

          <div class="col-md-4 mb-2">
            <label for="valor_cte" class="form-label" style="font-size: 0.85rem;">Valor CTe R$</label>
            <input type="text" class="form-control form-control-sm bg-warning" id="valor_cte" name="valor_cte" value="0,00" readonly>
          </div>
        </div>

        <div class="row">
          <div class="col-md-4 mb-2">
            <label for="comissao_cte" class="form-label" style="font-size: 0.85rem;">Comissão CTe R$</label>
            <input type="text" class="form-control form-control-sm bg-warning" id="comissao_cte" name="comissao_cte" value="0,00" readonly>
          </div>

          <div class="col-md-4 mb-2">
            <label for="lucro" class="form-label" style="font-size: 0.85rem;">Lucro R$</label>
            <input type="text" class="form-control form-control-sm bg-warning" id="lucro" name="lucro" value="0,00" readonly>
          </div>

          <div class="col-md-4 mb-2">
            <label for="status" class="form-label" style="font-size: 0.85rem;">Status</label>
            <select class="form-select form-select-sm" id="status" name="status" required>
              <option value="Pendente">Pendente</option>
              <option value="Em Trânsito">Em Trânsito</option>
              <option value="Concluído">Concluído</option>
              <option value="Cancelado">Cancelado</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-md-12 mb-3">
            <label for="observacoes" class="form-label" style="font-size: 0.85rem;">Observações</label>
            <textarea class="form-control form-control-sm" id="observacoes" name="observacoes" rows="2" 
                      placeholder="Digite observações adicionais..."></textarea>
          </div>
        </div>

        <div class="d-flex justify-content-between">
          <a href="{{ url_for('fretes.lista') }}" class="btn btn-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Voltar
          </a>
          <button type="submit" class="btn btn-success btn-sm">
            <i class="bi bi-check-circle"></i> Salvar Frete
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

<style>
  .bg-warning {
    background-color: #FFD580 !important;
  }
  .form-control-sm, .form-select-sm {
    font-size: 0.85rem;
  }
  .btn-sm {
    font-size: 0.85rem;
    padding: 0.4rem 0.8rem;
  }
  @media (max-width: 768px) {
    .card-body {
      padding: 0.5rem !important;
    }
    .form-label {
      font-size: 0.8rem !important;
    }
    .form-control-sm, .form-select-sm {
      font-size: 0.8rem !important;
    }
  }
</style>

<script>
const ROTAS = {{ rotas_dict|tojson|safe }};

// Função para redirecionar para importação de pedido
function irParaImportacao() {
  var pedidoSelect = document.getElementById('pedidoimportar');
  var pedidoId = pedidoSelect.value;
  
  if (!pedidoId) {
    alert('Selecione um pedido para importar.');
    return;
  }
  
  // Redirecionar para tela de importação
  window.location.href = '/fretes/importar/' + pedidoId;
}

// Toggle tipo de quantidade
document.addEventListener('DOMContentLoaded', function() {
  var tipoSelect = document.querySelector('#quantidade_tipo');
  var divPadrao = document.querySelector('#div_quantidade_padrao');
  var divPersonalizada = document.querySelector('#div_quantidade_personalizada');
  var quantidadePadraoSelect = document.querySelector('#quantidade_id');
  var quantidadeManualInput = document.querySelector('#quantidade_manual');

  tipoSelect.addEventListener('change', function() {
    if (this.value === 'personalizada') {
      divPadrao.style.display = 'none';
      divPersonalizada.style.display = 'block';
      quantidadePadraoSelect.removeAttribute('required');
      quantidadeManualInput.setAttribute('required', 'required');
      quantidadePadraoSelect.value = '';
    } else {
      divPadrao.style.display = 'block';
      divPersonalizada.style.display = 'none';
      quantidadePadraoSelect.setAttribute('required', 'required');
      quantidadeManualInput.removeAttribute('required');
      quantidadeManualInput.value = '';
    }
  });

  // Auto-preencher destino quando selecionar cliente
  var clienteSelect = document.getElementById('clientes_id');
  var destinoSelect = document.getElementById('destino_id');
  
  clienteSelect.addEventListener('change', function() {
    var option = this.options[this.selectedIndex];
    var destinoId = option.getAttribute('data-destino-id');
    
    if (destinoId) {
      destinoSelect.value = destinoId;
    }
  });
});
</script>

<script src="{{ url_for('static', filename='js/fretes-calculos.js') }}"></script>

{% endblock %}
