{% extends 'base.html' %}
{% block title %}Novo Frete - {{ app_name }}{% endblock %}
{% block content %}
<div class="container-fluid">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('fretes.lista') }}">Fretes</a></li>
            <li class="breadcrumb-item active" aria-current="page">Novo Frete</li>
        </ol>
    </nav>
    <h2 class="mb-4" style="color:#1D63A5;"><i class="bi bi-plus-circle"></i> Novo Lançamento de Frete</h2>
    <div class="card">
        <div class="card-header" style="background:#ff9800;color:white;">
            <h5 class="mb-0">Cadastrar Frete</h5>
        </div>
        <div class="card-body">
            <form method="POST" id="formFrete">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Data do Frete *</label>
                        <input type="date" name="data_frete" class="form-control" value="{{ data_hoje }}" required>
                    </div>
                    <div class="col-md-9 mb-3">
                        <label class="form-label">Cliente *</label>
                        <select name="cliente_id" id="cliente_id" class="form-select select2" required>
                            <option value="">Selecione...</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}" data-paga-comissao="{{ cliente.paga_comissao }}">{{ cliente.razao_social }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Produto *</label>
                        <select name="produto_id" class="form-select" required>
                            <option value="">Selecione...</option>
                            {% for produto in produtos %}
                            <option value="{{ produto.id }}">{{ produto.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Quantidade (litros) *</label>
                        <select name="quantidade_id" class="form-select" id="quantidade" required>
                            <option value="">Selecione...</option>
                            {% for qtd in quantidades %}
                            <option value="{{ qtd.id }}" data-valor="{{ qtd.valor }}">{{ qtd.valor }} litros</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Preço por Litro *</label>
                        <input type="number" name="preco_litro" id="precoLitro" class="form-control" step="0.001" placeholder="0.000" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Preço Produto Unitário</label>
                        <input type="number" name="preco_produto_unitario" id="precoUnitario" class="form-control" step="0.01" placeholder="0.00">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Total NF Compra</label>
                        <input type="number" name="total_nf_compra" id="totalNfCompra" class="form-control" step="0.01" placeholder="0.00" readonly style="background:#f0f0f0;">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Fornecedor</label>
                        <select name="fornecedor_id" id="fornecedor_id" class="form-select select2">
                            <option value="">Selecione...</option>
                            {% for fornecedor in fornecedores %}
                            <option value="{{ fornecedor.id }}">{{ fornecedor.razao_social }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Origem do Produto</label>
                        <select name="origem_produto_id" id="origem_id" class="form-select">
                            <option value="">Selecione...</option>
                            {% for origem in origens %}
                            <option value="{{ origem.id }}">{{ origem.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="alert alert-info">
                    <h5><i class="bi bi-calculator"></i> Valor Total do Frete: <span id="valorTotal" style="color:#1D63A5;font-weight:700;">R$ 0,00</span></h5>
                    <input type="hidden" name="vlr_total_frete" id="vlr_total_frete" value="0">
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Motorista *</label>
                        <select name="motorista_id" id="motorista_id" class="form-select select2" required>
                            <option value="">Selecione...</option>
                            {% for motorista in motoristas %}
                            <option value="{{ motorista.id }}">{{ motorista.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Veículo *</label>
                        <select name="veiculo_id" id="veiculo_id" class="form-select select2" required>
                            <option value="">Selecione...</option>
                            {% for veiculo in veiculos %}
                            <option value="{{ veiculo.id }}">{{ veiculo.caminhao }} - {{ veiculo.placa }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Comissão Motorista</label>
                        <input type="number" name="comissao_motorista" id="comissaoMotorista" class="form-control" step="0.01" placeholder="0.00" readonly style="background:#f0f0f0;">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Valor CTe</label>
                        <input type="number" name="vlr_cte" id="vlrCte" class="form-control" step="0.01" placeholder="0.00" readonly style="background:#f0f0f0;">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Comissão CTe (8%)</label>
                        <input type="number" name="comissao_cte" id="comissaoCte" class="form-control" step="0.01" placeholder="0.00" readonly style="background:#f0f0f0;">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Lucro</label>
                        <input type="number" name="lucro" id="lucro" class="form-control" step="0.01" placeholder="0.00" readonly style="background:#f0f0f0;font-weight:bold;">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Situação Financeira *</label>
                        <select name="forma_pagamento_id" class="form-select" required>
                            <option value="">Selecione...</option>
                            {% for situacao in situacoes %}
                            <option value="{{ situacao.id }}">{{ situacao.status }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <button type="submit" class="btn btn-primary btn-lg" style="background:#1D63A5;border:none;"><i class="bi bi-check-circle"></i> Salvar Frete</button>
                    <a href="{{ url_for('fretes.lista') }}" class="btn btn-secondary btn-lg"><i class="bi bi-x-circle"></i> Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
jQuery(document).ready(function($) {
    $('.select2').select2({theme: 'bootstrap-5', placeholder: 'Digite para buscar...', allowClear: true});
});
var clientePagaComissao = false;
var clienteRazaoSocial = '';
var fornecedorRazaoSocial = '';
var origemNome = '';
document.getElementById('cliente_id').addEventListener('change', function() {
    var opt = this.options[this.selectedIndex];
    clientePagaComissao = opt.dataset.pagaComissao == '1';
    clienteRazaoSocial = opt.text.toUpperCase();
    calcularTudo();
});
document.getElementById('fornecedor_id').addEventListener('change', function() {
    fornecedorRazaoSocial = this.options[this.selectedIndex].text.toUpperCase();
    calcularTudo();
});
document.getElementById('origem_id').addEventListener('change', function() {
    origemNome = this.options[this.selectedIndex].text.toUpperCase();
    calcularTudo();
});
document.getElementById('quantidade').addEventListener('change', calcularTotalNfCompra);
document.getElementById('precoUnitario').addEventListener('input', calcularTotalNfCompra);
function calcularTotalNfCompra() {
    var qtd = document.getElementById('quantidade');
    var preco = parseFloat(document.getElementById('precoUnitario').value) || 0;
    if (qtd.value && preco > 0) {
        var litros = parseFloat(qtd.options[qtd.selectedIndex].dataset.valor);
        document.getElementById('totalNfCompra').value = (litros * preco).toFixed(2);
    }
    calcularTudo();
}
document.getElementById('quantidade').addEventListener('change', calcularValorTotalFrete);
document.getElementById('precoLitro').addEventListener('input', calcularValorTotalFrete);
function calcularValorTotalFrete() {
    var qtd = document.getElementById('quantidade');
    var preco = document.getElementById('precoLitro');
    if (qtd.value && preco.value) {
        var litros = parseFloat(qtd.options[qtd.selectedIndex].dataset.valor);
        var total = litros * parseFloat(preco.value);
        document.getElementById('valorTotal').textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
        document.getElementById('vlr_total_frete').value = total.toFixed(2);
    }
    calcularTudo();
}
function calcularTudo() {
    var qtd = document.getElementById('quantidade');
    if (!qtd.value) return;
    var litros = parseFloat(qtd.options[qtd.selectedIndex].dataset.valor);
    var vlrTotal = parseFloat(document.getElementById('vlr_total_frete').value) || 0;
    var totalNf = parseFloat(document.getElementById('totalNfCompra').value) || 0;
    var comissao = 0;
    if (clientePagaComissao) comissao = litros * 0.01;
    document.getElementById('comissaoMotorista').value = comissao.toFixed(2);
    var pctCte = 0.08;
    if (fornecedorRazaoSocial.includes('INTEGRAÇÃO') && (fornecedorRazaoSocial.includes('GOIASA') || fornecedorRazaoSocial.includes('BONSUCESSO'))) {
        pctCte = 0.05;
    } else if (clienteRazaoSocial.includes('AUTO POSTO TERRA BRANCA')) {
        pctCte = origemNome.includes('SENADOR CANEDO') ? 0.06 : 0.10;
    } else if (clienteRazaoSocial.includes('RLM COMBUSTIVEIS')) {
        pctCte = 0.10;
    }
    var vlrCte = litros * pctCte;
    document.getElementById('vlrCte').value = vlrCte.toFixed(2);
    var comCte = vlrCte * 0.08;
    document.getElementById('comissaoCte').value = comCte.toFixed(2);
    var lucro = clientePagaComissao ? (vlrTotal - comissao - comCte - totalNf) : 0;
    document.getElementById('lucro').value = lucro.toFixed(2);
    var lucroInput = document.getElementById('lucro');
    lucroInput.style.color = lucro > 0 ? '#28a745' : (lucro < 0 ? '#dc3545' : '#6c757d');
}
</script>
{% endblock %}
