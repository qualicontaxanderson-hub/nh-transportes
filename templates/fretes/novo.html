<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Novo Frete — NH Transportes</title>

  <!-- Bootstrap CSS (CDN ou estático da sua app) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/style.css?v={{ APP_VERSION }}">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand text-white" href="/">GRUPO NH</a>
    <!-- nav simplificada -->
    <ul class="navbar-nav ms-auto">
      <li class="nav-item"><a class="nav-link text-white" href="/auth/profile">{{ current_user.name if current_user else '' }}</a></li>
    </ul>
  </div>
</nav>

<div class="container-fluid mt-4">
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Início</a></li>
      <li class="breadcrumb-item"><a href="/fretes/">Fretes</a></li>
      <li class="breadcrumb-item active" aria-current="page">Novo Frete</li>
    </ol>
  </nav>

  <div class="card">
    <div class="card-header bg-warning">
      <h5 class="mb-0">Novo Frete</h5>
    </div>

    <div class="card-body">
      <form id="form-frete" method="post" action="{{ url_for('fretes.create') }}">
        <!-- CSRF se usar -->
        {{ csrf_token() if csrf_token is defined else '' }}

        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">Data</label>
            <input type="date" name="data" class="form-control" value="{{ frete.data if frete else '' }}">
          </div>
          <div class="col-md-3">
            <label class="form-label">Status</label>
            <select name="status" class="form-select">
              <option value="pendente" {% if frete and frete.status=='pendente' %}selected{% endif %}>Pendente</option>
              <option value="concluido" {% if frete and frete.status=='concluido' %}selected{% endif %}>Concluído</option>
            </select>
          </div>
          <div class="col-md-6 d-flex align-items-end justify-content-end">
            <button type="button" class="btn btn-success" id="btn-importar">Importar Pedido</button>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Cliente</label>
            <select id="clientes_id" name="clientes_id" class="form-select" onchange="onClienteChange(this)">
              <option value="">Selecione um cliente</option>
              {% for cliente in clientes %}
                <option value="{{ cliente.id }}"
                        data-paga-comissao="{{ cliente.paga_frete|default(0) }}"
                        {% if frete and cliente.id == frete.clientes_id %}selected{% endif %}>
                  {{ cliente.nome }}
                </option>
              {% endfor %}
            </select>
            <small class="text-muted">Destino preenchido a partir do cadastro do cliente</small>
          </div>

          <div class="col-md-6 mb-3">
            <label class="form-label">Observações</label>
            <input type="text" name="observacoes" class="form-control" value="{{ frete.observacoes if frete else '' }}">
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Fornecedor</label>
            <select id="fornecedores_id" name="fornecedores_id" class="form-select">
              <option value="">Selecione um fornecedor</option>
              {% for f in fornecedores %}
                <option value="{{ f.id }}" {% if frete and f.id==frete.fornecedores_id %}selected{% endif %}>{{ f.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-6 mb-3">
            <label class="form-label">Produto</label>
            <select id="produtos_id" name="produtos_id" class="form-select">
              <option value="">Selecione o produto</option>
              {% for p in produtos %}
                <option value="{{ p.id }}" {% if frete and p.id==frete.produtos_id %}selected{% endif %}>{{ p.nome }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-md-3 mb-3">
            <label class="form-label">Origem</label>
            <select id="origem_id" name="origem_id" class="form-select">
              <option value="">Selecione a origem</option>
              {% for o in origens %}
                <option value="{{ o.id }}" {% if frete and o.id==frete.origem_id %}selected{% endif %}>{{ o.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-3 mb-3">
            <label class="form-label">Destino</label>
            <select id="destino_id" name="destino_id" class="form-select">
              <option value="">Selecione o destino</option>
              {% for d in destinos %}
                <option value="{{ d.id }}" {% if frete and d.id==frete.destino_id %}selected{% endif %}>{{ d.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-3 mb-3">
            <label class="form-label">Motorista</label>
            <select id="motoristas_id" name="motoristas_id" class="form-select form-select-sm" required>
              <option value="">Selecione um motorista</option>
              {% for motorista in motoristas %}
                <option
                  value="{{ motorista.id }}"
                  data-percentual="{{ motorista.percentual_comissao|default('') }}"
                  data-paga-comissao="{{ motorista.paga_comissao|default(0) }}"
                  {% if frete and motorista.id == frete.motoristas_id %}selected{% endif %}>
                  {{ motorista.nome }}
                </option>
              {% endfor %}
            </select>
            <small class="text-muted d-block mt-1">O campo data-paga-comissao é preenchido a partir do DB</small>
          </div>

          <div class="col-md-3 mb-3">
            <label class="form-label">Veículo</label>
            <select id="veiculos_id" name="veiculos_id" class="form-select">
              <option value="">Selecione um veículo</option>
              {% for v in veiculos %}
                <option value="{{ v.id }}" {% if frete and v.id==frete.veiculos_id %}selected{% endif %}>{{ v.nome }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="row align-items-end">
          <div class="col-md-4 mb-3">
            <label class="form-label">Tipo de Quantidade</label>
            <select id="tipo_quantidade_id" name="tipo_quantidade_id" class="form-select">
              <option value="">Quantidade Padrão (Listbox)</option>
              {% for t in tipos_quantidade %}
                <option value="{{ t.id }}" {% if frete and t.id==frete.tipo_quantidade_id %}selected{% endif %}>{{ t.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label">Quantidade (Litros)</label>
            <select id="quantidade_id" name="quantidade_id" class="form-select">
              <option value="">Selecione a quantidade</option>
              {% for q in quantidades %}
                <option value="{{ q.id }}" data-quantidade="{{ q.litros }}" {% if frete and q.id==frete.quantidade_id %}selected{% endif %}>{{ q.label }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label">Preço por Litro (R$)</label>
            <input type="text" id="preco_por_litro" name="preco_por_litro" class="form-control" value="{{ frete.preco_por_litro if frete else '' }}">
          </div>
        </div>

        <!-- Resultados / valores calculados -->
        <div class="row mt-4">
          <div class="col-md-4">
            <label class="form-label">Total NF Compra (R$)</label>
            <div class="form-control bg-warning text-dark" id="valor_total_nf_display">R$ 0,00</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Valor Total Frete (R$)</label>
            <div class="form-control bg-warning text-dark" id="valor_total_frete">R$ 0,00</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Comissão Motorista (R$)</label>
            <div class="form-control bg-warning text-dark" id="comissao_motorista">R$ 0,00</div>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-4">
            <label class="form-label">Valor CTe (R$)</label>
            <div class="form-control bg-warning text-dark" id="valor_cte">R$ 0,00</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Comissão CTe (R$)</label>
            <div class="form-control bg-warning text-dark" id="comissao_cte">R$ 0,00</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Lucro</label>
            <div class="form-control bg-warning text-dark" id="lucro">R$ 0,00</div>
          </div>
        </div>

        <!-- hidden raw values (para persistência) -->
        <input type="hidden" id="comissao_motorista_raw" name="comissao_motorista_raw" value="{{ frete.comissao_motorista_raw if frete else 0 }}">
        <input type="hidden" id="valor_total_frete_raw" name="valor_total_frete_raw" value="{{ frete.valor_total_frete_raw if frete else 0 }}">
        <input type="hidden" id="valor_cte_raw" name="valor_cte_raw" value="{{ frete.valor_cte_raw if frete else 0 }}">
        <input type="hidden" id="lucro_raw" name="lucro_raw" value="{{ frete.lucro_raw if frete else 0 }}">

        <div class="mt-4 text-end">
          <button type="submit" class="btn btn-primary">Salvar</button>
          <a href="{{ url_for('fretes.index') }}" class="btn btn-secondary">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JS includes -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/static/js/fretes_fixes.js?v={{ APP_VERSION }}"></script>
<script src="/static/js/fretes_calculos.js?v={{ APP_VERSION }}"></script>

<script>
  // Função simples para marcar flag clientePaga ao selecionar cliente (exemplo)
  function onClienteChange(sel) {
    var opt = sel.options[sel.selectedIndex];
    var paga = opt ? opt.getAttribute('data-paga-comissao') : null;
    // converte para boolean; default seguro = false
    window.__CLIENTE_PAGA_FRETE = (paga !== null) ? (String(paga).trim() !== '0' && String(paga).trim().toLowerCase() !== 'false') : false;
    // Recalcula valores quando o cliente muda
    if (typeof calcularTudo === 'function') calcularTudo();
  }

  // Ao carregar a página, se já tiver um cliente selecionado, inicializa flag
  document.addEventListener('DOMContentLoaded', function(){
    var selCli = document.getElementById('clientes_id');
    if (selCli) onClienteChange(selCli);
  });
</script>
</body>
</html>
