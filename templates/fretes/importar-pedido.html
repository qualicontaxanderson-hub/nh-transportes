{% extends 'base.html' %}

{% block titulo %}Importar Pedido - Fretes{% endblock %}

{% block content %}
<!-- Modal: detalhe do pedido -->
<div class="modal fade" id="modalImportarPedido" tabindex="-1" aria-labelledby="modalImportarPedidoLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header" style="background:#28a745;color:white;">
        <h5 class="modal-title" id="modalImportarPedidoLabel">Importação de Pedido #{{ pedido.numero }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
          <form method="POST" action="{{ url_for('fretes.salvar_importados') }}" id="formImportacaoModal">
            <input type="hidden" name="pedido_id" value="{{ pedido.id }}">
            <input type="hidden" name="save" value="1">

            <!-- Dados Comuns -->
            <div class="card mb-3">
              <div class="card-header" style="background:#17a2b8;color:white;"><strong>Dados Comuns do Frete</strong></div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <label>Data do Frete *</label>
                    <input type="date" class="form-control form-control-sm" name="data_frete" id="data_frete" value="{{ pedido.data_pedido.strftime('%Y-%m-%d') if pedido.data_pedido else '' }}" required>
                  </div>
                  <div class="col-md-4">
                    <label>Motorista</label>
                    <input type="text" class="form-control form-control-sm" value="{{ pedido.motorista_nome or 'Não informado' }}" readonly style="background:#FFD580;">
                    <input type="hidden" name="motorista_id" value="{{ pedido.motorista_id }}">
                    {# Novos campos: expor flags do motorista para o modal JS #}
                    <input type="hidden" id="import_motorista_paga_comissao" value="{{ pedido.motorista_paga_comissao|default(1) }}">
                    <input type="hidden" id="import_motorista_percentual" value="{{ pedido.motorista_percentual|default(0) }}">
                  </div>
                  <div class="col-md-4">
                    <label>Veículo</label>
                    <input type="text" class="form-control form-control-sm" value="{{ pedido.veiculo_nome or 'N/A' }} - {{ pedido.veiculo_placa or 'N/A' }}" readonly style="background:#FFD580;">
                    <input type="hidden" name="veiculo_id" value="{{ pedido.veiculo_id }}">
                  </div>
                </div>
              </div>
            </div>

            <!-- Itens -->
            {% for item in itens %}
            <div class="card mb-3 item-card">
              <div class="card-header" style="background:#e9ecef;">
                <strong>Item #{{ loop.index }}</strong> - {{ item.cliente_razao }}
              </div>
              <div class="card-body">
                <!-- Hidden inputs do item (NOMES no formato itens[index][campo]) -->
                <input type="hidden" name="itens[{{ loop.index0 }}][cliente_id]" value="{{ item.cliente_id }}">
                <input type="hidden" name="itens[{{ loop.index0 }}][produto_id]" value="{{ item.produto_id }}">
                <input type="hidden" name="itens[{{ loop.index0 }}][fornecedor_id]" value="{{ item.fornecedor_id }}">
                <input type="hidden" name="itens[{{ loop.index0 }}][origem_id]" value="{{ item.origem_id }}">
                <input type="hidden" name="itens[{{ loop.index0 }}][destino_id]" value="{{ item.cliente_destino_id or '' }}">
                <input type="hidden" name="itens[{{ loop.index0 }}][quantidade_id]" value="{{ item.quantidade_id or '' }}">
                <input type="hidden" name="itens[{{ loop.index0 }}][quantidade]" value="{{ item.quantidade or 0 }}">
                <input type="hidden" name="itens[{{ loop.index0 }}][preco_unitario]" value="{{ '{:.2f}'.format(item.preco_unitario).replace('.', ',') if item.preco_unitario else '0,00' }}">

                <!-- Hidden para JS: flags do cliente e origem/destino do item -->
                <input type="hidden" class="cliente-paga-comissao" value="{{ item.cliente_paga_comissao }}">
                <input type="hidden" class="cliente-percentual-cte" value="{{ item.cliente_percentual_cte }}">
                <input type="hidden" class="cliente-cte-integral" value="{{ item.cliente_cte_integral }}">
                <input type="hidden" class="item-origem-id" value="{{ item.origem_id }}">
                <input type="hidden" class="item-destino-id" value="{{ item.cliente_destino_id or '' }}">

                <!-- Dados exibidos -->
                <div class="row mb-2">
                  <div class="col-md-2"><label>Cliente</label><input class="form-control form-control-sm" value="{{ item.cliente_razao }}" readonly style="background:#FFD580;"></div>
                  <div class="col-md-2"><label>Produto</label><input class="form-control form-control-sm" value="{{ item.produto_nome }}" readonly style="background:#FFD580;"></div>
                  <div class="col-md-2"><label>Fornecedor</label><input class="form-control form-control-sm" value="{{ item.fornecedor_razao }}" readonly style="background:#FFD580;"></div>
                  <div class="col-md-2"><label>Origem</label><input class="form-control form-control-sm" value="{{ item.origem_nome }}" readonly style="background:#FFD580;"></div>
                  <div class="col-md-2"><label>Destino</label><input class="form-control form-control-sm" value="{{ item.destino_nome or 'N/A' }}" readonly style="background:#FFD580;"></div>
                  <div class="col-md-2"><label>Quantidade (L)</label><input class="form-control form-control-sm" value="{{ '{:,.0f}'.format(item.quantidade).replace(',', '.') if item.quantidade else '0' }}" readonly style="background:#FFD580;"></div>
                </div>

                <div class="row mb-2">
                  <div class="col-md-2"><label>Preço Unit. R$</label><input type="text" class="form-control form-control-sm campo-preco-unitario" value="{{ '{:.2f}'.format(item.preco_unitario).replace('.', ',') if item.preco_unitario else '0,00' }}" readonly style="background:#FFD580;"></div>
                  <div class="col-md-2"><label>Total NF R$</label><input type="text" class="form-control form-control-sm campo-total-nf" name="itens[{{ loop.index0 }}][total_nf]" value="0,00" readonly style="background:#FFD580;"></div>
                  <div class="col-md-2 campo-preco-litro-container"><label><strong>Preço p/ Litro R$ *</strong></label><input type="text" class="form-control form-control-sm campo-preco-litro" name="itens[{{ loop.index0 }}][preco_por_litro]" value="0,00" required></div>
                  <div class="col-md-2"><label>Valor Total Frete R$</label><input type="text" class="form-control form-control-sm campo-valor-frete" name="itens[{{ loop.index0 }}][valor_total_frete]" value="0,00" readonly style="background:#FFD580;"></div>
                  <div class="col-md-2"><label>Status *</label>
                    <select class="form-select form-select-sm" name="itens[{{ loop.index0 }}][status]" required>
                      <option value="Pendente" selected>Pendente</option>
                      <option value="Em Trânsito">Em Trânsito</option>
                      <option value="Concluído">Concluído</option>
                    </select>
                  </div>
                  <div class="col-md-2"><label>&nbsp;</label><div></div></div>
                </div>

                <div class="row">
                  <div class="col-md-3"><label>Comissão Motorista R$</label><input type="text" class="form-control form-control-sm campo-comissao-motorista" name="itens[{{ loop.index0 }}][comissao_motorista]" value="0,00" readonly style="background:#FFD580;"></div>
                  <div class="col-md-3"><label>Valor CTe R$</label><input type="text" class="form-control form-control-sm campo-valor-cte" name="itens[{{ loop.index0 }}][valor_cte]" value="0,00" readonly style="background:#FFD580;"></div>
                  <div class="col-md-3"><label>Comissão CTe R$</label><input type="text" class="form-control form-control-sm campo-comissao-cte" name="itens[{{ loop.index0 }}][comissao_cte]" value="0,00" readonly style="background:#FFD580;"></div>
                  <div class="col-md-3"><label>Lucro R$</label><input type="text" class="form-control form-control-sm campo-lucro" name="itens[{{ loop.index0 }}][lucro]" value="0,00" readonly style="background:#FFD580;"></div>
                </div>

              </div>
            </div>
            {% endfor %}

            <div class="d-flex justify-content-between mt-3">
              <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
              <button type="submit" class="btn btn-success btn-sm">Salvar Todos os Fretes</button>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<style>.item-card { border-left: 4px solid #007bff; }</style>

<script>
// Recebe rotas do backend
const ROTAS = {{ rotas_dict|tojson|safe }};

function obterValorPorLitroRota(origemId, destinoId) {
  try {
    origemId = origemId == null ? '' : String(origemId).trim();
    destinoId = destinoId == null ? '' : String(destinoId).trim();
    if (!origemId || !destinoId) return 0;
    if (typeof ROTAS === 'undefined' || !ROTAS) return 0;
    const tentativas = [
      origemId + '|' + destinoId,
      parseInt(origemId,10) + '|' + parseInt(destinoId,10),
      origemId + '|' + parseInt(destinoId,10),
      parseInt(origemId,10) + '|' + destinoId
    ];
    for (const k of tentativas) {
      if (k && Object.prototype.hasOwnProperty.call(ROTAS, k)) {
        const v = ROTAS[k];
        return parseFloat(v) || 0;
      }
    }
    for (const k in ROTAS) {
      if (!Object.prototype.hasOwnProperty.call(ROTAS,k)) continue;
      const parts = k.split('|');
      if (parts.length === 2 && parts[0].trim() === origemId && parts[1].trim() === destinoId) {
        return parseFloat(ROTAS[k]) || 0;
      }
    }
    return 0;
  } catch (err) {
    console.error('obterValorPorLitroRota error', err);
    return 0;
  }
}

function desformatarMoeda(valor) {
  if (!valor) return 0;
  return parseFloat(valor.toString().replace(/\./g, '').replace(',', '.')) || 0;
}

function formatarMoeda(valor) {
  if (valor === null || valor === undefined) return '0,00';
  let numero = parseFloat(valor).toFixed(2);
  let partes = numero.split('.');
  let inteiro = partes[0];
  let decimal = partes[1];
  inteiro = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  return inteiro + ',' + decimal;
}

// calcularItem do modal (usa nomes itens[index][...])
function calcularItem(itemDiv) {
  try {
    const quantidade = parseFloat(itemDiv.querySelector('input[name$="[quantidade]"]').value) || 0;
    const precoUnitario = desformatarMoeda(itemDiv.querySelector('.campo-preco-unitario').value);

    // --- Ajuste: apenas ler entrada do Preço por Litro (não reescrever o campo aqui) ---
    const precoLitroInput = itemDiv.querySelector('.campo-preco-litro');
    let precoPorLitro = 0;
    if (precoLitroInput) {
      const raw = String(precoLitroInput.value || '').trim();
      // se for apenas dígitos sem separador, interpretar como centavos (ex: "10" -> 0.10)
      const onlyDigits = raw.replace(/\D/g, '');
      const hasSeparator = raw.indexOf(',') >= 0 || raw.indexOf('.') >= 0;
      if (onlyDigits && !hasSeparator) {
        precoPorLitro = parseInt(onlyDigits, 10) / 100.0;
      } else {
        precoPorLitro = desformatarMoeda(raw);
      }
    }
    // --- fim ajuste ---

    const clientePagaComissao = parseInt(itemDiv.querySelector('.cliente-paga-comissao') ? itemDiv.querySelector('.cliente-paga-comissao').value : 1) || 0;
    const clienteCteIntegral = parseInt(itemDiv.querySelector('.cliente-cte-integral') ? itemDiv.querySelector('.cliente-cte-integral').value : 0) || 0;

    // Novas leituras: flags do motorista (globais no modal)
    const motoristaPagaComissao = parseInt(document.getElementById('import_motorista_paga_comissao') ? document.getElementById('import_motorista_paga_comissao').value : 1) || 0;
    const motoristaPercentual = parseFloat(document.getElementById('import_motorista_percentual') ? document.getElementById('import_motorista_percentual').value : 0) || 0;

    const totalNF = quantidade * precoUnitario;
    let valorTotalFrete = 0;
    let comissaoMotorista = 0;
    if (clientePagaComissao) {
      valorTotalFrete = quantidade * precoPorLitro;

      if (motoristaPagaComissao) {
        comissaoMotorista = quantidade * 0.01;
      } else {
        comissaoMotorista = 0;
      }
    } else {
      valorTotalFrete = 0;
      comissaoMotorista = 0;
    }

    let valorCte = 0;
    if (clienteCteIntegral === 1) {
      valorCte = clientePagaComissao ? valorTotalFrete : 0;
    } else {
      const origemId = itemDiv.querySelector('.item-origem-id').value;
      const destinoId = itemDiv.querySelector('.item-destino-id').value;
      const valorPorLitroRota = obterValorPorLitroRota(origemId, destinoId);
      valorCte = quantidade * valorPorLitroRota;
    }

    const comissaoCte = valorCte * 0.08;
    const lucro = clientePagaComissao ? (valorTotalFrete - comissaoMotorista - comissaoCte) : 0;

    if (itemDiv.querySelector('.campo-total-nf')) itemDiv.querySelector('.campo-total-nf').value = formatarMoeda(totalNF);
    if (itemDiv.querySelector('.campo-valor-frete')) itemDiv.querySelector('.campo-valor-frete').value = formatarMoeda(valorTotalFrete);
    if (itemDiv.querySelector('.campo-comissao-motorista')) itemDiv.querySelector('.campo-comissao-motorista').value = formatarMoeda(comissaoMotorista);
    if (itemDiv.querySelector('.campo-valor-cte')) itemDiv.querySelector('.campo-valor-cte').value = formatarMoeda(valorCte);
    if (itemDiv.querySelector('.campo-comissao-cte')) itemDiv.querySelector('.campo-comissao-cte').value = formatarMoeda(comissaoCte);
    if (itemDiv.querySelector('.campo-lucro')) itemDiv.querySelector('.campo-lucro').value = formatarMoeda(lucro);

    const precoLitroContainer = itemDiv.querySelector('.campo-preco-litro-container');
    if (!clientePagaComissao) {
      if (precoLitroInput) precoLitroInput.value = '0,00';
      if (precoLitroInput) precoLitroInput.readOnly = true;
      if (precoLitroContainer) precoLitroContainer.style.display = 'none';
    } else {
      if (precoLitroInput) precoLitroInput.readOnly = false;
      if (precoLitroContainer) precoLitroContainer.style.display = 'block';
    }
  } catch (err) {
    console.error('Erro calcularItem (modal):', err);
  }
}

// Inicialização do modal/handlers (funciona tanto quando o HTML é carregado diretamente quanto quando é injetado via fetch)
(function initImportModal() {
  function doInit() {
    const modalEl = document.getElementById('modalImportarPedido');
    if (modalEl && window.bootstrap && bootstrap.Modal) {
      try { new bootstrap.Modal(modalEl, {backdrop:'static'}).show(); } catch(e){ console.error(e); }
    }

    // ligar events para cada item
    document.querySelectorAll('.item-card').forEach(function(itemDiv) {
      const inputPrecoLitro = itemDiv.querySelector('.campo-preco-litro');
      if (!inputPrecoLitro) return;

      // enquanto digita: apenas recalcula (não formata)
      ['input','change','keyup'].forEach(ev => inputPrecoLitro.addEventListener(ev, function(){
        calcularItem(itemDiv);
      }));

      // ao sair do campo: aplicar regra "somente dígitos -> centavos" e formatar
      inputPrecoLitro.addEventListener('blur', function() {
        try {
          const raw = String(inputPrecoLitro.value || '').trim();
          const onlyDigits = raw.replace(/\D/g, '');
          const hasSeparator = raw.indexOf(',') >= 0 || raw.indexOf('.') >= 0;
          let valueToUse = 0;
          if (onlyDigits && !hasSeparator) {
            valueToUse = parseInt(onlyDigits, 10) / 100.0;
          } else {
            valueToUse = desformatarMoeda(raw);
          }
          // formatar para exibição BR
          inputPrecoLitro.value = formatarMoeda(valueToUse);

          // se houver campo hidden correspondente (itens[i][preco_por_litro_raw]), atualiza-lo
          try {
            const name = inputPrecoLitro.getAttribute('name') || '';
            const rawName = name.replace(/\[preco_por_litro\]/, '[preco_por_litro_raw]');
            if (rawName && rawName !== name) {
              const hidden = document.querySelector('input[name="'+rawName+'"]');
              if (hidden) hidden.value = String(valueToUse).replace(',', '.');
            }
          } catch(e) {
            // silencioso
          }
        } catch (e) {
          console.error('Erro ao formatar preco por litro no blur:', e);
        }
        calcularItem(itemDiv);
      });

      // calcular inicialmente
      calcularItem(itemDiv);
    });
  }

  // expõe a função para ser chamada externamente (importar_modal.js)
  window.initImportModal = doInit;

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', doInit);
  } else {
    // já carregado — inicializa imediatamente (import modal injetado via fetch)
    doInit();
  }
})();
</script>
{% endblock %}
