{% extends "base.html" %}

{% block titulo %}Lista de Fretes{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mt-2 mb-3">
    <ol class="breadcrumb" style="font-size: 0.85rem;">
      <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Início</a></li>
      <li class="breadcrumb-item active" aria-current="page">Fretes</li>
    </ol>
  </nav>

  <!-- Título -->
  <h2 class="mb-3" style="color:#1D63A5">
    <i class="bi bi-truck"></i> Lista de Fretes
  </h2>

  <!-- Card de Filtros -->
  <div class="card mb-4">
    <div class="card-header" style="background:#151515;color:white">
      <h6 class="mb-0"><i class="bi bi-funnel"></i> Filtros</h6>
    </div>
    <div class="card-body">
      <form method="get" action="{{ url_for('fretes.lista') }}" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Data Início</label>
          <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Data Fim</label>
          <input type="date" name="data_fim" class="form-control" value="{{ data_fim or '' }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Cliente</label>
          <select name="cliente_id" class="form-select">
            <option value="">Todos os clientes</option>
            {% for cliente in clientes %}
            <option value="{{ cliente.id }}" {% if cliente_id == cliente.id|string %}selected{% endif %}>
                {{ cliente.razao_social }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 text-end">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-search"></i> Filtrar
          </button>
          <a class="btn btn-secondary" href="{{ url_for('fretes.lista') }}">Limpar</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Botões de Ações -->
  <div class="d-flex justify-content-end mb-3 gap-2">
    <a class="btn btn-warning btn-sm" href="{{ url_for('fretes.novo') }}">
      <i class="bi bi-plus-circle"></i> Novo Frete
    </a>
    <a class="btn btn-success btn-sm" href="{{ url_for('pedidos.novo') }}">
      <i class="bi bi-cart-plus"></i> Novo Pedido
    </a>
    <a class="btn btn-primary btn-sm" href="{{ url_for('pedidos.importar_lista') }}">
      <i class="bi bi-file-earmark-arrow-down"></i> Importar Pedido
    </a>
  </div>

  <!-- Tabela de Fretes -->
  <div class="card">
    <div class="card-header" style="background:#151515;color:white">
      <h5 class="mb-0"><i class="bi bi-table"></i> Lista de Fretes</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0" style="font-size: 0.875rem;">
          <thead style="background:#E8E8E8">
            <tr>
              <th>ID</th>
              <th>Data</th>
              <th>Cliente</th>
              <th>Fornecedor</th>
              <th>Motorista</th>
              <th>Veículo</th>
              <th class="text-end">Valor Total</th>
              <th class="text-end">Lucro</th>
              <th>Status</th>
              <th class="text-center" style="width: 200px;">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for frete in fretes %}
            <tr id="frete-row-{{ frete.id }}">
              <td>{{ frete.id }}</td>
              <td>{{ frete.datafrete_formatada or '-' }}</td>
              <td>{{ frete.cliente or '-' }}</td>
              <td>{{ frete.fornecedor or '-' }}</td>
              <td>{{ frete.motorista or '-' }}</td>
              <td>{{ frete.veiculo or '-' }}</td>
              <td class="text-end">
              {% if frete.valor_total_frete and frete.valor_total_frete > 0 %}
                R$ {{ "%.2f"|format(frete.valor_total_frete)|replace('.', ',') }}
              {% else %}
                -
              {% endif %}
              </td>
              <td class="text-end">
                {% if frete.lucro and frete.lucro != 0 %}
                  R$ {{ "%.2f"|format(frete.lucro)|replace('.', ',') }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if frete.status %}
                <span class="badge bg-{% if frete.status == 'Concluído' %}success{% elif frete.status == 'Pendente' %}warning{% else %}secondary{% endif %}">
                  {{ frete.status }}
                </span>
                {% else %}
                -
                {% endif %}
              </td>
              <td class="text-center">
                <div class="btn-group" role="group" style="align-items:center; gap:8px;">
                  <!-- Botão Editar -->
                  <a href="{{ url_for('fretes.editar', id=frete.id) }}" 
                     class="btn btn-sm btn-outline-primary" 
                     title="Editar">
                    <i class="bi bi-pencil"></i>
                  </a>

                  <!-- Botão Excluir -->
                  <form method="post"
                        action="{{ url_for('fretes.deletar', id=frete.id) }}"
                        style="display:inline;"
                        onsubmit="return confirm('Confirma exclusão do frete #{{ frete.id }}?');">
                    <button type="submit" 
                            class="btn btn-sm btn-outline-danger" 
                            title="Excluir">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>

                  <!-- Emitir Boleto: abrir modal para selecionar data -->
                  {% if frete.valor_total_frete and frete.valor_total_frete > 0 %}
                    {% set emitted = frete.emitted if frete.emitted is defined else 0 %}
                    <button type="button"
                      class="btn btn-sm btn-outline-success btn-emit-boleto"
                      data-frete-id="{{ frete.id }}"
                      data-emitted="{{ '1' if emitted else '0' }}"
                      title="{% if emitted %}Boleto já emitido (cancele no financeiro para reemitir){% else %}Emitir Boleto{% endif %}"
                      {% if emitted %}disabled{% endif %}>
                      <i class="bi bi-receipt"></i>
                    </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="10" class="text-center text-muted py-4">
                <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                <p class="mt-2">Nenhum frete encontrado.</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal global para emissão de boleto -->
<div id="emit-boleto-modal" class="modal" tabindex="-1" role="dialog" aria-hidden="true" style="display:none;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="emit-boleto-form" class="p-0">
        <div class="modal-header">
          <h5 class="modal-title">Emitir Boleto</h5>
          <button type="button" class="btn-close" data-action="close-modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="frete_id" id="modal_frete_id" value="">
          <div class="mb-3">
            <label for="modal_vencimento" class="form-label">Data de vencimento</label>
            <input type="date" id="modal_vencimento" name="vencimento" class="form-control" required>
          </div>
          <div id="emit-boleto-feedback" style="display:none;" class="alert"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-action="close-modal">Cancelar</button>
          <button type="submit" id="modal_emit_btn" class="btn btn-primary">Emitir</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JS inline para abrir modal e enviar emissão (autocontido) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Helpers
  function qs(sel, el=document){ return el.querySelector(sel); }
  function qsa(sel, el=document){ return Array.from(el.querySelectorAll(sel)); }

  const modal = qs('#emit-boleto-modal');
  const form = qs('#emit-boleto-form');
  const inputFrete = qs('#modal_frete_id');
  const inputVenc = qs('#modal_vencimento');
  const feedback = qs('#emit-boleto-feedback');
  const emitBtn = qs('#modal_emit_btn');

  function showModal(){
    modal.style.display = 'block';
    modal.classList.add('show');
    // set focus on date
    setTimeout(()=> inputVenc.focus(), 100);
  }
  function closeModal(){
    modal.style.display = 'none';
    modal.classList.remove('show');
    feedback.style.display = 'none';
  }
  qsa('[data-action="close-modal"]').forEach(btn => btn.addEventListener('click', closeModal));

  // Preencher default date quando abrir
  function defaultVencimento(offsetDays){
    const d = new Date();
    d.setDate(d.getDate() + (offsetDays||7));
    const yyyy = d.getFullYear();
    const mm = ('0' + (d.getMonth()+1)).slice(-2);
    const dd = ('0' + d.getDate()).slice(-2);
    return yyyy + '-' + mm + '-' + dd;
  }

  // Abrir modal ao clicar no botão emitir
  qsa('.btn-emit-boleto').forEach(btn => {
    btn.addEventListener('click', function(e){
      const freteId = btn.getAttribute('data-frete-id');
      const emitted = btn.getAttribute('data-emitted') === '1';
      if (emitted) return; // botão deveria estar disabled, mas segurança extra
      inputFrete.value = freteId;
      inputVenc.value = defaultVencimento(7);
      feedback.style.display = 'none';
      showModal();
    });
  });

  // Envio via fetch para rota /financeiro/emitir-boleto/<frete_id>/ (espera JSON)
  form.addEventListener('submit', async function(ev){
    ev.preventDefault();
    emitBtn.disabled = true;
    feedback.style.display = 'none';
    const freteId = inputFrete.value;
    const vencimento = inputVenc.value;
    if (!freteId || !vencimento){
      feedback.className = 'alert alert-danger';
      feedback.textContent = 'Frete ou vencimento inválido';
      feedback.style.display = 'block';
      emitBtn.disabled = false;
      return;
    }

    try {
      const resp = await fetch(`/financeiro/emitir-boleto/${freteId}/`, {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'X-Requested-With':'XMLHttpRequest'},
        body: JSON.stringify({vencimento: vencimento})
      });
      const j = await resp.json();
      if (resp.ok && j.success){
        feedback.className = 'alert alert-success';
        feedback.textContent = 'Boleto emitido com sucesso.';
        feedback.style.display = 'block';

        // abre o boleto automaticamente quando possível
        if (j.boleto_url) {
          window.open(j.boleto_url, '_blank');
        } else if (j.pdf_boleto) {
          if (typeof j.pdf_boleto === 'string' and (j.pdf_boleto.startsWith('http://') || j.pdf_boleto.startsWith('https://'))) {
            window.open(j.pdf_boleto, '_blank');
          } else {
            window.open('/financeiro/visualizar-boleto/' + j.charge_id + '/', '_blank');
          }
        } else if (j.charge_id) {
          window.open('/financeiro/visualizar-boleto/' + j.charge_id + '/', '_blank');
        }

        // desabilitar botão na tabela
        const btn = document.querySelector(`.btn-emit-boleto[data-frete-id="${freteId}"]`);
        if (btn){
          btn.disabled = true;
          btn.title = 'Boleto já emitido (cancele no financeiro para reemitir)';
        }
        // Atualiza lista (reload suave)
        setTimeout(()=> { closeModal(); location.reload(); }, 700);
      } else {
        feedback.className = 'alert alert-danger';
        feedback.textContent = j.error || 'Falha ao emitir boleto';
        feedback.style.display = 'block';
      }
    } catch (err) {
      feedback.className = 'alert alert-danger';
      feedback.textContent = 'Erro na requisição: ' + err;
      feedback.style.display = 'block';
    } finally {
      emitBtn.disabled = false;
    }
  });

  // Fechar modal ao clicar fora (opcional)
  window.addEventListener('click', function(ev){
    if(ev.target === modal) closeModal();
  });

});
</script>

{% endblock %}
