{% extends "base.html" %}

{% block titulo %}Lista de Fretes{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mt-2 mb-3">
    <ol class="breadcrumb" style="font-size: 0.85rem;">
      <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Início</a></li>
      <li class="breadcrumb-item active" aria-current="page">Fretes</li>
    </ol>
  </nav>

  <!-- Título -->
  <h2 class="mb-3" style="color:#1D63A5">
    <i class="bi bi-truck"></i> Lista de Fretes
  </h2>

  <!-- Card de Filtros -->
  <div class="card mb-4">
    <div class="card-header" style="background:#151515;color:white">
      <h6 class="mb-0"><i class="bi bi-funnel"></i> Filtros</h6>
    </div>
    <div class="card-body">
      <form method="get" action="{{ url_for('fretes.lista') }}" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Data Início</label>
          <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Data Fim</label>
          <input type="date" name="data_fim" class="form-control" value="{{ data_fim or '' }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Cliente</label>
          <select name="cliente_id" class="form-select">
            <option value="">Todos os clientes</option>
            {% for cliente in clientes %}
            <option value="{{ cliente.id }}" {% if cliente_id == cliente.id|string %}selected{% endif %}>
                {{ cliente.razao_social }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 text-end">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-search"></i> Filtrar
          </button>
          <a class="btn btn-secondary" href="{{ url_for('fretes.lista') }}">Limpar</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Botões de Ações -->
  <div class="d-flex justify-content-end mb-3 gap-2">
    <a class="btn btn-warning btn-sm" href="{{ url_for('fretes.novo') }}">
      <i class="bi bi-plus-circle"></i> Novo Frete
    </a>
    <a class="btn btn-success btn-sm" href="{{ url_for('pedidos.novo') }}">
      <i class="bi bi-cart-plus"></i> Novo Pedido
    </a>
    <a class="btn btn-primary btn-sm" href="{{ url_for('pedidos.importar_lista') }}">
      <i class="bi bi-file-earmark-arrow-down"></i> Importar Pedido
    </a>

    <!-- Novos botões: emitir selecionados / quitar selecionados -->
    <button id="emit-selected-btn" class="btn btn-outline-success btn-sm">
      <i class="bi bi-receipt"></i> Emitir Selecionados
    </button>
    <button id="quitar-selected-btn" class="btn btn-outline-success btn-sm">
      <i class="bi bi-cash-stack"></i> Quitar Selecionados
    </button>
  </div>

  <!-- Tabela de Fretes -->
  <div class="card">
    <div class="card-header" style="background:#151515;color:white">
      <h5 class="mb-0"><i class="bi bi-table"></i> Lista de Fretes</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0" style="font-size: 0.875rem;">
          <thead style="background:#E8E8E8">
            <tr>
              <th><input type="checkbox" id="select-all"></th>
              <th>ID</th>
              <th>Data</th>
              <th>Cliente</th>
              <th>Fornecedor</th>
              <th>Motorista</th>
              <th>Veículo</th>
              <th class="text-end">Valor Total</th>
              <th class="text-end">Lucro</th>
              <th>Status</th>
              <th class="text-center" style="width: 200px;">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for frete in fretes %}
            <tr id="frete-row-{{ frete.id }}">
              <td class="align-middle text-center">
                <input type="checkbox" class="frete-select" name="frete_select" value="{{ frete.id }}">
              </td>
              <td>{{ frete.id }}</td>
              <td>{{ frete.datafrete_formatada or '-' }}</td>
              <td>{{ frete.cliente or '-' }}</td>
              <td>{{ frete.fornecedor or '-' }}</td>
              <td>{{ frete.motorista or '-' }}</td>
              <td>{{ frete.veiculo or '-' }}</td>
              <td class="text-end">
              {% if frete.valor_total_frete and frete.valor_total_frete > 0 %}
                R$ {{ "%.2f"|format(frete.valor_total_frete)|replace('.', ',') }}
              {% else %}
                -
              {% endif %}
              </td>
              <td class="text-end">
                {% if frete.lucro and frete.lucro != 0 %}
                  R$ {{ "%.2f"|format(frete.lucro)|replace('.', ',') }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if frete.status %}
                <span class="badge bg-{% if frete.status == 'Concluído' %}success{% elif frete.status == 'Pendente' %}warning{% else %}secondary{% endif %}">
                  {{ frete.status }}
                </span>
                {% else %}
                -
                {% endif %}
              </td>
              <td class="text-center">
                <div class="btn-group" role="group" style="align-items:center; gap:8px;">
                  <!-- Botão Editar -->
                  <a href="{{ url_for('fretes.editar', id=frete.id) }}" 
                     class="btn btn-sm btn-outline-primary" 
                     title="Editar">
                    <i class="bi bi-pencil"></i>
                  </a>

                  <!-- Botão Excluir -->
                  <form method="post"
                        action="{{ url_for('fretes.deletar', id=frete.id) }}"
                        style="display:inline;"
                        onsubmit="return confirm('Confirma exclusão do frete #{{ frete.id }}?');">
                    <button type="submit" 
                            class="btn btn-sm btn-outline-danger" 
                            title="Excluir">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>

                  <!-- Botão Quitar (por frete) -->
                  <button type="button" class="btn btn-sm btn-outline-success btn-quitar"
                          data-frete-id="{{ frete.id }}" title="Quitar frete">
                    <i class="bi bi-cash-stack"></i>
                  </button>

                  <!-- Botão Criar Descarga -->
                  <a href="{{ url_for('descargas.novo', frete_id=frete.id) }}" 
                     class="btn btn-sm btn-outline-info" 
                     title="Criar Descarga">
                    <i class="bi bi-truck"></i>
                  </a>

                  <!-- Emitir Boleto: abrir modal para selecionar data -->
                  {% if frete.valor_total_frete and frete.valor_total_frete > 0 %}
                    {% set emitted = frete.emitted if frete.emitted is defined else 0 %}
                    <button type="button"
                      class="btn btn-sm btn-outline-success btn-emit-boleto"
                      data-frete-id="{{ frete.id }}"
                      data-emitted="{{ '1' if emitted else '0' }}"
                      title="{% if emitted %}Boleto já emitido (cancele no financeiro para reemitir){% else %}Emitir Boleto{% endif %}"
                      {% if emitted %}disabled{% endif %}>
                      <i class="bi bi-receipt"></i>
                    </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="11" class="text-center text-muted py-4">
                <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                <p class="mt-2">Nenhum frete encontrado.</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal global para emissão de boleto -->
<div id="emit-boleto-modal" class="modal" tabindex="-1" role="dialog" aria-hidden="true" style="display:none;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="emit-boleto-form" class="p-0">
        <div class="modal-header">
          <h5 class="modal-title">Emitir Boleto</h5>
          <button type="button" class="btn-close" data-action="close-modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="frete_id" id="modal_frete_id" value="">
          <div class="mb-3">
            <label for="modal_vencimento" class="form-label">Data de vencimento</label>
            <input type="date" id="modal_vencimento" name="vencimento" class="form-control" required>
          </div>
          <div id="emit-boleto-feedback" style="display:none;" class="alert"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-action="close-modal">Cancelar</button>
          <button type="submit" id="modal_emit_btn" class="btn btn-primary">Emitir</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Quitar -->
<div id="quitar-frete-modal" class="modal" tabindex="-1" role="dialog" aria-hidden="true" style="display:none;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form id="quitar-frete-form" class="p-0">
        <div class="modal-header">
          <h5 class="modal-title">Quitar Frete(s)</h5>
          <button type="button" class="btn-close" data-action="close-modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="quitar_selected_ids" value="">
          <div class="mb-3">
            <label for="quitar_data" class="form-label">Data de pagamento</label>
            <input type="date" id="quitar_data" name="data_pagamento" class="form-control" required>
          </div>
          <div id="quitar-feedback" style="display:none;" class="alert"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-action="close-modal">Cancelar</button>
          <button type="submit" id="quitar_submit_btn" class="btn btn-success">Quitar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JS inline para abrir modal e enviar emissão (autocontido) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Helpers
  function qs(sel, el=document){ return el.querySelector(sel); }
  function qsa(sel, el=document){ return Array.from(el.querySelectorAll(sel)); }

  const modal = qs('#emit-boleto-modal');
  const form = qs('#emit-boleto-form');
  const inputFrete = qs('#modal_frete_id');
  const inputVenc = qs('#modal_vencimento');
  const feedback = qs('#emit-boleto-feedback');
  const emitBtn = qs('#modal_emit_btn');

  const quitarModal = qs('#quitar-frete-modal');
  const quitarForm = qs('#quitar-frete-form');
  const quitarIdsInput = qs('#quitar_selected_ids');
  const quitarDate = qs('#quitar_data');
  const quitarFeedback = qs('#quitar-feedback');
  const quitarSubmitBtn = qs('#quitar_submit_btn');

  function showModal(m){
    m.style.display = 'block';
    m.classList.add('show');
  }
  function closeModal(m){
    m.style.display = 'none';
    m.classList.remove('show');
  }
  qsa('[data-action="close-modal"]').forEach(btn => btn.addEventListener('click', function () {
    closeModal(modal); closeModal(quitarModal);
    feedback.style.display = 'none'; quitarFeedback.style.display = 'none';
  }));

  // Selection helpers
  const selectAll = qs('#select-all');
  function getSelectedIds(){
    return qsa('input.frete-select:checked').map(i => parseInt(i.value));
  }
  if (selectAll){
    selectAll.addEventListener('change', function () {
      const checked = !!this.checked;
      qsa('input.frete-select').forEach(ch => ch.checked = checked);
    });
  }

  // Abrir modal ao clicar no botão emitir (single)
  qsa('.btn-emit-boleto').forEach(btn => {
    btn.addEventListener('click', function(e){
      const freteId = btn.getAttribute('data-frete-id');
      const emitted = btn.getAttribute('data-emitted') === '1';
      if (emitted) return;
      inputFrete.value = freteId || '';
      inputVenc.value = defaultVencimento(7);
      feedback.style.display = 'none';
      // mark as single
      modal.dataset.multiple = '';
      showModal(modal);
    });
  });

  // Abrir modal para emitir selecionados
  const emitSelectedBtn = qs('#emit-selected-btn');
  if (emitSelectedBtn){
    emitSelectedBtn.addEventListener('click', function () {
      const ids = getSelectedIds();
      if (!ids || ids.length === 0){
        alert('Selecione ao menos um frete para emitir.');
        return;
      }
      // store selected ids on modal
      modal.dataset.multiple = '1';
      modal.dataset.selectedIds = JSON.stringify(ids);
      inputFrete.value = ''; // clear single id
      inputVenc.value = defaultVencimento(7);
      feedback.style.display = 'none';
      showModal(modal);
    });
  }

  // Preencher default date quando abrir
  function defaultVencimento(offsetDays){
    const d = new Date();
    d.setDate(d.getDate() + (offsetDays||7));
    const yyyy = d.getFullYear();
    const mm = ('0' + (d.getMonth()+1)).slice(-2);
    const dd = ('0' + d.getDate()).slice(-2);
    return yyyy + '-' + mm + '-' + dd;
  }

  // Envio via fetch (single or multiple)
  form.addEventListener('submit', async function(ev){
    ev.preventDefault();
    emitBtn.disabled = true;
    feedback.style.display = 'none';

    const vencimento = inputVenc.value;
    if (!vencimento){
      feedback.className = 'alert alert-danger';
      feedback.textContent = 'Vencimento inválido';
      feedback.style.display = 'block';
      emitBtn.disabled = false;
      return;
    }

    // multiple?
    const isMultiple = modal.dataset.multiple === '1';
    try {
      if (isMultiple){
        const ids = JSON.parse(modal.dataset.selectedIds || '[]');
        const resp = await fetch(`/financeiro/emitir-boleto-multiple/`, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {'Content-Type':'application/json', 'X-Requested-With':'XMLHttpRequest'},
          body: JSON.stringify({frete_ids: ids, vencimento: vencimento})
        });
        const j = await resp.json();
        if (resp.ok && j.success){
          feedback.className = 'alert alert-success';
          feedback.textContent = 'Boleto(s) emitido(s) com sucesso.';
          feedback.style.display = 'block';
          setTimeout(()=> { closeModal(modal); location.reload(); }, 700);
        } else {
          feedback.className = 'alert alert-danger';
          feedback.textContent = j.error || 'Falha ao emitir boletos';
          feedback.style.display = 'block';
        }
      } else {
        const freteId = inputFrete.value;
        if (!freteId){
          feedback.className = 'alert alert-danger';
          feedback.textContent = 'Frete inválido';
          feedback.style.display = 'block';
          emitBtn.disabled = false;
          return;
        }
        const resp = await fetch(`/financeiro/emitir-boleto/${freteId}/`, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {'Content-Type':'application/json', 'X-Requested-With':'XMLHttpRequest'},
          body: JSON.stringify({vencimento: vencimento})
        });
        const j = await resp.json();
        if (resp.ok && j.success){
          feedback.className = 'alert alert-success';
          feedback.textContent = 'Boleto emitido com sucesso.';
          feedback.style.display = 'block';

          if (j.boleto_url) {
            window.open(j.boleto_url, '_blank');
          } else if (j.pdf_boleto) {
            if (typeof j.pdf_boleto === 'string' && (j.pdf_boleto.startsWith('http://') || j.pdf_boleto.startsWith('https://'))) {
              window.open(j.pdf_boleto, '_blank');
            } else {
              window.open('/financeiro/visualizar-boleto/' + j.charge_id + '/', '_blank');
            }
          } else if (j.charge_id) {
            window.open('/financeiro/visualizar-boleto/' + j.charge_id + '/', '_blank');
          }

          const btn = document.querySelector(`.btn-emit-boleto[data-frete-id="${freteId}"]`);
          if (btn){
            btn.disabled = true;
            btn.title = 'Boleto já emitido (cancele no financeiro para reemitir)';
          }
          setTimeout(()=> { closeModal(modal); location.reload(); }, 700);
        } else {
          feedback.className = 'alert alert-danger';
          feedback.textContent = j.error || 'Falha ao emitir boleto';
          feedback.style.display = 'block';
        }
      }
    } catch (err) {
      feedback.className = 'alert alert-danger';
      feedback.textContent = 'Erro na requisição: ' + err;
      feedback.style.display = 'block';
    } finally {
      emitBtn.disabled = false;
    }
  });

  // Quitar: abrir modal para 1 frete (btn-quitar) ou selecionados
  qsa('.btn-quitar').forEach(btn => {
    btn.addEventListener('click', function () {
      const fid = btn.getAttribute('data-frete-id');
      quitarIdsInput.value = JSON.stringify([parseInt(fid)]);
      quitarDate.value = new Date().toISOString().slice(0,10);
      quitarFeedback.style.display = 'none';
      showModal(quitarModal);
    });
  });

  const quitarSelectedBtn = qs('#quitar-selected-btn');
  if (quitarSelectedBtn){
    quitarSelectedBtn.addEventListener('click', function () {
      const ids = getSelectedIds();
      if (!ids || ids.length === 0){
        alert('Selecione ao menos um frete para quitar.');
        return;
      }
      quitarIdsInput.value = JSON.stringify(ids);
      quitarDate.value = new Date().toISOString().slice(0,10);
      quitarFeedback.style.display = 'none';
      showModal(quitarModal);
    });
  }

  // submit quitar form
  quitarForm.addEventListener('submit', async function (ev) {
    ev.preventDefault();
    quitarSubmitBtn.disabled = true;
    quitarFeedback.style.display = 'none';
    const dateVal = quitarDate.value;
    if (!dateVal){
      quitarFeedback.className = 'alert alert-danger';
      quitarFeedback.textContent = 'Informe a data de pagamento';
      quitarFeedback.style.display = 'block';
      quitarSubmitBtn.disabled = false;
      return;
    }
    let ids = [];
    try {
      ids = JSON.parse(quitarIdsInput.value || '[]');
    } catch (e){
      ids = [];
    }
    if (!ids || ids.length === 0){
      quitarFeedback.className = 'alert alert-danger';
      quitarFeedback.textContent = 'IDs inválidos';
      quitarFeedback.style.display = 'block';
      quitarSubmitBtn.disabled = false;
      return;
    }

    try {
      const resp = await fetch('/financeiro/quitar-frete/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {'Content-Type':'application/json', 'X-Requested-With':'XMLHttpRequest'},
        body: JSON.stringify({frete_ids: ids, data_pagamento: dateVal})
      });
      const j = await resp.json();
      if (resp.ok && j.success){
        quitarFeedback.className = 'alert alert-success';
        quitarFeedback.textContent = 'Quitação registrada.';
        quitarFeedback.style.display = 'block';
        setTimeout(()=> { closeModal(quitarModal); location.reload(); }, 700);
      } else {
        quitarFeedback.className = 'alert alert-danger';
        quitarFeedback.textContent = j.error || 'Falha ao registrar quitação';
        quitarFeedback.style.display = 'block';
      }
    } catch (err){
      quitarFeedback.className = 'alert alert-danger';
      quitarFeedback.textContent = 'Erro na requisição: ' + err;
      quitarFeedback.style.display = 'block';
    } finally {
      quitarSubmitBtn.disabled = false;
    }
  });

  // Fechar modal ao clicar fora (opcional)
  window.addEventListener('click', function(ev){
    if(ev.target === modal) closeModal(modal);
    if(ev.target === quitarModal) closeModal(quitarModal);
  });

});
</script>

{% endblock %}
