// Utilitários e bindings usados pelo formulário de frete.
// Deve ser carregado antes de fretes_calculos.js

// Converte string formatada para número (aceita formatos BR: "R$ 1.234,56" ou "1.234,56" ou "1234.56")
function desformatarMoeda(input) {
  if (input === null || input === undefined) return 0;
  var s = String(input).trim();
  if (s === '') return 0;
  // remover prefixo R$
  s = s.replace(/[Rr]\$\s?/, '').trim();
  // tratar milhares e decimais
  if (s.indexOf('.') >= 0 && s.indexOf(',') >= 0) {
    s = s.replace(/\./g, '').replace(',', '.');
  } else if (s.indexOf(',') >= 0) {
    s = s.replace(',', '.');
  }
  s = s.replace(/[^0-9\.-]/g, '');
  var n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}

// Formata número para string BR (sem prefixo "R$") — ex: 1234.5 -> "1.234,50"
function formatarMoedaBR(valor, casas) {
  casas = (typeof casas === 'number') ? casas : 2;
  if (valor === null || valor === undefined) valor = 0;
  var n = Number(valor) || 0;
  var neg = n < 0;
  n = Math.abs(n);
  var inteiro = parseInt(n.toFixed(casas), 10) + '';
  var dec = (n.toFixed(casas) + '').split('.')[1] || '';
  inteiro = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  var s = inteiro + (casas ? ',' + (dec) : '');
  return (neg ? '-' : '') + s;
}

// Aplica formatação ao elemento input passado (R$ X.xxx,xx)
// Se usuário digitar apenas dígitos sem separador, interpretamos como inteiro escalado por 'casas'
// Ex: casas=3, digito "3650" -> 3650 / 1000 = 3.650
function aplicarFormatacaoMonetaria(el, casas) {
  if (!el) return;
  try {
    var rawStr = String(el.value || '').trim();
    var valorNum;
    if (/^\d+$/.test(rawStr)) {
      // somente dígitos -> interpretar como inteiro escalado por casas
      valorNum = parseInt(rawStr, 10) / Math.pow(10, casas);
    } else {
      // entrada com separadores/virgula/dot -> parse normal
      valorNum = desformatarMoeda(rawStr);
    }
    el.value = 'R$ ' + formatarMoedaBR(valorNum, casas);
  } catch (e) {
    console.error('aplicarFormatacaoMonetaria error', e);
  }
}

// Inicializador que anexa listeners de blur/input nos campos de preço e comissões
function initFretesFixes() {
  var elPrecoProduto = document.getElementById('preco_produto_unitario');
  var elPrecoPorLitro = document.getElementById('preco_por_litro');
  var elComissaoMotorista = document.getElementById('comissao_motorista');

  if (elPrecoProduto) {
    aplicarFormatacaoMonetaria(elPrecoProduto, 3);
    elPrecoProduto.addEventListener('blur', function(){
      aplicarFormatacaoMonetaria(this, 3);
      try{ if (typeof calcularTudo==='function') calcularTudo(); }catch(e){}
    });
  }

  if (elPrecoPorLitro) {
    aplicarFormatacaoMonetaria(elPrecoPorLitro, 2);
    elPrecoPorLitro.addEventListener('blur', function(){
      aplicarFormatacaoMonetaria(this, 2);
      try{ if (typeof calcularTudo==='function') calcularTudo(); }catch(e){}
    });
  }

  if (elComissaoMotorista) {
    aplicarFormatacaoMonetaria(elComissaoMotorista, 2);
    elComissaoMotorista.addEventListener('blur', function(){
      aplicarFormatacaoMonetaria(this, 2);
      try{ if (typeof calcularTudo==='function') calcularTudo(); }catch(e){}
    });
  }

  // quantidade manual/listbox toggle
  var qTipo = document.getElementById('quantidade_tipo');
  var divPadrao = document.getElementById('div_quantidade_padrao');
  var divManual = document.getElementById('div_quantidade_personalizada');
  if (qTipo && divPadrao && divManual) {
    function aplicarTipo() {
      if (qTipo.value === 'personalizada') {
        divPadrao.style.display = 'none';
        divManual.style.display = '';
      } else {
        divPadrao.style.display = '';
        divManual.style.display = 'none';
      }
      try{ if (typeof calcularTudo==='function') calcularTudo(); }catch(e){}
    }
    qTipo.addEventListener('change', aplicarTipo);
    aplicarTipo();
  }

  var selQuantidade = document.getElementById('quantidade_id');
  var qtdManual = document.getElementById('quantidade_manual');
  if (selQuantidade) selQuantidade.addEventListener('change', function(){ try{ if (typeof calcularTudo==='function') calcularTudo(); }catch(e){} });
  if (qtdManual) qtdManual.addEventListener('blur', function(){ try{ if (typeof calcularTudo==='function') calcularTudo(); }catch(e){} });

  var origemEl = document.getElementById('origem_id');
  var destinoEl = document.getElementById('destino_id');
  if (origemEl) origemEl.addEventListener('change', function(){ try{ if (typeof calcularTudo==='function') calcularTudo(); }catch(e){} });
  if (destinoEl) destinoEl.addEventListener('change', function(){ try{ if (typeof calcularTudo==='function') calcularTudo(); }catch(e){} });
}

// garantir que funções existam no escopo global para que fretes_calculos.js as consuma
window.desformatarMoeda = desformatarMoeda;
window.formatarMoedaBR = formatarMoedaBR;
window.initFretesFixes = initFretesFixes;
