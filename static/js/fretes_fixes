// Utilitários e bindings usados pelo formulário de frete.
// Deve ser carregado antes de fretes_calculos.js

// Converte string formatada para número (aceita formatos BR: "R$ 1.234,56" ou "1.234,56" ou "1234.56")
function desformatarMoeda(input) {
  if (input === null || input === undefined) return 0;
  var s = String(input).trim();
  if (s === '') return 0;
  // remover prefixo R$
  s = s.replace(/[Rr]\$\s?/, '').trim();
  // tratar milhares e decimais
  // se tem '.' e ',' assume formato BR (1.234,56)
  if (s.indexOf('.') >= 0 && s.indexOf(',') >= 0) {
    s = s.replace(/\./g, '').replace(',', '.');
  } else if (s.indexOf(',') >= 0) {
    s = s.replace(',', '.');
  }
  // remover qualquer caractere que não seja dígito, ponto ou sinal
  s = s.replace(/[^0-9\.-]/g, '');
  var n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}

// Formata número para string BR (sem prefixo "R$") — ex: 1234.5 -> "1.234,50"
function formatarMoedaBR(valor, casas) {
  casas = (typeof casas === 'number') ? casas : 2;
  if (valor === null || valor === undefined) valor = 0;
  var n = Number(valor) || 0;
  var neg = n < 0;
  n = Math.abs(n);
  var inteiro = parseInt(n.toFixed(casas), 10) + '';
  var dec = (n.toFixed(casas) + '').split('.')[1] || '';
  inteiro = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  var s = inteiro + (casas ? ',' + (dec) : '');
  return (neg ? '-' : '') + s;
}

// Aplica formatação ao elemento input passado (R$ X,XXX,XX)
function aplicarFormatacaoMonetaria(el, casas) {
  if (!el) return;
  try {
    var raw = desformatarMoeda(el.value);
    el.value = 'R$ ' + formatarMoedaBR(raw, casas);
  } catch (e) {
    console.error('aplicarFormatacaoMonetaria error', e);
  }
}

// Inicializador que anexa listeners de blur/input nos campos de preço e comissões
function initFretesFixes() {
  // campos monetários principais
  var elPrecoProduto = document.getElementById('preco_produto_unitario');
  var elPrecoPorLitro = document.getElementById('preco_por_litro');
  var elComissaoMotorista = document.getElementById('comissao_motorista');

  if (elPrecoProduto) {
    // formatar ao carregar (se já tiver valor) e ao blur
    aplicarFormatacaoMonetaria(elPrecoProduto, 3);
    elPrecoProduto.addEventListener('blur', function(){ aplicarFormatacaoMonetaria(this, 3); try{ if (typeof calcularTudo==='function') calcularTudo(); }catch(e){} });
    elPrecoProduto.addEventListener('input', function(){ /* não recalcula a cada tecla para performance */ });
  }

  if (elPrecoPorLitro) {
    aplicarFormatacaoMonetaria(elPrecoPorLitro, 2);
    elPrecoPorLitro.addEventListener('blur', function(){ aplicarFormatacaoMonetaria(this, 2); try{ if (typeof calcularTudo==='function') calcularTudo(); }catch(e){} });
    elPrecoPorLitro.addEventListener('input', function(){});
  }

  if (elComissaoMotorista) {
    // comissionista pode ser manual — mas sempre formatar
    aplicarFormatacaoMonetaria(elComissaoMotorista, 2);
    elComissaoMotorista.addEventListener('blur', function(){ aplicarFormatacaoMonetaria(this, 2); try{ if (typeof calcularTudo==='function') calcularTudo(); }catch(e){} });
  }

  // quantidade manual/listbox toggle
  var qTipo = document.getElementById('quantidade_tipo');
  var divPadrao = document.getElementById('div_quantidade_padrao');
  var divManual = document.getElementById('div_quantidade_personalizada');
  if (qTipo && divPadrao && divManual) {
    function aplicarTipo() {
      if (qTipo.value === 'personalizada') {
        divPadrao.style.display = 'none';
        divManual.style.display = '';
      } else {
        divPadrao.style.display = '';
        divManual.style.display = 'none';
      }
      try{ if (typeof calcularTudo==='function') calcularTudo(); }catch(e){}
    }
    qTipo.addEventListener('change', aplicarTipo);
    aplicarTipo();
  }

  // quando seleção de quantidade ou manual mudar, recalcular
  var selQuantidade = document.getElementById('quantidade_id');
  var qtdManual = document.getElementById('quantidade_manual');
  if (selQuantidade) selQuantidade.addEventListener('change', function(){ try{ if (typeof calcularTudo==='function') calcularTudo(); }catch(e){} });
  if (qtdManual) qtdManual.addEventListener('blur', function(){ try{ if (typeof calcularTudo==='function') calcularTudo(); }catch(e){} });

  // origem/destino changes impactam CTe
  var origemEl = document.getElementById('origem_id');
  var destinoEl = document.getElementById('destino_id');
  if (origemEl) origemEl.addEventListener('change', function(){ try{ if (typeof calcularTudo==='function') calcularTudo(); }catch(e){} });
  if (destinoEl) destinoEl.addEventListener('change', function(){ try{ if (typeof calcularTudo==='function') calcularTudo(); }catch(e){} });

  // cliente change (aplicação de regras já no template chama aplicarRegraCliente, mas aqui garantimos que exista)
  var clienteSel = document.getElementById('clientes_id');
  if (clienteSel) {
    // nada adicional: template aplica regras ao carregar/alterar
  }
}

// garantir que funções existam no escopo global para que fretes_calculos.js as consuma
window.desformatarMoeda = desformatarMoeda;
window.formatarMoedaBR = formatarMoedaBR;
window.initFretesFixes = initFretesFixes;
